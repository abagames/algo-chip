{"version":3,"file":"algo-chip.umd.js","sources":["../src/phase/structure-planning.ts","../src/musicUtils.ts","../src/constants/velocity-config.ts","../src/phase/motif-selection.ts","../src/phase/event-realization.ts","../src/phase/techniques-postprocess.ts","../src/phase/timeline-finalization.ts","../src/style/two-axis-mapper.ts","../src/style/preset-to-axis.ts","../src/style/profile-resolver.ts","../src/pipeline.ts","../src/se/seTemplates.ts","../src/se/seGenerator.ts","../src/playback/synthesizer.ts"],"sourcesContent":["import {\n  PipelineCompositionOptions,\n  StructurePlanResult,\n  SectionDefinition,\n  TechniqueStrategy,\n  StyleIntent,\n  StylePreset,\n  TexturePlan,\n  TextureProfile,\n  VoiceArrangement,\n  VoiceArrangementPreset\n} from \"../types.js\";\nimport chordsJson from \"../../motifs/chords.json\" with { type: \"json\" };\n\nconst chords = chordsJson as Record<string, Record<string, string[][]>>;\n// Note: texture-profiles.json removed per REFACTOR_PLAN.md Step 1-E\n// Texture sequences now defined inline (see TEMPLATE_TEXTURE_SEQUENCE below)\n\n/**\n * Base BPM values for tempo settings.\n * These are deliberately chosen to cover the typical range of game music:\n * - slow (90): Ballads, atmospheric tracks (e.g., sad scenes, character themes)\n * - medium (120): Most action and adventure music (4-on-the-floor electronic dance music standard)\n * - fast (150): High-energy battle themes and chase sequences\n * Each base value is jittered ±15 BPM per seed for variety without straying too far from the intended feel.\n */\nconst TEMPO_BASE: Record<PipelineCompositionOptions[\"tempo\"], number> = {\n  slow: 90,\n  medium: 120,\n  fast: 150\n};\n\n/**\n * Maps moods to motif tags for filtering chord progressions and melodies.\n * Tags are ordered by priority (first = preferred). This allows Phase 2 to select\n * motifs that match the emotional intent. For example, \"upbeat\" music prefers\n * \"overworld_bright\" progressions but can fall back to \"heroic\" if needed.\n * Tags come from the motif JSON library and were manually curated for each mood.\n */\nconst MOOD_TAG_MAP: Record<PipelineCompositionOptions[\"mood\"], string[]> = {\n  upbeat: [\"overworld_bright\", \"heroic\"],\n  sad: [\"ending_sorrowful\", \"dark\"],\n  tense: [\"final_battle_tense\", \"castle_majestic\"],\n  peaceful: [\"town_peaceful\", \"simple\"]\n};\n\n/**\n * Default musical keys for each mood.\n * These key choices are based on common music theory associations and retro game music conventions:\n * - upbeat → G Major: Bright, cheerful (common in overworld themes)\n * - sad/tense → E Minor: Darker, more emotional (used in dramatic scenes)\n * - peaceful → C Major: Neutral, calm (simplest key, no accidentals)\n * These defaults can be overridden by seed-based selection if the preferred key lacks motifs.\n */\nconst DEFAULT_KEY_PER_MOOD: Record<PipelineCompositionOptions[\"mood\"], string> = {\n  upbeat: \"G_Major\",\n  sad: \"E_Minor\",\n  tense: \"E_Minor\",\n  peaceful: \"C_Major\"\n};\n\nconst AVAILABLE_CHORD_KEYS = Object.keys(chords);\n\nconst SCALE_DEGREES: Record<string, number[]> = {\n  G_Major: [0, 2, 4, 5, 7, 9, 11],\n  E_Minor: [0, 2, 3, 5, 7, 8, 10],\n  C_Major: [0, 2, 4, 5, 7, 9, 11]\n};\n\nconst SECTION_TEMPLATE_POOL: Array<Array<{ id: string; measures: number }>> = [\n  [\n    { id: \"Intro\", measures: 1 },\n    { id: \"A\", measures: 3 },\n    { id: \"B\", measures: 2 },\n    { id: \"A\", measures: 2 }\n  ],\n  [\n    { id: \"A\", measures: 2 },\n    { id: \"B\", measures: 2 },\n    { id: \"A\", measures: 2 },\n    { id: \"C\", measures: 2 }\n  ],\n  [\n    { id: \"Intro\", measures: 2 },\n    { id: \"A\", measures: 2 },\n    { id: \"Bridge\", measures: 2 },\n    { id: \"A\", measures: 2 }\n  ],\n  [\n    { id: \"A\", measures: 4 },\n    { id: \"B\", measures: 2 },\n    { id: \"C\", measures: 2 }\n  ]\n];\n\nconst TEMPLATE_INDEX_BY_MOOD: Partial<Record<PipelineCompositionOptions[\"mood\"], number[]>> = {\n  tense: [0, 3],\n  upbeat: [1, 2],\n  sad: [2, 3],\n  peaceful: [1, 2]\n};\n\n/**\n * Length-optimized section templates for specific measure counts (16, 32, 64).\n * These templates provide better structure for common composition lengths.\n */\nconst SECTION_TEMPLATES_BY_LENGTH: Record<\n  number,\n  Record<PipelineCompositionOptions[\"mood\"], Array<{ id: string; measures: number }>>\n> = {\n  // 16 measures: Simple AB structure\n  16: {\n    upbeat: [\n      { id: \"A\", measures: 8 },   // Intro/Verse\n      { id: \"B\", measures: 8 }    // Chorus/Outro\n    ],\n    peaceful: [\n      { id: \"A\", measures: 8 },\n      { id: \"B\", measures: 8 }\n    ],\n    tense: [\n      { id: \"A\", measures: 8 },\n      { id: \"B\", measures: 8 }\n    ],\n    sad: [\n      { id: \"A\", measures: 8 },\n      { id: \"B\", measures: 8 }\n    ]\n  },\n  // 32 measures: Balanced ABCD or AA-BB structure\n  32: {\n    upbeat: [\n      { id: \"A\", measures: 8 },   // Intro/Verse A\n      { id: \"B\", measures: 8 },   // Chorus A\n      { id: \"C\", measures: 8 },   // Verse B/Bridge\n      { id: \"D\", measures: 8 }    // Chorus B/Outro\n    ],\n    peaceful: [\n      { id: \"A\", measures: 16 },  // Long section A\n      { id: \"B\", measures: 16 }   // Long section B\n    ],\n    tense: [\n      { id: \"A\", measures: 8 },\n      { id: \"B\", measures: 8 },\n      { id: \"A\", measures: 8 },\n      { id: \"C\", measures: 8 }\n    ],\n    sad: [\n      { id: \"Intro\", measures: 4 },\n      { id: \"A\", measures: 12 },\n      { id: \"B\", measures: 8 },\n      { id: \"A\", measures: 8 }\n    ]\n  },\n  // 64 measures: Complex development with longer sections\n  64: {\n    upbeat: [\n      { id: \"A\", measures: 16 },  // Intro/Verse A\n      { id: \"B\", measures: 16 },  // Chorus A\n      { id: \"C\", measures: 16 },  // Verse B/Bridge\n      { id: \"D\", measures: 16 }   // Chorus B/Outro\n    ],\n    peaceful: [\n      { id: \"A\", measures: 16 },\n      { id: \"B\", measures: 16 },\n      { id: \"A\", measures: 16 },\n      { id: \"C\", measures: 16 }\n    ],\n    tense: [\n      { id: \"Intro\", measures: 8 },\n      { id: \"A\", measures: 16 },\n      { id: \"B\", measures: 16 },\n      { id: \"C\", measures: 12 },\n      { id: \"A\", measures: 12 }\n    ],\n    sad: [\n      { id: \"Intro\", measures: 8 },\n      { id: \"A\", measures: 20 },\n      { id: \"B\", measures: 16 },\n      { id: \"A\", measures: 20 }\n    ]\n  }\n};\n\nconst HOOK_TEMPLATES = new Set([\"A\"]);\n\nconst DEFAULT_TEXTURE: TextureProfile = \"steady\";\nconst DEFAULT_PHRASE_LENGTH = 1;\n\nconst STYLE_INTENT_BASE: StyleIntent = {\n  textureFocus: false,\n  loopCentric: false,\n  gradualBuild: false,\n  harmonicStatic: false,\n  percussiveLayering: false,\n  breakInsertion: false,\n  filterMotion: false,\n  syncopationBias: false,\n  atmosPad: false\n};\n\nconst STYLE_PRESET_MAP: Record<StylePreset, Partial<StyleIntent>> = {\n  minimalTechno: {\n    textureFocus: true,\n    loopCentric: true,\n    harmonicStatic: true,\n    percussiveLayering: true,\n    filterMotion: true,\n    syncopationBias: true\n  },\n  progressiveHouse: {\n    textureFocus: true,\n    loopCentric: true,\n    gradualBuild: true,\n    percussiveLayering: true,\n    breakInsertion: true,\n    filterMotion: true,\n    atmosPad: true\n  },\n  retroLoopwave: {\n    textureFocus: true,\n    loopCentric: true,\n    percussiveLayering: true,\n    filterMotion: true,\n    syncopationBias: true\n  },\n  breakbeatJungle: {\n    textureFocus: true,\n    percussiveLayering: true,\n    breakInsertion: true,\n    filterMotion: true,\n    syncopationBias: true\n  },\n  lofiChillhop: {\n    loopCentric: true,\n    harmonicStatic: true,\n    atmosPad: true,\n    textureFocus: true\n  }\n};\n\ninterface Phase1Context {\n  sections: SectionDefinition[];\n  techniqueStrategy: TechniqueStrategy;\n}\n\nfunction createStyleIntent(): StyleIntent {\n  return { ...STYLE_INTENT_BASE };\n}\n\nfunction mergeStyleIntent(base: StyleIntent, patch: Partial<StyleIntent> | undefined): StyleIntent {\n  if (!patch) {\n    return base;\n  }\n  const merged: StyleIntent = { ...base };\n  for (const key of Object.keys(base) as Array<keyof StyleIntent>) {\n    if (patch[key] !== undefined) {\n      merged[key] = Boolean(patch[key]);\n    }\n  }\n  return merged;\n}\n\n/**\n * Pre-compute styleIntent from options only (before sections are built).\n * This allows preset-driven flags like harmonicStatic to influence section building.\n */\nfunction precomputeStyleIntent(options: PipelineCompositionOptions): Partial<StyleIntent> {\n  let intent: Partial<StyleIntent> = {};\n\n  // Apply preset first\n  if (options.stylePreset) {\n    const presetPatch = STYLE_PRESET_MAP[options.stylePreset];\n    if (presetPatch) {\n      intent = { ...intent, ...presetPatch };\n    }\n  }\n\n  // Apply user overrides\n  if (options.styleOverrides) {\n    intent = { ...intent, ...options.styleOverrides };\n  }\n\n  return intent;\n}\n\nfunction resolveStyleIntent(options: PipelineCompositionOptions, sections: SectionDefinition[]): StyleIntent {\n  let intent = createStyleIntent();\n  if (options.stylePreset) {\n    const presetPatch = STYLE_PRESET_MAP[options.stylePreset];\n    if (presetPatch) {\n      intent = mergeStyleIntent(intent, presetPatch);\n    }\n  }\n\n  const totalMeasures = sections.reduce((sum, section) => sum + section.measures, 0);\n  const sectionTemplateCounts = sections.reduce<Map<string, number>>((acc, section) => {\n    acc.set(section.templateId, (acc.get(section.templateId) ?? 0) + 1);\n    return acc;\n  }, new Map());\n  const hasRepeatedTemplate = Array.from(sectionTemplateCounts.values()).some((count) => count >= 2);\n  const averageSectionLength = sections.length ? totalMeasures / sections.length : totalMeasures;\n\n  if (hasRepeatedTemplate || averageSectionLength <= 4) {\n    intent.loopCentric = true;\n  }\n\n  if (options.tempo !== \"slow\" && totalMeasures >= 8) {\n    intent.loopCentric = true;\n    intent.percussiveLayering = true;\n  }\n\n  if (options.mood === \"tense\" || options.mood === \"sad\") {\n    intent.textureFocus = true;\n  }\n\n  if (options.mood === \"peaceful\") {\n    intent.atmosPad = true;\n  }\n\n  if (options.mood === \"upbeat\" || options.mood === \"tense\") {\n    intent.syncopationBias = true;\n  }\n\n  if (options.tempo === \"fast\") {\n    intent.filterMotion = true;\n    intent.percussiveLayering = true;\n  }\n\n  if (totalMeasures >= 12) {\n    intent.gradualBuild = true;\n  }\n\n  const uniqueChords = new Set<string>();\n  const distinctProgressions = new Set<string>();\n  let sectionsWithSingleChord = 0;\n  for (const section of sections) {\n    section.chordProgression.forEach((chord) => uniqueChords.add(chord));\n    distinctProgressions.add(section.chordProgression.join(\"|\"));\n    const chordsInSection = new Set(section.chordProgression);\n    if (chordsInSection.size <= 1) {\n      sectionsWithSingleChord++;\n    }\n  }\n\n  const allSectionsStatic = sections.length > 0 && sectionsWithSingleChord === sections.length;\n  if (distinctProgressions.size <= 1 && (uniqueChords.size <= 2 || allSectionsStatic)) {\n    intent.harmonicStatic = true;\n  }\n\n  if (totalMeasures >= 8 && options.tempo !== \"slow\") {\n    intent.breakInsertion = true;\n  }\n\n  const inferredHarmonicStatic = intent.harmonicStatic;\n  intent = mergeStyleIntent(intent, options.styleOverrides);\n\n  // Only override harmonicStatic if it wasn't explicitly provided in styleOverrides\n  const wasExplicitlyProvided = options.styleOverrides && typeof options.styleOverrides.harmonicStatic === \"boolean\";\n  if (!inferredHarmonicStatic && !wasExplicitlyProvided) {\n    intent.harmonicStatic = false;\n  }\n\n  return intent;\n}\n\nfunction randomFromSeed(seed: number | undefined, salt: number): number {\n  const base = (Math.imul(seed ?? 0, 1664525) + Math.imul(salt, 1013904223)) >>> 0;\n  const value = (Math.imul(base, 22695477) + 1) >>> 0;\n  return value / 0xffffffff;\n}\n\nfunction selectChordProgressions(\n  key: string,\n  moodTags: string[],\n  seed: number | undefined\n): string[][] {\n  const keyData = (chords as any)[key];\n  if (!keyData) {\n    throw new Error(`No chord motifs for key ${key}`);\n  }\n  const matches: string[][] = [];\n  for (const tag of moodTags) {\n    if (Array.isArray(keyData[tag])) {\n      matches.push(...keyData[tag]);\n    }\n  }\n  const fallbackSources = matches.length ? matches : Object.values<string[][]>(keyData).flat();\n  if (!fallbackSources.length) {\n    throw new Error(`No chord progressions available for key ${key}`);\n  }\n  return shuffleArray(fallbackSources, seed, 100).map((progression) => [...progression]);\n}\n\n/**\n * Transpose a chord by a given number of semitones.\n * @param chord - Original chord (e.g., \"C\", \"Am\", \"F#7\")\n * @param semitones - Number of semitones to transpose (positive = up, negative = down)\n * @returns Transposed chord string\n */\nfunction transposeChord(chord: string, semitones: number): string {\n  const rootMatch = chord.match(/^([A-G])(#|b)?(.*)$/);\n  if (!rootMatch) return chord;\n\n  const [, rootNote, accidental = \"\", suffix] = rootMatch;\n  \n  const NOTE_ORDER = [\"C\", \"C#\", \"D\", \"D#\", \"E\", \"F\", \"F#\", \"G\", \"G#\", \"A\", \"A#\", \"B\"];\n  const NOTE_TO_INDEX: Record<string, number> = {\n    C: 0, \"C#\": 1, Db: 1, D: 2, \"D#\": 3, Eb: 3, E: 4,\n    F: 5, \"F#\": 6, Gb: 6, G: 7, \"G#\": 8, Ab: 8, A: 9, \"A#\": 10, Bb: 10, B: 11\n  };\n\n  const currentNote = rootNote + accidental;\n  const currentIndex = NOTE_TO_INDEX[currentNote];\n  if (currentIndex === undefined) return chord;\n\n  const newIndex = (currentIndex + semitones + 12) % 12;\n  const newRoot = NOTE_ORDER[newIndex];\n  \n  return newRoot + suffix;\n}\n\n/**\n * Toggle chord between major and minor (parallel key).\n * @param chord - Original chord (e.g., \"C\", \"Am\")\n * @returns Chord with toggled quality\n */\nfunction toggleMinorMajor(chord: string): string {\n  const match = chord.match(/^([A-G](?:#|b)?)(m?)(.*)$/);\n  if (!match) return chord;\n\n  const [, root, minor, rest] = match;\n  \n  // If minor, remove 'm'; if major, add 'm'\n  if (minor === \"m\") {\n    return root + rest;\n  } else {\n    return root + \"m\" + rest;\n  }\n}\n\n/**\n * Get related chords for limited harmonic progression.\n * Returns chords that are musically close to the base chord.\n * @param baseChord - The root chord\n * @returns Array of 2-3 related chord options\n */\nfunction getRelatedChords(baseChord: string): string[] {\n  const related: string[] = [];\n  \n  // Fifth up (dominant)\n  related.push(transposeChord(baseChord, 7));\n  \n  // Fourth up / Fifth down (subdominant)\n  related.push(transposeChord(baseChord, 5));\n  \n  // Parallel key (major ↔ minor)\n  related.push(toggleMinorMajor(baseChord));\n  \n  return related;\n}\n\n/**\n * Build a limited chord progression for harmonicStatic styles.\n * Repeats the base chord 3-4 times, with occasional movement to related chords.\n * @param baseChord - The primary chord\n * @param rng - Random number generator\n * @returns Chord progression array\n */\nfunction buildLimitedProgression(\n  baseChord: string,\n  rng: () => number\n): string[] {\n  const repetitions = 3 + Math.floor(rng() * 2); // 3-4 repetitions\n  const progression: string[] = Array(repetitions).fill(baseChord);\n  \n  // 20% probability to add a related chord at the end\n  if (rng() < 0.2) {\n    const relatedChords = getRelatedChords(baseChord);\n    const chosenRelated = relatedChords[Math.floor(rng() * relatedChords.length)];\n    progression.push(chosenRelated);\n  }\n  \n  return progression;\n}\n\nfunction buildSections(\n  options: PipelineCompositionOptions,\n  chordsPool: string[][],\n  seed: number | undefined,\n  precomputedIntent: Partial<StyleIntent>\n): SectionDefinition[] {\n  const targetMeasures = options.lengthInMeasures;\n\n  // Use length-optimized template if available for this specific length\n  let baseTemplate: Array<{ id: string; measures: number }>;\n\n  if (targetMeasures in SECTION_TEMPLATES_BY_LENGTH) {\n    // Use optimized template for 16, 32, or 64 measures\n    baseTemplate = SECTION_TEMPLATES_BY_LENGTH[targetMeasures][options.mood].map(s => ({ ...s }));\n  } else {\n    // Fall back to existing logic for custom lengths\n    baseTemplate = pickTemplateForMood(options.mood, seed);\n  }\n\n  const totalTemplateMeasures = baseTemplate.reduce((sum, section) => sum + section.measures, 0);\n  let repeatedTemplate: { id: string; measures: number }[] = [];\n\n  if (targetMeasures === totalTemplateMeasures) {\n    repeatedTemplate = baseTemplate;\n  } else if (targetMeasures > totalTemplateMeasures) {\n    const loops = Math.floor(targetMeasures / totalTemplateMeasures);\n    for (let i = 0; i < loops; i++) {\n      repeatedTemplate = repeatedTemplate.concat(baseTemplate);\n    }\n    let remaining = targetMeasures - loops * totalTemplateMeasures;\n    let idx = 0;\n    while (remaining > 0) {\n      const templateSection = baseTemplate[idx % baseTemplate.length];\n      const clamp = Math.min(templateSection.measures, remaining);\n      repeatedTemplate.push({ id: templateSection.id, measures: clamp });\n      remaining -= clamp;\n      idx++;\n    }\n  } else {\n    let consumed = 0;\n    for (const section of baseTemplate) {\n      if (consumed + section.measures > targetMeasures) {\n        const remaining = Math.max(targetMeasures - consumed, 0);\n        if (remaining > 0) {\n          repeatedTemplate.push({ id: section.id, measures: remaining });\n        }\n        break;\n      }\n      repeatedTemplate.push(section);\n      consumed += section.measures;\n    }\n  }\n\n  const sections: SectionDefinition[] = [];\n  let measureCursor = 0;\n  let chordIndex = 0;\n\n  const randomizedProgressions = shuffleArray(chordsPool, seed, 200 + chordIndex);\n  const occurrenceCounter = new Map<string, number>();\n\n  const chordVariety = new Set<string>();\n  for (const progression of randomizedProgressions) {\n    progression.forEach((chord) => chordVariety.add(chord));\n  }\n\n  // Create RNG for limited progression generation\n  const createLocalRng = (localSeed: number | undefined): (() => number) => {\n    let state = (localSeed ?? 987654321) >>> 0;\n    if (state === 0) state = 987654321;\n    return () => {\n      state = (state * 1664525 + 1013904223) >>> 0;\n      return state / 0xffffffff;\n    };\n  };\n  const rng = createLocalRng(seed);\n\n  // Use limited progression for harmonicStatic styles\n  const useHarmonicStatic = precomputedIntent.harmonicStatic === true;\n  const useSingleChord = useHarmonicStatic && chordVariety.size <= 1;\n\n  for (const section of repeatedTemplate) {\n    let progression: string[];\n\n    if (useSingleChord && randomizedProgressions.length > 0) {\n      // Original behavior: single static chord\n      progression = [randomizedProgressions[0][0]];\n    } else if (useHarmonicStatic && randomizedProgressions.length > 0) {\n      // New behavior: limited progression with occasional related chords\n      const baseChord = randomizedProgressions[chordIndex % randomizedProgressions.length][0];\n      progression = buildLimitedProgression(baseChord, rng);\n    } else {\n      // Normal progression\n      progression = randomizedProgressions[chordIndex % randomizedProgressions.length];\n    }\n    const templateId = section.id;\n    const occurrenceIndex = (occurrenceCounter.get(templateId) ?? 0) + 1;\n    occurrenceCounter.set(templateId, occurrenceIndex);\n\n    const texture = resolveTexture(templateId, occurrenceIndex, seed);\n\n    sections.push({\n      id: `${section.id}${sections.filter((s) => s.id.startsWith(section.id)).length + 1}`,\n      startMeasure: measureCursor,\n      measures: section.measures,\n      chordProgression: progression,\n      templateId,\n      occurrenceIndex,\n      texture\n    });\n    measureCursor += section.measures;\n    // Increment chord index unless using single static chord\n    if (!useSingleChord) {\n      chordIndex++;\n    }\n  }\n\n  return sections;\n}\n\n// Inline texture sequences (REFACTOR_PLAN.md Step 1-E: Scenario C - Hybrid approach)\n// Moved from texture-profiles.json to enable 10% seed-driven variation for diversity\nconst TEMPLATE_TEXTURE_SEQUENCE: Record<string, TextureProfile[]> = {\n  Intro: [\"broken\"],\n  A: [\"broken\", \"steady\", \"broken\"],\n  B: [\"steady\", \"steady\", \"arpeggio\"],\n  Bridge: [\"arpeggio\", \"steady\"],\n  C: [\"steady\", \"arpeggio\", \"steady\"]\n};\n\nconst TEMPLATE_PHRASE_LENGTH: Record<string, number> = {\n  Intro: 1,\n  A: 2,\n  B: 2,\n  Bridge: 4,\n  C: 2\n};\n\n// Arpeggio keep probabilities (first vs repeat occurrences)\nconst ARPEGGIO_KEEP_PROBABILITY = {\n  firstOccurrence: 0.7,\n  repeatOccurrence: 0.4\n};\n\n// Seed-driven variation probability (maintains diversity per VARIATION_RISK_ASSESSMENT.md)\nconst TEXTURE_VARIATION_PROBABILITY = 0.1;\n\nfunction resolveTexture(\n  templateId: string,\n  occurrenceIndex: number,\n  seed: number | undefined\n): TextureProfile {\n  const sequence = TEMPLATE_TEXTURE_SEQUENCE[templateId] ?? [DEFAULT_TEXTURE];\n  const plannedTexture = sequence[(occurrenceIndex - 1) % sequence.length] ?? DEFAULT_TEXTURE;\n\n  // Apply arpeggio probability fallback logic\n  if (plannedTexture === \"arpeggio\") {\n    const isFirstOccurrence = occurrenceIndex === 1;\n    const seedSalt = templateId.split(\"\").reduce((sum, char) => sum + char.charCodeAt(0), 0);\n    const roll = randomFromSeed(seed, 1000 + seedSalt * 7 + occurrenceIndex * 13);\n    const keepProbability = isFirstOccurrence\n      ? ARPEGGIO_KEEP_PROBABILITY.firstOccurrence\n      : ARPEGGIO_KEEP_PROBABILITY.repeatOccurrence;\n\n    if (roll > keepProbability) {\n      const fallback = sequence.find((candidate) => candidate !== \"arpeggio\") ?? DEFAULT_TEXTURE;\n      return fallback;\n    }\n  }\n\n  // Apply 10% seed-driven variation to maintain diversity (REFACTOR_PLAN.md Scenario C)\n  const variationSalt = templateId.charCodeAt(0) * 100 + occurrenceIndex;\n  const variationRoll = randomFromSeed(seed, 2000 + variationSalt);\n  if (variationRoll < TEXTURE_VARIATION_PROBABILITY) {\n    const allTextures: TextureProfile[] = [\"steady\", \"broken\", \"arpeggio\"];\n    const alternatives = allTextures.filter((t) => t !== plannedTexture);\n    const index = Math.floor(randomFromSeed(seed, 3000 + variationSalt) * alternatives.length);\n    return alternatives[index] ?? plannedTexture;\n  }\n\n  return plannedTexture;\n}\n\nfunction resolvePhraseLength(templateId: string): number {\n  return TEMPLATE_PHRASE_LENGTH[templateId] ?? DEFAULT_PHRASE_LENGTH;\n}\n\n// Helper functions for computed section properties (REFACTOR_PLAN.md Step 1-D)\nexport function getPhraseLengthForSection(section: { templateId: string }): number {\n  return resolvePhraseLength(section.templateId);\n}\n\nexport function establishesHook(section: { templateId: string; occurrenceIndex: number }): boolean {\n  return section.occurrenceIndex === 1 && HOOK_TEMPLATES.has(section.templateId);\n}\n\nexport function repriseHook(section: { templateId: string; occurrenceIndex: number }): boolean {\n  return section.occurrenceIndex > 1 && HOOK_TEMPLATES.has(section.templateId);\n}\n\nfunction deriveTechniqueStrategy(\n  mood: PipelineCompositionOptions[\"mood\"],\n  styleIntent: StyleIntent,\n  seed: number | undefined\n): TechniqueStrategy {\n  let base: TechniqueStrategy;\n  let salt = 50;\n  switch (mood) {\n    case \"tense\":\n      base = { echoProbability: 0.5, detuneProbability: 0.3, fastArpeggioProbability: 0.4 };\n      salt = 10;\n      break;\n    case \"upbeat\":\n      base = { echoProbability: 0.4, detuneProbability: 0.2, fastArpeggioProbability: 0.2 };\n      salt = 20;\n      break;\n    case \"sad\":\n      base = { echoProbability: 0.6, detuneProbability: 0.1, fastArpeggioProbability: 0.1 };\n      salt = 30;\n      break;\n    case \"peaceful\":\n      base = { echoProbability: 0.5, detuneProbability: 0.05, fastArpeggioProbability: 0.05 };\n      salt = 40;\n      break;\n    default:\n      base = { echoProbability: 0.3, detuneProbability: 0.3, fastArpeggioProbability: 0.3 };\n      break;\n  }\n\n  const styled = applyStyleIntentToTechnique(base, styleIntent);\n  return jitterTechnique(styled, seed, salt);\n}\n\nfunction jitterTechnique(base: TechniqueStrategy, seed: number | undefined, salt: number): TechniqueStrategy {\n  const clamp = (value: number) => Math.min(0.95, Math.max(0.05, value));\n  const jitter = (offsetSalt: number) => (randomFromSeed(seed, salt + offsetSalt) - 0.5) * 0.2;\n  return {\n    echoProbability: clamp(base.echoProbability + jitter(1)),\n    detuneProbability: clamp(base.detuneProbability + jitter(2)),\n    fastArpeggioProbability: clamp(base.fastArpeggioProbability + jitter(3))\n  };\n}\n\nfunction applyStyleIntentToTechnique(base: TechniqueStrategy, intent: StyleIntent): TechniqueStrategy {\n  const result: TechniqueStrategy = { ...base };\n\n  if (intent.textureFocus) {\n    result.fastArpeggioProbability = Math.max(0.05, result.fastArpeggioProbability * 0.6);\n    result.echoProbability = Math.min(0.95, result.echoProbability + 0.05);\n  }\n\n  if (intent.loopCentric) {\n    result.detuneProbability = Math.max(0.05, result.detuneProbability * 0.8);\n  }\n\n  if (intent.gradualBuild) {\n    result.echoProbability = Math.min(0.95, result.echoProbability + 0.1);\n  }\n\n  if (intent.harmonicStatic) {\n    result.detuneProbability = Math.max(0.05, result.detuneProbability * 0.7);\n  }\n\n  if (intent.percussiveLayering) {\n    result.fastArpeggioProbability = Math.min(0.9, result.fastArpeggioProbability + 0.05);\n  }\n\n  if (intent.filterMotion) {\n    result.detuneProbability = Math.min(0.9, result.detuneProbability + 0.1);\n  }\n\n  if (intent.syncopationBias) {\n    result.echoProbability = Math.min(0.9, result.echoProbability + 0.05);\n  }\n\n  if (intent.atmosPad) {\n    result.echoProbability = Math.min(0.95, result.echoProbability + 0.08);\n  }\n\n  if (intent.breakInsertion) {\n    result.fastArpeggioProbability = Math.max(0.05, result.fastArpeggioProbability * 0.9);\n  }\n\n  return result;\n}\n\n// ========================================\n// Voice Arrangement Definitions\n// ========================================\n\nconst VOICE_ARRANGEMENTS: Record<VoiceArrangementPreset, VoiceArrangement> = {\n  standard: {\n    id: \"standard\",\n    description: \"Classic melody + accompaniment + bass\",\n    voices: [\n      { role: \"melody\", channel: \"square1\", priority: 1.0, octaveOffset: 0 },\n      { role: \"accompaniment\", channel: \"square2\", priority: 1.0, octaveOffset: 0 },\n      { role: \"bass\", channel: \"triangle\", priority: 1.0, octaveOffset: 0 }\n    ]\n  },\n\n  swapped: {\n    id: \"swapped\",\n    description: \"Swapped square channels for tonal variety\",\n    voices: [\n      { role: \"melody\", channel: \"square2\", priority: 1.0, octaveOffset: 0 },\n      { role: \"accompaniment\", channel: \"square1\", priority: 1.0, octaveOffset: 0 },\n      { role: \"bass\", channel: \"triangle\", priority: 1.0, octaveOffset: 0 }\n    ]\n  },\n\n  dualBass: {\n    id: \"dualBass\",\n    description: \"Melody with dual bass (thick low end)\",\n    voices: [\n      { role: \"melody\", channel: \"square1\", priority: 1.0, octaveOffset: 0 },\n      { role: \"bass\", channel: \"square2\", priority: 1.0, octaveOffset: 0, seedOffset: 0 },\n      { role: \"bassAlt\", channel: \"triangle\", priority: 0.7, octaveOffset: -1, seedOffset: 100 }\n    ]\n  },\n\n  bassLed: {\n    id: \"bassLed\",\n    description: \"Bass-focused with sparse melodic decoration\",\n    voices: [\n      { role: \"bass\", channel: \"triangle\", priority: 1.0, octaveOffset: -1, seedOffset: 0 },\n      { role: \"bassAlt\", channel: \"square2\", priority: 0.8, octaveOffset: 0, seedOffset: 200 },\n      { role: \"melody\", channel: \"square1\", priority: 0.3, octaveOffset: 0 }\n    ]\n  },\n\n  layeredBass: {\n    id: \"layeredBass\",\n    description: \"Layered bass with complementary square/triangle movement\",\n    voices: [\n      { role: \"bass\", channel: \"square1\", priority: 1.0, octaveOffset: 0, seedOffset: 0 },\n      { role: \"bassAlt\", channel: \"triangle\", priority: 0.85, octaveOffset: 0, seedOffset: 160 },\n      { role: \"melody\", channel: \"square2\", priority: 1.0, octaveOffset: 0 }\n    ]\n  },\n\n  minimal: {\n    id: \"minimal\",\n    description: \"Minimal techno: bass + sparse pad only\",\n    voices: [\n      { role: \"bass\", channel: \"square1\", priority: 1.0, octaveOffset: 0 },\n      { role: \"pad\", channel: \"triangle\", priority: 0.4, octaveOffset: 0 }\n    ]\n  },\n\n  breakLayered: {\n    id: \"breakLayered\",\n    description: \"Breakbeat layering: dual bass pressure with agile lead\",\n    voices: [\n      { role: \"bass\", channel: \"square1\", priority: 1.0, octaveOffset: 0, seedOffset: 0 },\n      { role: \"bassAlt\", channel: \"triangle\", priority: 0.95, octaveOffset: -1, seedOffset: 140 },\n      { role: \"melody\", channel: \"square2\", priority: 0.85, octaveOffset: 0, seedOffset: 240 }\n    ]\n  },\n\n  lofiPadLead: {\n    id: \"lofiPadLead\",\n    description: \"Lo-fi pad-first texture with gentle lead flourishes\",\n    voices: [\n      { role: \"pad\", channel: \"triangle\", priority: 0.9, octaveOffset: -1 },\n      { role: \"accompaniment\", channel: \"square2\", priority: 1.0, octaveOffset: -1, seedOffset: 60 },\n      { role: \"melody\", channel: \"square1\", priority: 0.45, octaveOffset: 0, seedOffset: 180 }\n    ]\n  },\n\n  retroPulse: {\n    id: \"retroPulse\",\n    description: \"Retro loopwave pulse arpeggios with anchored bass\",\n    voices: [\n      { role: \"melody\", channel: \"square1\", priority: 1.0, octaveOffset: 0, seedOffset: 80 },\n      { role: \"accompaniment\", channel: \"square2\", priority: 0.85, octaveOffset: 0, seedOffset: 140 },\n      { role: \"bass\", channel: \"triangle\", priority: 0.9, octaveOffset: -1, seedOffset: 40 }\n    ]\n  }\n};\n\n/**\n * Style-aware arrangement weights\n */\nconst ARRANGEMENT_WEIGHTS_BY_STYLE: Record<StylePreset, Partial<Record<VoiceArrangementPreset, number>>> = {\n  minimalTechno: {\n    standard: 2,\n    minimal: 5,\n    bassLed: 3,\n    dualBass: 2,\n    swapped: 1,\n    layeredBass: 1\n  },\n  progressiveHouse: {\n    standard: 4,\n    swapped: 3,\n    layeredBass: 3,\n    dualBass: 2,\n    bassLed: 1,\n    minimal: 0\n  },\n  retroLoopwave: {\n    standard: 2,\n    swapped: 3,\n    retroPulse: 5,\n    layeredBass: 1,\n    minimal: 0,\n    bassLed: 1\n  },\n  breakbeatJungle: {\n    breakLayered: 5,\n    dualBass: 3,\n    layeredBass: 2,\n    bassLed: 2,\n    standard: 1,\n    swapped: 1,\n    minimal: 0\n  },\n  lofiChillhop: {\n    lofiPadLead: 5,\n    minimal: 3,\n    standard: 2,\n    swapped: 1,\n    bassLed: 1,\n    layeredBass: 0,\n    dualBass: 1\n  }\n};\n\nconst DEFAULT_ARRANGEMENT_WEIGHTS: Record<VoiceArrangementPreset, number> = {\n  standard: 5,\n  swapped: 4,\n  dualBass: 2,\n  bassLed: 2,\n  layeredBass: 2,\n  minimal: 1,\n  breakLayered: 1,\n  lofiPadLead: 1,\n  retroPulse: 2\n};\n\n/**\n * Select voice arrangement based on seed and style\n */\nfunction selectVoiceArrangement(\n  seed: number | undefined,\n  stylePreset: StylePreset | undefined\n): VoiceArrangement {\n  const weights = stylePreset\n    ? { ...DEFAULT_ARRANGEMENT_WEIGHTS, ...ARRANGEMENT_WEIGHTS_BY_STYLE[stylePreset] }\n    : DEFAULT_ARRANGEMENT_WEIGHTS;\n\n  const entries = Object.entries(weights) as [VoiceArrangementPreset, number][];\n  const totalWeight = entries.reduce((sum, [, w]) => sum + w, 0);\n\n  const rand = randomFromSeed(seed, 100);\n  let cumulative = 0;\n\n  for (const [preset, weight] of entries) {\n    cumulative += weight / totalWeight;\n    if (rand < cumulative) {\n      return VOICE_ARRANGEMENTS[preset];\n    }\n  }\n\n  return VOICE_ARRANGEMENTS.standard;\n}\n\nexport function planStructure(options: PipelineCompositionOptions): StructurePlanResult {\n  const baseBpm = TEMPO_BASE[options.tempo];\n  const bpmOffset = Math.round((randomFromSeed(options.seed, 1) - 0.5) * 30);\n  const bpm = baseBpm + Math.max(-15, Math.min(15, bpmOffset));\n  const moodTags = MOOD_TAG_MAP[options.mood];\n  const key = resolveKey(options.mood, options.seed);\n  const scaleDegrees = SCALE_DEGREES[key];\n\n  if (!scaleDegrees) {\n    throw new Error(`Scale not defined for key ${key}`);\n  }\n\n  const chordsPool = selectChordProgressions(key, moodTags, options.seed);\n  const precomputedIntent = precomputeStyleIntent(options);\n  const sections = buildSections(options, chordsPool, options.seed, precomputedIntent);\n  const styleIntent = resolveStyleIntent(options, sections);\n  const techniqueStrategy = deriveTechniqueStrategy(options.mood, styleIntent, options.seed);\n\n  validateSectionLength(options.lengthInMeasures, sections);\n\n  const voiceArrangement = selectVoiceArrangement(options.seed, options.stylePreset);\n\n  return {\n    bpm,\n    key,\n    scaleDegrees,\n    sections,\n    techniqueStrategy,\n    styleIntent,\n    voiceArrangement\n  };\n}\n\nfunction pickTemplateForMood(mood: PipelineCompositionOptions[\"mood\"], seed: number | undefined) {\n  const candidates = TEMPLATE_INDEX_BY_MOOD[mood] ?? SECTION_TEMPLATE_POOL.map((_, index) => index);\n  const index = candidates[Math.floor(randomFromSeed(seed, 60) * candidates.length)] ?? 0;\n  return SECTION_TEMPLATE_POOL[index].map((segment) => ({ ...segment }));\n}\n\nfunction shuffleArray<T>(items: T[], seed: number | undefined, salt: number): T[] {\n  const copy = [...items];\n  for (let i = copy.length - 1; i > 0; i--) {\n    const randomIndex = Math.floor(randomFromSeed(seed, salt + i) * (i + 1));\n    const temp = copy[i];\n    copy[i] = copy[randomIndex];\n    copy[randomIndex] = temp;\n  }\n  return copy;\n}\n\nfunction resolveKey(mood: PipelineCompositionOptions[\"mood\"], seed: number | undefined): string {\n  const preferred = DEFAULT_KEY_PER_MOOD[mood];\n  if (preferred && AVAILABLE_CHORD_KEYS.includes(preferred)) {\n    return preferred;\n  }\n  if (!AVAILABLE_CHORD_KEYS.length) {\n    throw new Error(\"Chord library is empty\");\n  }\n  const fallbackIndex = Math.floor(randomFromSeed(seed, 5) * AVAILABLE_CHORD_KEYS.length) % AVAILABLE_CHORD_KEYS.length;\n  return AVAILABLE_CHORD_KEYS[fallbackIndex];\n}\n\nfunction validateSectionLength(target: number, sections: SectionDefinition[]) {\n  const sum = sections.reduce((acc, s) => acc + s.measures, 0);\n  if (sum !== target) {\n    throw new Error(`Section length mismatch. expected=${target}, actual=${sum}`);\n  }\n}\n","import { AbstractNote, DrumHit, StructurePlanResult } from \"./types.js\";\n\n/**\n * Drum durations are deliberately short to emulate chiptune hardware constraints.\n * The noise channel is monophonic and must quickly switch between different drum sounds.\n * These durations prevent overlapping notes and give the percussive \"chip\" character:\n * - Kick (K): 1/16 note - Quick thud to avoid muddying the bass\n * - Snare (S): 1/16 note - Sharp crack without lingering\n * - Hi-hat (H): 1/32 note - Extremely short to simulate closed hi-hat\n * - Open hi-hat (O): 3/32 note - Slightly longer for \"open\" character\n * - Tom (T): 1/8 note - Longest for pitched drum effect\n * - Noise effect (N): 3/32 note - Special effects/crashes\n */\nconst DRUM_DURATION_BEATS: Record<DrumHit[\"instrument\"], number> = {\n  K: 0.25,\n  S: 0.25,\n  H: 0.125,\n  O: 0.375,\n  T: 0.5,\n  N: 0.375\n};\n\n/**\n * Lookup table for fast conversion from note names to semitone offsets.\n * Supports both sharp and flat notation (enharmonic equivalents) because\n * chord notation uses both (#/b) depending on key (e.g., D# vs Eb),\n * musicians expect both notations to work interchangeably, and lookup\n * is faster than parsing/calculating on each call.\n */\nconst NOTE_TO_SEMITONE: Record<string, number> = {\n  C: 0,\n  \"C#\": 1,\n  Db: 1,\n  D: 2,\n  \"D#\": 3,\n  Eb: 3,\n  E: 4,\n  F: 5,\n  \"F#\": 6,\n  Gb: 6,\n  G: 7,\n  \"G#\": 8,\n  Ab: 8,\n  A: 9,\n  \"A#\": 10,\n  Bb: 10,\n  B: 11\n};\n\n/**\n * Chord intervals define the harmonic structure for accompaniment and melody quantization.\n * Intervals are semitone offsets from the root, stored as arrays for easy iteration.\n * This supports quantizing melody notes to chord tones (ensures harmony), generating\n * broken chords and arpeggios in Phase 3, and voice leading and consonance checking in Phase 2.\n *\n * Limited to common chords because chiptune music typically uses simple harmony\n * (hardware limitations inspired this), complex jazz chords would require 4+ note\n * polyphony (we only have 3 melodic channels), and retro game music rarely used extended chords.\n */\nconst DEFAULT_CHORD_INTERVALS: Record<string, number[]> = {\n  \"\": [0, 4, 7],        // Major triad (C-E-G)\n  m: [0, 3, 7],         // Minor triad (C-Eb-G)\n  7: [0, 4, 7, 10],     // Dominant 7th (C-E-G-Bb)\n  m7: [0, 3, 7, 10],    // Minor 7th (C-Eb-G-Bb)\n  maj7: [0, 4, 7, 11],  // Major 7th (C-E-G-B)\n  sus2: [0, 2, 7],      // Suspended 2nd (C-D-G) - removes 3rd for ambiguity\n  sus4: [0, 5, 7],      // Suspended 4th (C-F-G) - tension/resolution\n  dim: [0, 3, 6],       // Diminished (C-Eb-Gb) - for dramatic passages\n  aug: [0, 4, 8]        // Augmented (C-E-G#) - for surreal/tense moments\n};\n\n/**\n * 4/4 time signature is hardcoded because the vast majority of game music uses 4/4\n * (simplifies loop alignment), variable time signatures would complicate beat <-> measure\n * conversion throughout pipeline, and could be parameterized in future but adds\n * complexity for minimal gain.\n */\nexport const BEATS_PER_MEASURE = 4;\n\n/**\n * Converts a chord root (e.g., \"C#\", \"Eb\") to MIDI note number in a given octave.\n *\n * Chord symbols (like \"Am7\") must be converted to MIDI for bass line generation\n * (uses chord roots), accompaniment generation (uses chord tones), and melody\n * quantization (snaps to chord pitches). The baseOctaveMidi parameter allows\n * different voices to use different octaves: bass typically uses MIDI 36-48 (C2-C3)\n * while melody uses MIDI 60-84 (C4-C6), letting the same function serve both cases.\n *\n * @param root Chord root note name (e.g., \"C#\", \"Eb\")\n * @param baseOctaveMidi Reference MIDI note for octave placement\n * @returns MIDI note number in the same octave as baseOctaveMidi\n */\nexport function chordRootToMidi(root: string, baseOctaveMidi: number): number {\n  const noteMatch = root.match(/^[A-G](#|b)?/i);\n  if (!noteMatch) {\n    // Graceful fallback instead of throwing - invalid chord symbols shouldn't crash generation\n    return baseOctaveMidi;\n  }\n  const note = noteMatch[0].toUpperCase();\n  const semitone = NOTE_TO_SEMITONE[note] ?? 0;\n  // Extract octave from baseOctaveMidi and add semitone offset\n  // This keeps the result in the same octave as the base reference\n  const octaveBase = baseOctaveMidi - (baseOctaveMidi % 12);\n  return octaveBase + semitone;\n}\n\n/**\n * Extracts chord intervals from a chord symbol (e.g., \"Cmaj7\" → [0, 4, 7, 11]).\n *\n * Chord symbols need to be decomposed into interval sets for arpeggio generation\n * (cycle through chord tones), broken chord patterns (select subset of tones),\n * and melody harmonization (ensure melody notes are consonant).\n *\n * Fallback logic handles unknown suffixes: tries exact match first (handles standard\n * suffixes), then checks if it starts with \"m\" (handles \"m9\", \"m11\", etc. as minor),\n * and defaults to major triad (safest harmonic fallback).\n *\n * @param chord Chord symbol (e.g., \"Am7\", \"Cmaj7\", \"G\")\n * @returns Array of semitone intervals from root [0, ...]\n */\nexport function getChordIntervals(chord: string): number[] {\n  const match = chord.match(/^[A-G](?:#|b)?(.*)$/);\n  const suffix = match?.[1] ?? \"\";\n  if (suffix in DEFAULT_CHORD_INTERVALS) {\n    return DEFAULT_CHORD_INTERVALS[suffix];\n  }\n  if (suffix.startsWith(\"m\")) {\n    // Treat \"m9\", \"m11\" etc. as minor triads for simplicity\n    return DEFAULT_CHORD_INTERVALS.m;\n  }\n  // Major triad is the safest default (works with most melodies)\n  return DEFAULT_CHORD_INTERVALS[\"\"];\n}\n\n/**\n * Converts scale degree (1-7) to MIDI note number.\n *\n * Motif-based melody generation uses scale degrees (abstract) rather than MIDI (concrete)\n * because motifs are key-independent (same motif works in C major or D minor), it's easier\n * to ensure notes stay in-scale (no accidentals), and it's a natural representation for\n * musicians (think \"do-re-mi\" not \"60-62-64\").\n *\n * Supports negative/large degrees because motifs can specify intervals like -2 (below tonic)\n * or 15 (two octaves up), and the modulo math handles this gracefully. The octaveOffset\n * parameter allows Voice Arrangement presets to transpose bassAlt down an octave or melodyAlt\n * up an octave without regenerating motifs.\n *\n * @param degree Scale degree (1 = tonic, negative/large values supported)\n * @param scale Array of semitone intervals defining the scale\n * @param baseMidi Base MIDI note for the scale's tonic\n * @param octaveOffset Additional octave transposition (default 0)\n * @returns MIDI note number\n */\nexport function scaleDegreeToMidi(\n  degree: number,\n  scale: number[],\n  baseMidi: number,\n  octaveOffset = 0\n): number {\n  // Double-modulo handles negative degrees correctly\n  // (degree - 1) because scale degrees are 1-indexed but arrays are 0-indexed\n  const index = ((degree - 1) % scale.length + scale.length) % scale.length;\n  // Floor division determines which octave the degree falls into\n  const octave = Math.floor((degree - 1) / scale.length) + octaveOffset;\n  const semitoneOffset = scale[index] + 12 * octave;\n  return baseMidi + semitoneOffset;\n}\n\n/**\n * Parses a drum pattern string into timed DrumHit events.\n *\n * Drum motifs are stored as strings like \"K---S---K---S---\" because it's a compact\n * representation (16-char string vs array of objects), easy to visualize rhythm\n * (matches how musicians read drum tabs), and simple to hand-author in JSON motif library.\n *\n * Uses 16th note resolution as the standard grid for chiptune drums: fine enough for\n * hi-hat patterns and ghost notes, coarse enough to avoid timing jitter on retro\n * hardware, and matches the quantization of classic game music.\n *\n * @param pattern Drum pattern string (e.g., \"K---S---K---S---\")\n * @param startBeat Beat time to start the pattern\n * @param sectionId Section identifier for diagnostics\n * @returns Array of DrumHit events with timing and instrument\n */\nexport function generateDrumHitsFromPattern(\n  pattern: string,\n  startBeat: number,\n  sectionId: string\n): DrumHit[] {\n  const hits: DrumHit[] = [];\n  const beatResolution = 16; // 16th notes\n  for (let idx = 0; idx < pattern.length; idx++) {\n    const symbol = pattern[idx] as DrumHit[\"instrument\"] | \"-\";\n    if (symbol === \"-\") {\n      continue;\n    }\n    // Maps pattern index to beat time on 16th note grid\n    const stepBeat = startBeat + (idx / beatResolution) * BEATS_PER_MEASURE;\n    hits.push({\n      startBeat: stepBeat,\n      durationBeats: DRUM_DURATION_BEATS[symbol] ?? 0.25,\n      instrument: symbol,\n      sectionId\n    });\n  }\n  return hits;\n}\n\n/**\n * Resolves the current chord symbol at a given beat time.\n *\n * Many generation steps need to know \"what chord am I in right now?\" for bass generator\n * (uses chord roots), accompaniment (uses chord tones), and melody quantization (ensures harmony).\n *\n * Uses measure-based lookup: chord progressions are stored per-section with one chord per measure,\n * converting beat → measure → section → chord progression index. If a section has 4 measures but\n * the progression is only 2 chords long, we cycle through the progression to fill the section.\n *\n * @param phase1 Structure planning result with section definitions\n * @param beatTime Current beat time to resolve\n * @param beatsPerMeasure Beats per measure (default 4)\n * @returns Chord symbol at the given beat time\n */\nexport function resolveChordAtBeat(\n  phase1: StructurePlanResult,\n  beatTime: number,\n  beatsPerMeasure = BEATS_PER_MEASURE\n): string {\n  const measureIndex = Math.floor(beatTime / beatsPerMeasure);\n  const section = phase1.sections.find((candidate) => {\n    return (\n      measureIndex >= candidate.startMeasure &&\n      measureIndex < candidate.startMeasure + candidate.measures\n    );\n  });\n  if (!section) {\n    // Graceful fallback to first chord instead of crashing\n    // Can happen if timing calculations have rounding errors\n    const fallback = phase1.sections[0];\n    return fallback?.chordProgression[0] ?? \"C\";\n  }\n  const relativeMeasure = Math.max(0, measureIndex - section.startMeasure);\n  // Allows short progressions to loop within longer sections\n  return section.chordProgression[relativeMeasure % section.chordProgression.length];\n}\n\n/**\n * Converts frequency (Hz) to MIDI note number.\n *\n * Used for SE generation when baseFrequency option is specified in Hz.\n * Formula: MIDI = 69 + 12 * log2(freq / 440.0)\n * - 69 is MIDI number for A4 (440 Hz)\n * - 12 semitones per octave\n * - log2 converts frequency ratio to octaves\n *\n * @param freq Frequency in Hz (e.g., 440.0 for A4)\n * @returns MIDI note number (may be fractional)\n */\nexport function frequencyToMidi(freq: number): number {\n  return 69 + 12 * Math.log2(freq / 440.0);\n}\n\n/**\n * Converts frequency ratio to semitone interval.\n *\n * Used for pitch shift calculations in SE generation.\n * Formula: semitones = 12 * log2(ratio)\n * - Ratio of 2.0 = 12 semitones (one octave)\n * - Ratio of 1.5 = ~7 semitones (perfect fifth)\n *\n * @param ratio Frequency ratio (target / original)\n * @returns Semitone interval (may be fractional)\n */\nexport function frequencyToSemitones(ratio: number): number {\n  return 12 * Math.log2(ratio);\n}\n\n/**\n * Converts MIDI note number to frequency (Hz).\n *\n * Inverse of frequencyToMidi, useful for verification and debugging.\n * Formula: freq = 440.0 * 2^((midi - 69) / 12)\n *\n * @param midi MIDI note number (e.g., 69 for A4)\n * @returns Frequency in Hz\n */\nexport function midiToFrequency(midi: number): number {\n  return 440.0 * Math.pow(2, (midi - 69) / 12);\n}\n\n/**\n * Helper for pitch class (mod 12) operations.\n * Pitch class operations appear frequently in consonance checking and interval analysis.\n * Positive modulo ensures correct behavior for negative inputs.\n */\nfunction mod12(value: number): number {\n  return (value % 12 + 12) % 12;\n}\n\n/**\n * Quantizes a MIDI note to the nearest chord tone.\n *\n * When generating accompaniment or correcting melody notes, we often need to\n * \"snap\" to the nearest chord tone to ensure harmonic coherence. Searches ±2 octaves\n * to find chord tones in different registers without straying too far from the original\n * pitch, limiting excessive octave jumps. Closest pitch wins to minimize melodic leaps\n * and preserve smooth voice leading.\n *\n * @param midi Original MIDI note to quantize\n * @param chord Chord symbol to quantize to\n * @returns Nearest chord tone MIDI note\n */\nexport function quantizeMidiToChord(midi: number, chord: string): number {\n  const root = chordRootToMidi(chord, midi);\n  const intervals = getChordIntervals(chord);\n  let best = midi;\n  let bestDiff = Infinity;\n  for (const interval of intervals) {\n    for (let octave = -2; octave <= 2; octave++) {\n      const candidate = root + interval + octave * 12;\n      const diff = Math.abs(candidate - midi);\n      if (diff < bestDiff) {\n        best = candidate;\n        bestDiff = diff;\n      }\n    }\n  }\n  return best;\n}\n\n/**\n * Consonant intervals (semitones) used for voice leading.\n * Includes unison (0), minor/major thirds (3, 4), perfect fourth (5),\n * perfect fifth (7), and minor/major sixths (8, 9).\n * Excludes dissonant intervals like minor second (1), tritone (6), and major seventh (11).\n */\nconst CONSONANT_INTERVALS = new Set([0, 3, 4, 5, 7, 8, 9]);\n\n/**\n * Ensures a MIDI note is consonant with both the chord and a reference melody note.\n *\n * Used for accompaniment generation where we need to avoid harsh dissonances between\n * melody and accompaniment. If no referenceMidi is provided, falls back to simple\n * chord quantization. Otherwise, uses a scoring system that balances three factors:\n *\n * 1. Interval penalty: Heavily penalizes dissonant intervals (seconds, sevenths, tritones)\n * 2. Proximity penalty: Prefers staying close to the original pitch (smooth voice leading)\n * 3. Spread penalty: Avoids extreme register separation from the reference note\n *\n * The weighted scoring allows the algorithm to make intelligent trade-offs: it will\n * accept a slightly larger leap if it avoids a dissonant interval, or move to a different\n * octave if the current register creates too much separation.\n *\n * @param midi Original MIDI note to adjust\n * @param chord Current chord symbol\n * @param referenceMidi Optional reference note (typically melody) to avoid dissonance with\n * @returns MIDI note that is both in the chord and consonant with the reference\n */\nexport function ensureConsonantPitch(\n  midi: number,\n  chord: string,\n  referenceMidi?: number\n): number {\n  if (referenceMidi === undefined) {\n    return quantizeMidiToChord(midi, chord);\n  }\n  const root = chordRootToMidi(chord, referenceMidi);\n  const intervals = getChordIntervals(chord);\n  let best = midi;\n  let bestScore = Number.POSITIVE_INFINITY;\n  for (const interval of intervals) {\n    for (let octave = -2; octave <= 2; octave++) {\n      const candidate = root + interval + octave * 12;\n      const intervalClass = mod12(candidate - referenceMidi);\n      // Heavy penalty for dissonant intervals between candidate and reference\n      const intervalPenalty = CONSONANT_INTERVALS.has(intervalClass) ? 0 : 10;\n      // Prefer staying close to original pitch\n      const proximityPenalty = Math.abs(candidate - midi) * 0.1;\n      // Avoid extreme register separation\n      const spreadPenalty = Math.abs(candidate - referenceMidi) * 0.05;\n      const score = intervalPenalty + proximityPenalty + spreadPenalty;\n      if (score < bestScore) {\n        bestScore = score;\n        best = candidate;\n      }\n    }\n  }\n  return best;\n}\n","/**\n * Velocity Configuration Constants\n *\n * This file centralizes all velocity-related magic numbers used throughout\n * the composition pipeline. These values have been tuned for chiptune synthesis\n * and Web Audio playback.\n *\n * References:\n * - REFACTORING_ROADMAP.md P1-3\n * - Chiptune hardware velocity range constraints\n */\n\n/**\n * Global velocity constraints for chiptune synthesis\n */\nexport const VELOCITY_GLOBAL = {\n  /** Minimum safe velocity value for all channels */\n  MIN: 20,\n\n  /** Maximum recommended velocity for chiptune hardware (avoids distortion) */\n  MAX: 118,\n\n  /** Maximum accent velocity (used for emphasized notes) */\n  MAX_ACCENT: 118\n} as const;\n\n/**\n * Channel-specific velocity scaling factors\n *\n * These compensate for Web Audio synthesis characteristics and\n * chiptune channel differences.\n */\nexport const VELOCITY_CHANNEL_SCALE = {\n  /** Triangle channel base scale (Web Audio compensation) */\n  TRIANGLE_BASE: 0.75,\n\n  /** Triangle non-bass role additional scale */\n  TRIANGLE_NON_BASS: 0.9,\n\n  /** Bass role base scale (all channels) */\n  BASS_BASE: 0.7,\n\n  /** Bass low-range additional scale (below E3) */\n  BASS_LOW_RANGE: 0.85,\n\n  /** Square channel bass role additional scale */\n  SQUARE_BASS: 0.82\n} as const;\n\n/**\n * MIDI pitch thresholds for velocity adjustments\n */\nexport const VELOCITY_PITCH_THRESHOLD = {\n  /** E3 (MIDI 52) - bass low-range boost threshold */\n  BASS_LOW_RANGE: 52\n} as const;\n\n/**\n * Bass velocity by texture type\n *\n * Base velocity values for different bass textures.\n * Downbeat and strong beat boosts are added on top of these.\n */\nexport const VELOCITY_BASS_TEXTURE = {\n  broken: 74,\n  steady: 70,\n  arpeggio: 76,\n  /** Default fallback when texture is unknown */\n  default: 72\n} as const;\n\n/**\n * Bass accent and emphasis boosts\n */\nexport const VELOCITY_BASS_ACCENT = {\n  /** Downbeat (step 0) velocity boost */\n  DOWNBEAT_BOOST: 6,\n\n  /** Strong beat (step % 4 === 0) velocity boost */\n  STRONG_BEAT_BOOST: 3\n} as const;\n\n/**\n * Melody velocity settings\n */\nexport const VELOCITY_MELODY = {\n  /** Pickup note base velocity */\n  PICKUP_BASE: 72\n} as const;\n\n/**\n * Accompaniment velocity settings\n */\nexport const VELOCITY_ACCOMPANIMENT = {\n  /** Early-start accompaniment note velocity */\n  EARLY_START: 52,\n\n  /** Pad sustained note minimum velocity */\n  PAD_MIN: 48,\n\n  /** Base velocity scale for arpeggio texture (relative to seed) */\n  ARPEGGIO_SCALE: 0.75,\n\n  /** Minimum arpeggio velocity after scaling */\n  ARPEGGIO_MIN: 35,\n\n  /** Broken chord velocity scale (relative to seed) */\n  BROKEN_SCALE: 0.9,\n\n  /** Minimum broken chord velocity after scaling */\n  BROKEN_MIN: 40,\n\n  /** Steady chord velocity scale (relative to seed) */\n  STEADY_SCALE: 0.85,\n\n  /** Minimum steady chord velocity after scaling */\n  STEADY_MIN: 38\n} as const;\n\n/**\n * Technique effect velocity multipliers\n */\nexport const VELOCITY_TECHNIQUE = {\n  /** Echo effect velocity scale */\n  ECHO_SCALE: 0.6,\n\n  /** Detune effect velocity scale */\n  DETUNE_SCALE: 0.7\n} as const;\n\n/**\n * Noise channel velocity configuration\n *\n * Each noise instrument (drum sound) has a fixed velocity optimized\n * for chiptune noise channel characteristics.\n */\nexport const VELOCITY_NOISE = {\n  /** K - Kick drum (long period, index 3) */\n  KICK: 120,\n\n  /** T - Tom (long period, index 5) */\n  TOM: 116,\n\n  /** N - Low noise (long period, index 8) */\n  LOW_NOISE: 112,\n\n  /** S - Snare (short period, index 1) */\n  SNARE: 115,\n\n  /** H - Hi-hat (short period, index 0) */\n  HIHAT: 118,\n\n  /** O - Open hat (short period, index 2) */\n  OPEN_HAT: 114\n} as const;\n","/**\n * Phase 2: Motif Selection\n *\n * This phase is responsible for selecting pre-composed motifs from the library and assembling\n * them into concrete musical tracks. It bridges the gap between abstract structure (Phase 1)\n * and physical channel realization (Phase 3).\n *\n * ## Why Motif-Based Architecture?\n *\n * The system uses pre-composed motifs rather than algorithmic generation because:\n * - **Quality control**: Hand-crafted motifs ensure musical coherence (algorithmic generation\n *   often produces awkward intervals or rhythms that sound \"robotic\")\n * - **Style consistency**: Motifs are tagged with mood/tempo/style metadata, allowing context-aware\n *   selection that matches the desired aesthetic\n * - **Variation management**: Motif libraries can be curated to avoid excessive repetition while\n *   maintaining recognizable themes (the \"hook\" system)\n * - **Rapid iteration**: Composers can improve output quality by adding/editing motifs without\n *   changing code\n *\n * ## Core Design Principles\n *\n * ### 1. Tag-Based Filtering with Fallback\n * Motif selection uses a multi-stage filtering pipeline:\n * - Primary filter: Mood/tempo/function tags (e.g., \"upbeat\", \"start\", \"cadence\")\n * - Secondary filter: Style intent tags (e.g., \"loop_safe\", \"syncopation\")\n * - Fallback: If filtering exhausts candidates, progressively relax constraints\n *\n * This prevents the system from getting \"stuck\" with no valid motifs while still preferring\n * contextually appropriate choices.\n *\n * ### 2. Hook Caching for Musical Identity\n * The first occurrence of \"A\" sections establishes a \"hook\" - a memorable melodic/rhythmic\n * pattern that defines the composition's identity. Subsequent \"A\" sections retrieve and vary\n * this cached hook, creating the A-A'-A'' structure common in game music.\n *\n * This is critical because:\n * - Purely random selection produces incoherent \"salad\" with no thematic unity\n * - Exact repetition becomes monotonous in looping game BGM\n * - Variation (using motif.variations[] links) balances familiarity and novelty\n *\n * ### 3. Voice Arrangement System Integration\n * Phase 2 generates abstract \"role-based\" tracks (melody, bass, accompaniment, pad) rather than\n * channel-specific tracks. This separation allows:\n * - The same melody to be played on square1 (standard) or square2 (swapped)\n * - Bass patterns to work on triangle (standard) or square channels (dualBass/minimal)\n * - Pad roles to generate sustained notes for lofi/atmospheric styles\n *\n * Phase 3 maps these abstract roles to physical channels based on the selected Voice Arrangement.\n *\n * ### 4. Functional Tagging for Phrase Boundaries\n * Melody-rhythm motifs are tagged with functional roles:\n * - \"start\": Establishes the phrase (typically on downbeat)\n * - \"middle\": Develops the phrase (fills interior measures)\n * - \"end\": Concludes the phrase (often includes \"cadence\" tag)\n * - \"pickup\": Anacrusis notes before downbeat\n *\n * This ensures phrases have proper \"sentence structure\" rather than arbitrary concatenation.\n *\n * ### 5. Accompaniment Seed Generation\n * Accompaniment tracks generate \"seed notes\" (whole note chords) that Phase 3 expands into\n * texture-specific patterns (arpeggios, broken chords, steady pads). This two-stage approach:\n * - Keeps Phase 2 focused on harmonic content rather than rhythmic detail\n * - Allows Phase 3 to apply texture dynamically based on section.texture\n * - Reduces motif library size (no need for texture-specific accompaniment motifs)\n *\n * ## Arrangement-Specific Rules\n *\n * Different Voice Arrangements have distinct preferences:\n * - **minimal**: Sparse drums (earlySparseMeasures: 2), low accompaniment density (0.5)\n * - **breakLayered**: Prefers \"breakbeat\" drums, avoids \"four_on_floor\", high density (0.95)\n * - **lofiPadLead**: Prefers \"lofi\" tags, \"swing_hint\", sustained accompaniment, soft velocity (0.7)\n *\n * These rules are encoded in ARRANGEMENT_DRUM_RULES and ARRANGEMENT_ACCOMP_RULES.\n *\n * ## Velocity Architecture\n *\n * Velocity (volume) is calculated hierarchically:\n * 1. Base velocity from texture/role (e.g., broken bass: 74, steady bass: 70)\n * 2. Accent boosts (downbeat: +6, strong beat: +3)\n * 3. Arrangement-specific scaling (minimal: 0.8×, breakLayered: 1.05×)\n * 4. Channel-specific adjustments in Phase 3 (bass: 0.7×, triangle: 0.75×)\n *\n * This multi-stage design keeps concerns separated while allowing cumulative adjustments.\n */\n\nimport {\n  AbstractNote,\n  PipelineCompositionOptions,\n  StructurePlanResult,\n  MotifSelectionResult,\n  MidiNote,\n  SectionDefinition,\n  SectionMotifPlan,\n  MelodyRhythmMotif,\n  MelodyRhythmStep,\n  RhythmMotif,\n  BassPatternMotif,\n  TransitionMotif,\n  TextureProfile,\n  DrumHit,\n  StyleIntent,\n  MoodSetting,\n  TempoSetting,\n  StylePreset,\n  VoiceArrangementPreset\n} from \"../types.js\";\nimport {\n  BEATS_PER_MEASURE,\n  chordRootToMidi,\n  ensureConsonantPitch,\n  generateDrumHitsFromPattern,\n  quantizeMidiToChord,\n  resolveChordAtBeat,\n  scaleDegreeToMidi\n} from \"../musicUtils.js\";\nimport {\n  VELOCITY_BASS_TEXTURE,\n  VELOCITY_BASS_ACCENT,\n  VELOCITY_MELODY,\n  VELOCITY_ACCOMPANIMENT\n} from \"../constants/velocity-config.js\";\nimport {\n  getPhraseLengthForSection,\n  establishesHook,\n  repriseHook\n} from \"./structure-planning.js\";\nimport rhythmMotifsJson from \"../../motifs/rhythm.json\" with { type: \"json\" };\nimport melodyFragmentsJson from \"../../motifs/melody.json\" with { type: \"json\" };\nimport melodyRhythmsJson from \"../../motifs/melody-rhythm.json\" with { type: \"json\" };\nimport drumPatternsJson from \"../../motifs/drums.json\" with { type: \"json\" };\nimport bassPatternsJson from \"../../motifs/bass-patterns.json\" with { type: \"json\" };\nimport transitionsJson from \"../../motifs/transitions.json\" with { type: \"json\" };\n\nconst rhythmMotifs = rhythmMotifsJson;\nconst melodyFragments = melodyFragmentsJson;\nconst melodyRhythms = melodyRhythmsJson;\nconst drumPatterns = drumPatternsJson;\nconst bassPatternLibrary = bassPatternsJson;\nconst transitionPatternLibrary = transitionsJson;\n\nconst rhythmList = rhythmMotifs as any as {\n  id: string;\n  length: number;\n  pattern: number[];\n  tags: string[];\n  variations: string[];\n}[];\nconst melodyList = melodyFragments as any as {\n  id: string;\n  pattern: number[];\n  tags: string[];\n}[];\nconst melodyById = new Map(melodyList.map((fragment) => [fragment.id, fragment]));\nconst melodyRhythmList = melodyRhythms as MelodyRhythmMotif[];\nconst melodyRhythmById = new Map(melodyRhythmList.map((motif) => [motif.id, motif]));\nconst drumList = drumPatterns as any as {\n  id: string;\n  length_beats: number;\n  type: \"beat\" | \"fill\";\n  pattern: string;\n  tags?: string[];\n}[];\nconst drumById = new Map(drumList.map((pattern) => [pattern.id, pattern]));\nconst bassPatternList = (bassPatternLibrary.patterns ?? []) as BassPatternMotif[];\nconst bassPatternsByTexture = bassPatternList.reduce<Map<string, BassPatternMotif[]>>((acc, motif) => {\n  const list = acc.get(motif.texture) ?? [];\n  list.push(motif);\n  acc.set(motif.texture, list);\n  return acc;\n}, new Map());\nconst transitionList = (transitionPatternLibrary.transitions ?? []) as TransitionMotif[];\nconst DEFAULT_BASS_STEPS: BassPatternMotif[\"steps\"] = [\n  \"root\",\n  \"root\",\n  \"fifth\",\n  \"root\",\n  \"fifth\",\n  \"root\",\n  \"fifth\",\n  \"approach\"\n];\nconst FALLBACK_BASS_PATTERN: BassPatternMotif = {\n  id: \"BP_FALLBACK_STEADY\",\n  texture: \"steady\",\n  steps: DEFAULT_BASS_STEPS,\n  tags: [\"fallback\"]\n};\n\n/**\n * Mood-based rhythm property tags for motif filtering.\n *\n * These tags define the rhythmic \"feel\" appropriate for each mood:\n * - upbeat: Prefers \"straight\" for accessibility, allows \"syncopation\" for interest\n * - sad: Favors \"straight\" and \"simple\" to avoid excessive energy\n * - tense: Uses \"syncopation\" and \"accented\" for rhythmic tension\n * - peaceful: Prefers \"straight\" and \"open\" (sparse) for calm atmosphere\n *\n * The tag order represents priority (first = preferred). Selection algorithm\n * filters motifs by these tags first, then falls back if the pool is exhausted.\n */\nconst RHYTHM_PROPERTY_TAGS: Record<PipelineCompositionOptions[\"mood\"], string[]> = {\n  upbeat: [\"straight\", \"syncopation\"],\n  sad: [\"straight\", \"simple\"],\n  tense: [\"syncopation\", \"accented\"],\n  peaceful: [\"straight\", \"open\"]\n};\n\n/**\n * Mood-based melody contour tags for scale-degree motif selection.\n *\n * These tags define melodic shape and register preferences:\n * - upbeat: \"bright\" (major-key feel), \"ascending\" (uplifting motion)\n * - sad: \"dark\" (minor-key feel), \"descending\" (falling motion)\n * - tense: \"complex\" (non-scalar leaps), \"leaping\" (wide intervals for drama)\n * - peaceful: \"simple\" (stepwise motion), \"arch\" (gentle rise-fall), \"bright\"\n *\n * Tags come from the melody.json motif library and were hand-curated for each motif.\n */\nconst MELODY_MOOD_TAGS: Record<PipelineCompositionOptions[\"mood\"], string[]> = {\n  upbeat: [\"bright\", \"ascending\"],\n  sad: [\"dark\", \"descending\"],\n  tense: [\"dark\", \"complex\", \"leaping\"],\n  peaceful: [\"simple\", \"arch\", \"bright\"]\n};\n\n/**\n * Mood-based tags for melody-rhythm motif selection.\n *\n * These tags control the rhythmic articulation and phrasing:\n * - upbeat: \"syncopated\" (off-beat accents), \"drive\" (forward momentum)\n * - sad: \"legato\" (sustained notes), \"rest_heavy\" (breathing space)\n * - tense: \"syncopated\" (rhythmic instability), \"staccato\" (short, sharp notes)\n * - peaceful: \"legato\" (smooth connection), \"simple\" (uncomplicated rhythms)\n *\n * Melody-rhythm motifs combine pitch and duration, so these tags affect both\n * melodic contour and rhythmic feel simultaneously.\n */\nconst MELODY_RHYTHM_TAGS: Record<PipelineCompositionOptions[\"mood\"], string[]> = {\n  upbeat: [\"syncopated\", \"drive\"],\n  sad: [\"legato\", \"rest_heavy\"],\n  tense: [\"syncopated\", \"staccato\"],\n  peaceful: [\"legato\", \"simple\"]\n};\n\nconst rhythmById = new Map(rhythmList.map((motif) => [motif.id, motif]));\n\n/**\n * Arrangement-specific drum pattern preferences.\n *\n * Each Voice Arrangement has distinct drum aesthetics that match its musical character:\n *\n * - **dualBass**: Heavy bass-focused arrangements benefit from \"percussive_layer\" drums\n *   (kick + snare layering) and \"syncopation\" for rhythmic interest. Fills should \"build\"\n *   energy to complement the thick low-end.\n *\n * - **bassLed**: Bass is the lead voice, so drums should provide \"drive\" with \"four_on_floor\"\n *   consistency. Use \"earlySparseMeasures: 1\" to let the bass establish itself before drums enter.\n *\n * - **layeredBass**: Two bass layers (square + triangle) require drum patterns that don't\n *   compete. Prefer \"loop_safe\" (minimal variation) and \"four_on_floor\" (predictable pulse).\n *\n * - **minimal**: Techno-inspired minimalism needs \"simple\" drums with \"open\" space. Avoid\n *   \"build\" and \"drive\" tags (too busy). Use \"noise_fx\" fills. \"earlySparseMeasures: 2\"\n *   creates slow-building intro.\n *\n * - **breakLayered**: Breakbeat/jungle style demands \"breakbeat\" rhythms (syncopated kick/snare),\n *   \"percussive_layer\", and \"grid16\" (16th note hi-hats). Explicitly avoid \"four_on_floor\".\n *\n * - **lofiPadLead**: Lo-fi aesthetic prefers \"lofi\" drums (imperfect, laid-back), \"rest_heavy\"\n *   (breathing space), and \"swing_hint\" (humanized timing). Avoid aggressive \"breakbeat\".\n *\n * - **retroPulse**: Retro synth-wave style uses \"loop_safe\" (repetitive by design), \"grid16\"\n *   (crisp hi-hats), and \"syncopation\" for pulse arpeggios. Fills should \"build\" tension.\n *\n * The earlySparseMeasures parameter delays full drum introduction, allowing other voices to\n * establish the musical context first (common in bass-led or ambient arrangements).\n */\nconst ARRANGEMENT_DRUM_RULES: Partial<Record<VoiceArrangementPreset, {\n  preferBeatTags?: string[];\n  preferFillTags?: string[];\n  avoidTags?: string[];\n  earlySparseMeasures?: number;\n}>> = {\n  dualBass: {\n    preferBeatTags: [\"percussive_layer\", \"syncopation\"],\n    preferFillTags: [\"drum_fill\", \"build\"]\n  },\n  bassLed: {\n    preferBeatTags: [\"four_on_floor\", \"drive\"],\n    preferFillTags: [\"build\"],\n    earlySparseMeasures: 1\n  },\n  layeredBass: {\n    preferBeatTags: [\"four_on_floor\", \"loop_safe\"],\n    preferFillTags: [\"drum_fill\"]\n  },\n  minimal: {\n    preferBeatTags: [\"simple\", \"open\"],\n    preferFillTags: [\"noise_fx\"],\n    avoidTags: [\"build\", \"drive\"],\n    earlySparseMeasures: 2\n  },\n  breakLayered: {\n    preferBeatTags: [\"breakbeat\", \"percussive_layer\", \"grid16\"],\n    preferFillTags: [\"break\", \"drum_fill\", \"breakbeat\"],\n    avoidTags: [\"four_on_floor\"]\n  },\n  lofiPadLead: {\n    preferBeatTags: [\"lofi\", \"rest_heavy\", \"swing_hint\"],\n    preferFillTags: [\"noise_fx\", \"lofi\"],\n    avoidTags: [\"breakbeat\"],\n    earlySparseMeasures: 2\n  },\n  retroPulse: {\n    preferBeatTags: [\"loop_safe\", \"grid16\", \"syncopation\"],\n    preferFillTags: [\"build\", \"transition\"],\n    avoidTags: [\"rest_heavy\"]\n  }\n};\n\n/**\n * Arrangement-specific accompaniment generation rules.\n *\n * Accompaniment (harmony/pad layer) must adapt to each arrangement's voice balance:\n *\n * - **density**: Probability that a beat gets an accompaniment chord (0.0-1.0)\n *   - High density (0.95): breakLayered - fills space with aggressive harmony\n *   - Medium density (0.75-0.85): dualBass, layeredBass - balanced support\n *   - Low density (0.5-0.6): minimal, lofiPadLead - sparse, ambient pads\n *\n * - **sustainWholeMeasure**: If true, generates whole-note chords (sustained pads)\n *   rather than beat-by-beat seeds. Used for minimal and lofiPadLead to create\n *   atmospheric texture without rhythmic competition.\n *\n * - **velocityScale**: Multiplier applied to base accompaniment velocity\n *   - >1.0 (breakLayered: 1.05): Emphasize harmony in dense arrangements\n *   - <1.0 (minimal: 0.8, lofiPadLead: 0.7): Soften pads to background role\n *\n * - **offbeatAccentBoost**: Extra velocity (+dB) for off-beat chord hits\n *   - High boost (breakLayered: 6, bassLed: 5): Syncopated harmony accents\n *   - Low boost (retroPulse: 2, dualBass: 3): Subtle off-beat emphasis\n *   - No boost (minimal, lofiPadLead): Sustained pads have no rhythmic accents\n *\n * These parameters interact with Phase 3's texture expansion (arpeggio/broken/steady)\n * and Phase 4's gain automation to create the final accompaniment character.\n */\nconst ARRANGEMENT_ACCOMP_RULES: Partial<Record<VoiceArrangementPreset, {\n  density: number;\n  sustainWholeMeasure?: boolean;\n  velocityScale?: number;\n  offbeatAccentBoost?: number;\n}>> = {\n  dualBass: {\n    density: 0.85,\n    velocityScale: 0.9,\n    offbeatAccentBoost: 3\n  },\n  bassLed: {\n    density: 0.6,\n    sustainWholeMeasure: false,\n    offbeatAccentBoost: 5\n  },\n  layeredBass: {\n    density: 0.75,\n    velocityScale: 0.95\n  },\n  minimal: {\n    density: 0.5,\n    sustainWholeMeasure: true,\n    velocityScale: 0.8\n  },\n  breakLayered: {\n    density: 0.95,\n    velocityScale: 1.05,\n    offbeatAccentBoost: 6\n  },\n  lofiPadLead: {\n    density: 0.55,\n    sustainWholeMeasure: true,\n    velocityScale: 0.7\n  },\n  retroPulse: {\n    density: 0.78,\n    velocityScale: 0.95,\n    offbeatAccentBoost: 2\n  }\n};\n\n/**\n * Filters candidates by tag presence, with fallback to prevent over-filtering.\n *\n * This is the core tag-based filtering strategy used throughout motif selection.\n * It attempts to narrow candidates to those matching desired tags, but falls back\n * to the full pool if filtering would exhaust diversity.\n *\n * ## Why Fallback Logic?\n *\n * Without fallback, multiple sequential filters can reduce the candidate pool to\n * just 1-2 motifs, causing:\n * - Excessive repetition (same motif every section)\n * - Ignoring other important constraints (e.g., functional tags like \"start\"/\"end\")\n * - Brittle behavior when motif library is small or tags are sparse\n *\n * ## Fallback Conditions\n *\n * Returns original pool if:\n * 1. No matching candidates found (matched.length === 0)\n * 2. Filtering reduces pool below minRatio threshold (default 40%)\n *    - Only applies if original pool has ≥4 candidates (small pools aren't filtered)\n *\n * @param candidates - Original candidate pool\n * @param tags - Desired tags (ANY match accepted, not ALL)\n * @param minRatio - Minimum ratio of matched/original to avoid fallback (default 0.4)\n * @returns Filtered candidates, or original pool if fallback triggered\n */\nfunction preferTagPresence<T extends { tags?: string[] }>(\n  candidates: T[],\n  tags: string[],\n  minRatio: number = 0.4\n): T[] {\n  if (!tags.length) {\n    return candidates;\n  }\n  const matched = candidates.filter((candidate) => {\n    const sourceTags = candidate.tags ?? [];\n    return tags.some((tag) => sourceTags.includes(tag));\n  });\n\n  // If filtering reduces pool too much (below minRatio), keep original pool\n  // This prevents over-filtering that causes excessive motif repetition\n  if (matched.length === 0) {\n    return candidates;\n  }\n  if (candidates.length >= 4 && matched.length < candidates.length * minRatio) {\n    return candidates;\n  }\n\n  return matched;\n}\n\nfunction shuffleWithRng<T>(items: T[], rng: () => number): T[] {\n  const copy = [...items];\n  for (let i = copy.length - 1; i > 0; i--) {\n    const j = Math.floor(rng() * (i + 1));\n    const temp = copy[i];\n    copy[i] = copy[j];\n    copy[j] = temp;\n  }\n  return copy;\n}\n\n/**\n * Reorders candidates to bias selection toward tag-matched items without hard filtering.\n *\n * Unlike preferTagPresence (which filters out non-matching), this function keeps all\n * candidates but rearranges them to make tagged items appear first. This is used for\n * \"soft preference\" where tags guide selection but don't enforce hard constraints.\n *\n * ## Why Biasing Instead of Filtering?\n *\n * Some style preferences should influence but not mandate motif choice:\n * - harmonicStatic prefers \"scalar\"/\"stepwise\" melodies but can accept \"leaping\" if needed\n * - gradualBuild prefers \"ascending\" contours but can use \"arch\" or \"mixed\"\n *\n * Hard filtering (preferTagPresence) would eliminate valid alternatives, while biasing\n * increases the probability of preferred tags without removing fallback options.\n *\n * ## Algorithm\n *\n * 1. Partition candidates into matches (have desired tags) and others (don't have tags)\n * 2. Shuffle each partition independently (for seed-driven variety within each group)\n * 3. Take targetRatio (default 60%) of matches and place them first\n * 4. Append remaining matches and all others\n *\n * Result: Random selection from biased array will pick matches ~60% of the time,\n * others ~40% of the time (assuming equal partition sizes).\n *\n * @param candidates - Original candidate pool\n * @param tags - Desired tags (ANY match)\n * @param rng - Seeded random number generator\n * @param targetRatio - Desired proportion of matches in prioritized group (default 0.6)\n * @returns Reordered candidates with matches biased toward front\n */\nfunction biasByTagPresence<T extends { tags?: string[] }>(\n  candidates: T[],\n  tags: string[],\n  rng: () => number,\n  targetRatio = 0.6\n): T[] {\n  if (!tags.length || candidates.length <= 1) {\n    return candidates;\n  }\n  const matches = candidates.filter((candidate) => {\n    const sourceTags = candidate.tags ?? [];\n    return tags.some((tag) => sourceTags.includes(tag));\n  });\n  if (!matches.length || matches.length === candidates.length) {\n    return candidates;\n  }\n  const others = candidates.filter((candidate) => !matches.includes(candidate));\n  const shuffledMatches = shuffleWithRng(matches, rng);\n  const shuffledOthers = shuffleWithRng(others, rng);\n  const desiredMatchCount = Math.min(\n    shuffledMatches.length,\n    Math.max(1, Math.ceil(candidates.length * targetRatio))\n  );\n  const prioritizedMatches = shuffledMatches.slice(0, desiredMatchCount);\n  const remainder = [...shuffledMatches.slice(desiredMatchCount), ...shuffledOthers];\n  return [...prioritizedMatches, ...remainder];\n}\n\nconst RNG_SEED = 1337;\n\nfunction createRng(seed: number | undefined): () => number {\n  let state = (seed ?? RNG_SEED) >>> 0;\n  if (state === 0) {\n    state = RNG_SEED;\n  }\n  return () => {\n    state = (state * 1664525 + 1013904223) >>> 0;\n    return state / 0xffffffff;\n  };\n}\n\nfunction pickWithAvoid<T extends { id?: string }>(\n  candidates: T[],\n  rng: () => number,\n  avoidId?: string\n): T {\n  if (!candidates.length) {\n    throw new Error(\"No candidates available for selection\");\n  }\n  if (candidates.length === 1) {\n    return candidates[0];\n  }\n  let choice = candidates[Math.floor(rng() * candidates.length)];\n  if (avoidId && candidates.length > 1) {\n    let attempts = 0;\n    while (choice?.id === avoidId && attempts < 3) {\n      choice = candidates[Math.floor(rng() * candidates.length)];\n      attempts++;\n    }\n  }\n  return choice;\n}\n\nfunction hasAllTags(source: { tags: string[] }, tags: string[]): boolean {\n  if (!tags.length) {\n    return true;\n  }\n  return tags.every((tag) => source.tags.includes(tag));\n}\n\nfunction isStrongBeat(beat: number): boolean {\n  const epsilon = 1e-6;\n  return Math.abs(beat % 1) < epsilon;\n}\n\nfunction findMelodyReference(\n  beat: number,\n  melody: MidiNote[]\n): MidiNote | undefined {\n  return melody.find((note) => beat >= note.startBeat && beat < note.startBeat + note.durationBeats);\n}\n\nfunction functionalTagForMeasure(measure: number, totalMeasures: number): string {\n  if (measure === 0) return \"start\";\n  if (measure === totalMeasures - 1) return \"end\";\n  return \"middle\";\n}\n\nfunction isRhythmMotifConsistent(motif: RhythmMotif): boolean {\n  try {\n    expandRhythmPattern(motif);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nfunction selectRhythmMotif(\n  options: PipelineCompositionOptions,\n  styleIntent: StyleIntent,\n  functionTag: string,\n  last: (typeof rhythmList)[number] | undefined,\n  requiredTags: string[],\n  rng: () => number,\n  used: Set<string>\n) {\n  const safeRhythms = rhythmList.filter(isRhythmMotifConsistent);\n  const propertyTags = RHYTHM_PROPERTY_TAGS[options.mood] ?? [];\n  const filterByTags = (source: typeof rhythmList, tags: string[]) =>\n    source.filter((motif) => tags.some((tag) => motif.tags.includes(tag)));\n\n  const requiredPool = safeRhythms.filter((motif) => hasAllTags(motif, requiredTags));\n  let candidates = safeRhythms.filter((motif) => motif.tags.includes(functionTag));\n  const propertyFiltered = filterByTags(candidates, propertyTags);\n  if (propertyFiltered.length) {\n    candidates = propertyFiltered;\n  } else {\n    const fallback = filterByTags(safeRhythms, propertyTags);\n    if (fallback.length) {\n      candidates = fallback;\n    }\n  }\n\n  if (styleIntent.loopCentric) {\n    candidates = preferTagPresence(candidates, [\"loop_safe\", \"texture_loop\"]);\n  }\n\n  if (styleIntent.textureFocus) {\n    candidates = preferTagPresence(candidates, [\"texture_loop\", \"straight\", \"simple\", \"grid16\"]);\n  }\n\n  if (styleIntent.percussiveLayering) {\n    candidates = preferTagPresence(candidates, [\"grid16\", \"percussive_layer\"]);\n  }\n\n  if (styleIntent.syncopationBias) {\n    candidates = preferTagPresence(candidates, [\"syncopation\"]);\n  }\n  if (!candidates.length) {\n    candidates = safeRhythms;\n  }\n\n  if (requiredTags.length) {\n    const requiredFiltered = candidates.filter((motif) => hasAllTags(motif, requiredTags));\n    if (requiredFiltered.length) {\n      candidates = requiredFiltered;\n    } else if (requiredPool.length) {\n      candidates = requiredPool;\n    }\n  }\n\n  if (last?.variations?.length) {\n    const variationCandidates = last.variations\n      .map((id) => rhythmById.get(id))\n      .filter((motif): motif is (typeof rhythmList)[number] => Boolean(motif));\n    if (variationCandidates.length && rng() < 0.5) {\n      const variationPool = preferUnused(variationCandidates, used);\n      return pickWithAvoid(variationPool, rng, last.id);\n    }\n  }\n  const pool = preferUnused(candidates, used);\n  return pickWithAvoid(pool, rng, last?.id);\n}\n\nfunction selectMelodyFragment(\n  options: PipelineCompositionOptions,\n  styleIntent: StyleIntent,\n  requiredTags: string[],\n  rng: () => number,\n  lastFragment: (typeof melodyList)[number] | undefined,\n  used: Set<string>\n): (typeof melodyList)[number] {\n  const moodTags = MELODY_MOOD_TAGS[options.mood] ?? [];\n  let candidates = melodyList.filter((fragment) => moodTags.some((tag) => fragment.tags.includes(tag)));\n  if (requiredTags.length) {\n    const requiredFiltered = candidates.filter((fragment) => hasAllTags(fragment, requiredTags));\n    if (requiredFiltered.length) {\n      candidates = requiredFiltered;\n    } else {\n      const globalFallback = melodyList.filter((fragment) => hasAllTags(fragment, requiredTags));\n      if (globalFallback.length) {\n        candidates = globalFallback;\n      }\n    }\n  }\n  if (!candidates.length) {\n    candidates = melodyList;\n  }\n\n  if (styleIntent.textureFocus) {\n    candidates = preferTagPresence(candidates, [\"texture_loop\", \"ostinato\", \"loop_safe\", \"short\", \"static\"]);\n  }\n\n  if (styleIntent.harmonicStatic) {\n    candidates = biasByTagPresence(candidates, [\"scalar\", \"stepwise\", \"static\"], rng, 0.6);\n  }\n\n  if (styleIntent.gradualBuild) {\n    candidates = preferTagPresence(candidates, [\"ascending\"]);\n  }\n\n  const pool = preferUnused(candidates, used);\n  return pickWithAvoid(pool, rng, lastFragment?.id);\n}\n\nfunction selectMelodyRhythmMotif(\n  options: PipelineCompositionOptions,\n  styleIntent: StyleIntent,\n  functionTag: string,\n  totalBeats: number,\n  requiredTags: string[],\n  rng: () => number,\n  lastId: string | undefined,\n  used: Set<string>\n): MelodyRhythmMotif {\n  const tolerance = 1e-6;\n  const moodTags = MELODY_RHYTHM_TAGS[options.mood] ?? [];\n  let candidates = melodyRhythmList.filter((motif) => Math.abs(motif.length - totalBeats) < tolerance);\n  if (!candidates.length) {\n    throw new Error(`No melody rhythm motifs of length ${totalBeats}`);\n  }\n  let filtered = candidates.filter((motif) => motif.tags.includes(functionTag));\n  if (!filtered.length) {\n    filtered = candidates;\n  }\n  let moodFiltered = filtered.filter((motif) => moodTags.some((tag) => motif.tags.includes(tag)));\n  if (!moodFiltered.length) {\n    moodFiltered = filtered;\n  }\n\n  if (styleIntent.loopCentric) {\n    moodFiltered = preferTagPresence(moodFiltered, [\"loop_safe\", \"texture_loop\"]);\n  }\n\n  if (styleIntent.textureFocus) {\n    moodFiltered = preferTagPresence(moodFiltered, [\"texture_loop\", \"grid16\", \"simple\"]);\n  }\n\n  if (styleIntent.syncopationBias) {\n    moodFiltered = preferTagPresence(moodFiltered, [\"syncopated\", \"drive\"]);\n  }\n\n  if (requiredTags.length) {\n    const requiredFiltered = moodFiltered.filter((motif) => hasAllTags(motif, requiredTags));\n    if (requiredFiltered.length) {\n      moodFiltered = requiredFiltered;\n    }\n  }\n\n  moodFiltered = filterHumanizedMelodyRhythms(moodFiltered, totalBeats);\n\n  const pool = preferUnused(moodFiltered, used);\n  return pickWithAvoid(pool, rng, lastId);\n}\n\nfunction resolveMelodyVelocity(\n  section: StructurePlanResult[\"sections\"][number],\n  measureInSection: number,\n  globalMeasureIndex: number,\n  totalMeasures: number,\n  styleIntent: StyleIntent\n): number {\n  const baseByTexture: Record<string, number> = {\n    broken: 90,\n    steady: 86,\n    arpeggio: 92\n  };\n  let base = baseByTexture[section.texture] ?? 88;\n  const downbeatBoost = measureInSection === 0 ? 6 : 0;\n  const cadenceLift = section.measures - measureInSection <= 1 ? 4 : 0;\n  if (styleIntent.textureFocus) {\n    base -= 8;\n  }\n  if (styleIntent.gradualBuild) {\n    // Global progressive build: velocity increases across entire track\n    const globalProgress = totalMeasures > 1 ? globalMeasureIndex / Math.max(1, totalMeasures - 1) : 0;\n    const clamped = Math.min(1, Math.max(0, globalProgress));\n    const exponent = totalMeasures <= 16 ? 0.6 : totalMeasures <= 32 ? 0.75 : 0.9;\n    const shaped = Math.pow(clamped, exponent);\n    const maxBoost = totalMeasures <= 16 ? 14 : totalMeasures <= 32 ? 18 : 20;\n    const buildAmount = Math.floor(shaped * maxBoost);\n    base += buildAmount;\n  }\n  if (styleIntent.loopCentric) {\n    base = Math.max(60, base - 2);\n  }\n  return Math.min(110, Math.max(58, base + downbeatBoost + cadenceLift));\n}\n\n/**\n * Determines the base register (MIDI note) for the entire composition based on mood, tempo, and seed.\n * This adds variation so that different songs use different octave ranges, enhancing diversity.\n * \n * @param mood - The mood setting (upbeat, peaceful, tense, sad)\n * @param tempo - The tempo setting (slow, medium, fast)\n * @param seed - Random seed for deterministic variation\n * @returns Base MIDI register for the composition (typically 63-78, Eb4-F#5)\n */\nfunction resolveBaseRegisterForComposition(\n  mood: MoodSetting,\n  tempo: TempoSetting,\n  stylePreset: StylePreset | undefined,\n  styleIntent: StyleIntent,\n  seed: number\n): number {\n  const DEFAULT_REGISTER = 72; // C5\n\n  // Mood-based offsets: different moods naturally sit in different registers\n  const moodBaseOffsets: Record<MoodSetting, number> = {\n    upbeat: 0,      // Bright → standard to high (C5 base)\n    peaceful: -3,   // Peaceful → slightly lower (A4 base)\n    tense: -5,      // Tense → lower (G4 base, heavier feel)\n    sad: -2         // Sad → slightly lower (Bb4 base)\n  };\n\n  // Tempo-based offsets: faster tempos benefit from higher registers\n  const tempoOffsets: Record<TempoSetting, number> = {\n    slow: -2,       // Slow → lower\n    medium: 0,      // Standard\n    fast: 2         // Fast → higher (lighter, more agile)\n  };\n\n  const presetOffsets: Partial<Record<StylePreset, number>> = {\n    minimalTechno: -4,\n    progressiveHouse: 3,\n    retroLoopwave: 2,\n    breakbeatJungle: -2,\n    lofiChillhop: -5\n  };\n\n  const intentAdjustments =\n    (styleIntent.textureFocus ? 2 : 0) +\n    (styleIntent.gradualBuild ? 1 : 0) +\n    (styleIntent.loopCentric ? -1 : 0) +\n    (styleIntent.atmosPad ? 2 : 0) +\n    (styleIntent.percussiveLayering ? -2 : 0);\n\n  const moodOffset = moodBaseOffsets[mood] ?? 0;\n  const tempoOffset = tempoOffsets[tempo] ?? 0;\n  const presetOffset = stylePreset ? (presetOffsets[stylePreset] ?? 0) : 0;\n\n  // Add random variation ±3 semitones for song-to-song diversity\n  const rng = createRng(seed);\n  const randomVariation = Math.floor(rng() * 7) - 3; // -3 to +3\n\n  const baseRegister =\n    DEFAULT_REGISTER +\n    moodOffset +\n    tempoOffset +\n    presetOffset +\n    intentAdjustments +\n    randomVariation;\n\n  // Clamp to practical chiptune melody range: MIDI 63-78 (Eb4-F#5)\n  return Math.max(63, Math.min(78, baseRegister));\n}\n\nfunction resolveMelodyRegister(\n  section: SectionDefinition | undefined,\n  measureInSection: number,\n  globalMeasureIndex: number,\n  totalMeasures: number,\n  styleIntent: StyleIntent,\n  compositionBaseRegister: number  // New parameter: base register for this composition\n): number {\n  // Use composition-specific base register instead of fixed DEFAULT_REGISTER\n  if (!section) {\n    return compositionBaseRegister;\n  }\n\n  const textureOffsets: Record<SectionDefinition[\"texture\"], number> = {\n    steady: 0,\n    broken: -3,\n    arpeggio: 4\n  };\n\n  const clampedMeasure = Math.max(0, measureInSection);\n  let offset = textureOffsets[section.texture] ?? 0;\n\n  if (styleIntent.textureFocus) {\n    offset -= 4;\n  }\n\n  if (styleIntent.filterMotion) {\n    offset += 1;\n  }\n\n  if (establishesHook(section) && clampedMeasure === 0) {\n    offset += 3;\n  }\n  if (repriseHook(section) && clampedMeasure === 0) {\n    offset -= 2;\n  }\n\n  if (styleIntent.gradualBuild) {\n    // Global progressive build: register rises across entire track\n    const globalProgress = globalMeasureIndex / Math.max(1, totalMeasures - 1);\n    const buildAmount = Math.round(Math.pow(globalProgress, 0.7) * 8);\n    offset += buildAmount;\n  }\n\n  const phraseProgress = section.measures > 0 ? clampedMeasure / section.measures : 0;\n  if (phraseProgress >= 0.75) {\n    offset -= 2;\n  }\n\n  const occurrenceDrop = Math.min(section.occurrenceIndex - 1, 2) * 2;\n  offset -= occurrenceDrop;\n\n  if (styleIntent.atmosPad) {\n    offset -= 1;\n  }\n\n  const MIN_REGISTER = 60;\n  const MAX_REGISTER = 84;\n  const resolved = compositionBaseRegister + offset;  // Use composition base register\n  return Math.max(MIN_REGISTER, Math.min(MAX_REGISTER, resolved));\n}\n\nfunction maybeAddPickupNote(\n  melody: AbstractNote[],\n  measureStartBeat: number,\n  baseMelody: (typeof melodyList)[number],\n  sectionId: string\n) {\n  if (measureStartBeat <= 0) {\n    return;\n  }\n  const pickupStart = measureStartBeat - 0.25;\n  if (pickupStart < 0) {\n    return;\n  }\n  const pattern = baseMelody.pattern;\n  const degree = pattern[pattern.length - 1] ?? pattern[0] ?? 1;\n  melody.push({\n    channelRole: \"melody\",\n    startBeat: pickupStart,\n    durationBeats: 0.25,\n    degree,\n    velocity: VELOCITY_MELODY.PICKUP_BASE,\n    sectionId\n  });\n}\n\nfunction resolveTailDegreeVariant(\n  baseDegree: number,\n  melodyPattern: number[],\n  styleIntent: StyleIntent,\n  rng: () => number\n): number {\n  if (!melodyPattern.length) {\n    return baseDegree;\n  }\n  const tailDegrees = [melodyPattern[melodyPattern.length - 1]];\n  const neighbor = tailDegrees[0] + (styleIntent.textureFocus ? 2 : 1);\n  const fall = tailDegrees[0] - (styleIntent.loopCentric ? 1 : 2);\n  const options = new Set<number>([baseDegree, tailDegrees[0], neighbor, fall]);\n  const ordered = Array.from(options);\n  return ordered[Math.floor(rng() * ordered.length)];\n}\n\nfunction pickRhythmVariation(\n  base: (typeof rhythmList)[number],\n  functionTag: string,\n  requiredTags: string[],\n  rng: () => number,\n  used: Set<string>\n): (typeof rhythmList)[number] | undefined {\n  const variationIds = base.variations ?? [];\n  if (!variationIds.length) {\n    return undefined;\n  }\n  const variations = variationIds\n    .map((id) => rhythmById.get(id))\n    .filter((motif): motif is (typeof rhythmList)[number] => Boolean(motif))\n    .filter((motif) => motif.tags.includes(functionTag) && hasAllTags(motif, requiredTags));\n  if (!variations.length) {\n    return undefined;\n  }\n  const pool = preferUnused(variations, used);\n  return pickWithAvoid(pool, rng, base.id);\n}\n\ntype BassStep = \"root\" | \"fifth\" | \"lowFifth\" | \"octave\" | \"octaveHigh\" | \"approach\" | \"rest\";\n\nfunction buildBassPattern(\n  section: StructurePlanResult[\"sections\"][number],\n  measureStartBeat: number,\n  chord: string,\n  nextChord: string,\n  motif: BassPatternMotif\n): Array<AbstractNote & { midiOverride: number }> {\n  const steps = motif.steps?.length ? motif.steps : DEFAULT_BASS_STEPS;\n  const notes: Array<AbstractNote & { midiOverride: number }> = [];\n  const baseMidi = chordRootToMidi(chord, 40);\n  const nextChordName = nextChord ?? chord;\n\n  for (let step = 0; step < steps.length; step++) {\n    const startBeat = measureStartBeat + step * 0.5;\n    const midi = bassStepToMidi(steps[step], chord, nextChordName, baseMidi);\n\n    // Skip rest steps\n    if (midi === null) {\n      continue;\n    }\n\n    notes.push({\n      channelRole: \"bass\",\n      startBeat,\n      durationBeats: 0.5,\n      degree: 0,\n      velocity: resolveBassVelocity(section, step),\n      sectionId: section.id,\n      midiOverride: midi\n    });\n  }\n\n  return notes;\n}\n\nfunction resolveBassPattern(\n  section: SectionDefinition,\n  measureInSection: number,\n  rng: () => number,\n  used: Set<string>,\n  cache: Map<string, BassPatternMotif>,\n  styleIntent: StyleIntent,\n  options?: { enforceDroneStatic?: boolean; preferredTags?: string[] }\n): BassPatternMotif {\n  const enforceDroneStatic = options?.enforceDroneStatic ?? true;\n  const preferredTags = options?.preferredTags ?? [];\n  const isFinalMeasure = measureInSection === section.measures - 1;\n  const cached = cache.get(section.id);\n  if (cached) {\n    if (isFinalMeasure && !(cached.tags ?? []).includes(\"section_end\")) {\n      const endPattern = selectBassPattern(\n        section.texture,\n        styleIntent,\n        rng,\n        used,\n        [\"section_end\"],\n        cached.id\n      );\n      if (endPattern) {\n        used.add(endPattern.id);\n        return endPattern;\n      }\n    }\n    return cached;\n  }\n\n  // harmonicStatic: enforce drone bass for minimal techno aesthetic\n  if (styleIntent.harmonicStatic) {\n    if (!enforceDroneStatic && preferredTags.length) {\n      const preferredPattern = selectBassPattern(\n        section.texture,\n        styleIntent,\n        rng,\n        used,\n        preferredTags,\n        undefined\n      );\n      if (preferredPattern) {\n        cache.set(section.id, preferredPattern);\n        used.add(preferredPattern.id);\n        return preferredPattern;\n      }\n    }\n\n    const dronePattern = selectBassPattern(\n      section.texture,\n      styleIntent,\n      rng,\n      used,\n      [\"drone\", \"static\"],\n      undefined\n    );\n    if (dronePattern && enforceDroneStatic) {\n      cache.set(section.id, dronePattern);\n      used.add(dronePattern.id);\n      return dronePattern;\n    }\n  }\n\n  const initialTags = establishesHook(section) ? [\"pickup\"] : [];\n  const basePattern =\n    selectBassPattern(section.texture, styleIntent, rng, used, initialTags, undefined) ??\n    selectBassPattern(section.texture, styleIntent, rng, used, [], undefined) ??\n    FALLBACK_BASS_PATTERN;\n  cache.set(section.id, basePattern);\n  used.add(basePattern.id);\n\n  if (isFinalMeasure && !(basePattern.tags ?? []).includes(\"section_end\")) {\n    const endPattern = selectBassPattern(\n      section.texture,\n      styleIntent,\n      rng,\n      used,\n      [\"section_end\"],\n      basePattern.id\n    );\n    if (endPattern) {\n      used.add(endPattern.id);\n      return endPattern;\n    }\n  }\n\n  return basePattern;\n}\n\nfunction selectBassPattern(\n  texture: TextureProfile,\n  styleIntent: StyleIntent,\n  rng: () => number,\n  used: Set<string>,\n  requiredTags: string[],\n  avoidId?: string\n): BassPatternMotif | undefined {\n  let candidates = bassPatternsByTexture.get(texture) ?? [];\n  if (!candidates.length && texture !== \"steady\") {\n    candidates = bassPatternsByTexture.get(\"steady\") ?? [];\n  }\n  if (!candidates.length) {\n    return undefined;\n  }\n  if (styleIntent.loopCentric || styleIntent.harmonicStatic) {\n    candidates = preferTagPresence(candidates, [\"loop_safe\"]);\n  }\n  if (styleIntent.syncopationBias) {\n    candidates = preferTagPresence(candidates, [\"syncopated\"]);\n  }\n  if (styleIntent.textureFocus) {\n    candidates = preferTagPresence(candidates, [\"default\"]);\n  }\n  if (styleIntent.percussiveLayering) {\n    candidates = preferTagPresence(candidates, [\"percussive_layer\", \"four_on_floor\"]);\n  }\n  if (styleIntent.percussiveLayering && styleIntent.syncopationBias && styleIntent.breakInsertion) {\n    candidates = preferTagPresence(candidates, [\"breakbeat\", \"variation\"], 0.2);\n  }\n  if (styleIntent.atmosPad && styleIntent.loopCentric) {\n    candidates = preferTagPresence(candidates, [\"lofi\", \"rest_heavy\"], 0.25);\n  }\n  if (styleIntent.harmonicStatic) {\n    candidates = biasByTagPresence(candidates, [\"drone\", \"static\"], rng, 0.65);\n  }\n  if (requiredTags.length) {\n    const tagged = candidates.filter((motif) =>\n      requiredTags.every((tag) => (motif.tags ?? []).includes(tag))\n    );\n    if (tagged.length) {\n      candidates = tagged;\n    }\n  }\n  if (!candidates.length) {\n    return undefined;\n  }\n  const pool = preferUnused(candidates, used);\n  return pickWithAvoid(pool, rng, avoidId);\n}\n\n/**\n * Merges transition drum hits with existing drum hits, avoiding collisions.\n * If a transition hit would collide with an existing hit (within 1/16 beat),\n * it is offset by the minimum safe gap to prevent noise channel conflicts.\n */\nfunction mergeTransitionHits(existingHits: DrumHit[], transitionHits: DrumHit[]): DrumHit[] {\n  const COLLISION_THRESHOLD = 1 / 16; // Same as NOISE_STACK_OFFSET in event-realization.ts\n  const merged: DrumHit[] = [];\n\n  for (const hit of transitionHits) {\n    let adjustedBeat = hit.startBeat;\n    let attempts = 0;\n    const maxAttempts = 4; // Try up to 4 offsets (1/16, 2/16, 3/16, 4/16 beats)\n\n    // Check for collision with existing hits\n    while (attempts < maxAttempts) {\n      const hasCollision = existingHits.some(\n        (existing) => Math.abs(existing.startBeat - adjustedBeat) < COLLISION_THRESHOLD\n      );\n\n      if (!hasCollision) {\n        break; // No collision, use this timing\n      }\n\n      // Collision detected, offset by one step\n      attempts++;\n      adjustedBeat = hit.startBeat + (attempts * COLLISION_THRESHOLD);\n    }\n\n    // Add the hit with adjusted timing (or original if no collision)\n    merged.push({\n      ...hit,\n      startBeat: adjustedBeat\n    });\n  }\n\n  return merged;\n}\n\nfunction maybeGenerateTransition(\n  section: SectionDefinition,\n  measureStartBeat: number,\n  isLastSection: boolean,\n  rng: () => number,\n  lastTransitionId: string | undefined,\n  used: Set<string>,\n  styleIntent: StyleIntent,\n  globalMeasureIndex: number,\n  totalMeasures: number\n): { motifId: string; hits: DrumHit[] } | undefined {\n  if (!transitionList.length) {\n    return undefined;\n  }\n\n  const requiredTags = [\"transition\", \"section_end\"];\n  if (isLastSection) {\n    requiredTags.push(\"loop_out\");\n  }\n\n  let candidates = transitionList.filter((motif) => motif.length_beats <= BEATS_PER_MEASURE);\n  if (!candidates.length) {\n    candidates = transitionList;\n  }\n\n  const progress = totalMeasures > 1 ? globalMeasureIndex / Math.max(1, totalMeasures - 1) : 0;\n  const priorityTags: string[] = [];\n  if (styleIntent.gradualBuild) {\n    if (progress < 0.4) {\n      priorityTags.push(\"build\");\n    } else if (progress < 0.8) {\n      priorityTags.push(\"drum_fill\");\n    } else {\n      priorityTags.push(\"loop_out\");\n    }\n  }\n  if (styleIntent.breakInsertion && progress >= 0.5) {\n    priorityTags.push(\"noise_fx\");\n  }\n  if (styleIntent.percussiveLayering) {\n    priorityTags.push(\"drum_fill\");\n  }\n\n  if (priorityTags.length) {\n    candidates = preferTagPresence(candidates, priorityTags, 0.2);\n  }\n\n  if (requiredTags.length) {\n    const filtered = candidates.filter((motif) => hasAllTags(motif, requiredTags));\n    if (filtered.length) {\n      candidates = filtered;\n    }\n  }\n\n  if (!candidates.length) {\n    return undefined;\n  }\n\n  const pool = preferUnused(candidates, used);\n  const motif = pickWithAvoid(pool, rng, lastTransitionId);\n  if (!motif) {\n    return undefined;\n  }\n\n  const offset =\n    motif.length_beats >= BEATS_PER_MEASURE\n      ? measureStartBeat\n      : measureStartBeat + Math.max(0, BEATS_PER_MEASURE - motif.length_beats);\n  const hits = generateDrumHitsFromPattern(motif.pattern, offset, section.id);\n  return { motifId: motif.id, hits };\n}\n\nfunction resolveBassVelocity(section: StructurePlanResult[\"sections\"][number], step: number): number {\n  const base = (VELOCITY_BASS_TEXTURE as Record<string, number>)[section.texture] ?? VELOCITY_BASS_TEXTURE.default;\n  if (step === 0) {\n    return base + VELOCITY_BASS_ACCENT.DOWNBEAT_BOOST;\n  }\n  if (step % 4 === 0) {\n    return base + VELOCITY_BASS_ACCENT.STRONG_BEAT_BOOST;\n  }\n  return base;\n}\n\nfunction bassStepToMidi(step: BassStep, chord: string, nextChord: string, baseMidi: number): number | null {\n  switch (step) {\n    case \"root\":\n      return quantizeMidiToChord(baseMidi, chord);\n    case \"fifth\":\n      return quantizeMidiToChord(baseMidi + 7, chord);\n    case \"lowFifth\":\n      return quantizeMidiToChord(baseMidi - 5, chord);\n    case \"octave\":\n      return quantizeMidiToChord(baseMidi + 12, chord);\n    case \"octaveHigh\":\n      return quantizeMidiToChord(baseMidi + 19, chord);\n    case \"approach\": {\n      const nextRoot = chordRootToMidi(nextChord, baseMidi + 5);\n      return quantizeMidiToChord(nextRoot - 1, nextChord);\n    }\n    case \"rest\":\n      return null;\n    default:\n      return quantizeMidiToChord(baseMidi, chord);\n  }\n}\n\n/**\n * Expand rhythm motif pattern into beat durations\n * (Similar to expandMelodyRhythmPattern)\n */\ninterface ExpandedRhythmStep {\n  durationBeats: number;\n}\n\nfunction expandRhythmPattern(motif: RhythmMotif): ExpandedRhythmStep[] {\n  const steps: ExpandedRhythmStep[] = motif.pattern.map((value) => ({\n    durationBeats: convertToBeats(value)\n  }));\n\n  // Validate that pattern sum matches declared length\n  const total = steps.reduce((sum, step) => sum + step.durationBeats, 0);\n  const tolerance = 1e-6;\n  if (Math.abs(total - motif.length) > tolerance) {\n    throw new Error(\n      `Rhythm motif ${motif.id} length mismatch. expected=${motif.length}, got=${total}`\n    );\n  }\n\n  return steps;\n}\n\n/**\n * Resolve accompaniment degree based on texture and position\n */\nfunction resolveAccompanimentDegree(\n  texture: TextureProfile,\n  degreeIndex: number,\n  beatInMeasure: number\n): number {\n  if (texture === \"steady\") {\n    // Alternate between root and fifth every 2 beats\n    const chordDegrees = [1, 5];\n    return chordDegrees[Math.floor(beatInMeasure / 2) % chordDegrees.length];\n  } else {\n    // Cycle through chord tones for broken/arpeggio textures\n    const chordDegrees = [1, 3, 5, 7];\n    return chordDegrees[degreeIndex % chordDegrees.length];\n  }\n}\n\n/**\n * Resolve accompaniment velocity with accent on downbeat\n */\nfunction resolveAccompanimentVelocity(\n  functionTag: string,\n  beatInMeasure: number\n): number {\n  const baseVelocity = 58;\n  const accent = functionTag === \"start\" && beatInMeasure === 0 ? 6 : 0;\n  return baseVelocity + accent;\n}\n\nfunction buildAccompanimentSeeds(\n  section: StructurePlanResult[\"sections\"][number],\n  measureStartBeat: number,\n  rhythmMotif: RhythmMotif,\n  baseMelody: (typeof melodyList)[number],\n  functionTag: string,\n  arrangementId: VoiceArrangementPreset,\n  rng: () => number\n): AbstractNote[] {\n  const seeds: AbstractNote[] = [];\n\n  // Expand rhythm motif pattern to get beat durations\n  const expandedPattern = expandRhythmPattern(rhythmMotif);\n\n  let beatCursor = 0;\n  let degreeIndex = 0;\n\n  // Generate accompaniment notes based on rhythm motif pattern\n  const arrangementRule = ARRANGEMENT_ACCOMP_RULES[arrangementId];\n\n  for (let patternIndex = 0; patternIndex < expandedPattern.length; patternIndex++) {\n    const step = expandedPattern[patternIndex];\n    // Stop at measure boundary (4 beats)\n    if (beatCursor >= BEATS_PER_MEASURE) break;\n\n    // Calculate remaining beats in measure\n    const remainingBeats = BEATS_PER_MEASURE - beatCursor;\n    const actualDuration = Math.min(step.durationBeats, remainingBeats);\n\n    // Resolve degree based on texture\n    const degree = resolveAccompanimentDegree(\n      section.texture,\n      degreeIndex,\n      beatCursor\n    );\n\n    // Resolve velocity with accent\n    const velocity = resolveAccompanimentVelocity(functionTag, beatCursor);\n\n    const isOffbeat = (beatCursor % 1) > 1e-6;\n    let noteVelocity = resolveAccompanimentVelocity(functionTag, beatCursor);\n    if (arrangementRule?.velocityScale) {\n      noteVelocity = Math.round(noteVelocity * arrangementRule.velocityScale);\n    }\n    if (isOffbeat && arrangementRule?.offbeatAccentBoost) {\n      noteVelocity += arrangementRule.offbeatAccentBoost;\n    }\n\n    // Density control per arrangement: probabilistic skip\n    if (arrangementRule?.density !== undefined && arrangementRule.density < 1) {\n      const keepProbability = Math.max(0, Math.min(1, arrangementRule.density));\n      if (rng() > keepProbability) {\n        beatCursor += actualDuration;\n        degreeIndex++;\n        continue;\n      }\n    }\n\n    seeds.push({\n      channelRole: \"accompaniment\",\n      startBeat: measureStartBeat + beatCursor,\n      durationBeats: actualDuration,\n      degree,\n      velocity: noteVelocity,\n      sectionId: section.id\n    });\n\n    beatCursor += actualDuration;\n    degreeIndex++;\n\n    // Stop if we've reached the measure boundary\n    if (beatCursor >= BEATS_PER_MEASURE) break;\n  }\n\n  // Mirror hook motion on pickups by echoing the first pitch one beat before the section\n  if (\n    functionTag === \"start\" &&\n    establishesHook(section) &&\n    baseMelody.pattern.length &&\n    measureStartBeat >= 0.5 &&\n    !(arrangementRule?.density !== undefined && arrangementRule.density < 0.5)\n  ) {\n    const degree = baseMelody.pattern[0];\n    seeds.push({\n      channelRole: \"accompaniment\",\n      startBeat: Math.max(0, measureStartBeat - 0.5),\n      durationBeats: 0.5,\n      degree,\n      velocity: VELOCITY_ACCOMPANIMENT.EARLY_START,\n      sectionId: section.id\n    });\n  }\n\n  if (arrangementRule?.sustainWholeMeasure && seeds.length) {\n    // Collapse into a single sustained note per measure for pad-like arrangements\n    const collapsedDegree = seeds[0].degree;\n    const collapsedVelocity = Math.max(\n      VELOCITY_ACCOMPANIMENT.PAD_MIN,\n      Math.round(seeds.reduce((sum, note) => sum + note.velocity, 0) / seeds.length)\n    );\n    return [\n      {\n        channelRole: \"accompaniment\",\n        startBeat: measureStartBeat,\n        durationBeats: BEATS_PER_MEASURE,\n        degree: collapsedDegree,\n        velocity: collapsedVelocity,\n        sectionId: section.id\n      }\n    ];\n  }\n\n  return seeds;\n}\n\ninterface ExpandedMelodyRhythmStep {\n  durationBeats: number;\n  rest: boolean;\n  accent?: boolean;\n}\n\nfunction expandMelodyRhythmPattern(motif: MelodyRhythmMotif): ExpandedMelodyRhythmStep[] {\n  const steps: ExpandedMelodyRhythmStep[] = motif.pattern.map((entry) => ({\n    durationBeats: convertToBeats(entry.value),\n    rest: Boolean(entry.rest),\n    accent: entry.accent\n  }));\n  const total = steps.reduce((sum, step) => sum + step.durationBeats, 0);\n  const tolerance = 1e-6;\n  if (Math.abs(total - motif.length) > tolerance) {\n    throw new Error(`Melody rhythm motif ${motif.id} length mismatch. expected=${motif.length}, got=${total}`);\n  }\n  return steps;\n}\n\nfunction motifPassesHumanization(motif: MelodyRhythmMotif, totalBeats: number): boolean {\n  const pattern = motif.pattern ?? [];\n  if (!pattern.length) {\n    return false;\n  }\n\n  const restRequirement = totalBeats >= 4 ? 0.25 : 0;\n  let accumulatedRest = 0;\n  let hasLongNote = false;\n  let continuousShortBeats = 0;\n\n  for (const step of pattern) {\n    const duration = convertToBeats(step.value);\n    if (step.rest) {\n      accumulatedRest += duration;\n      continuousShortBeats = 0;\n      continue;\n    }\n\n    if (duration >= 0.5) {\n      hasLongNote = true;\n      continuousShortBeats = 0;\n      continue;\n    }\n\n    continuousShortBeats += duration;\n    if (continuousShortBeats > 1 + 1e-6) {\n      return false;\n    }\n  }\n\n  if (accumulatedRest >= restRequirement) {\n    return true;\n  }\n\n  return hasLongNote;\n}\n\nfunction filterHumanizedMelodyRhythms(\n  candidates: MelodyRhythmMotif[],\n  totalBeats: number\n): MelodyRhythmMotif[] {\n  const filtered = candidates.filter((motif) => motifPassesHumanization(motif, totalBeats));\n  return filtered.length ? filtered : candidates;\n}\n\n// Unified cache structure (refactored per REFACTOR_PLAN.md Step 1-C)\ninterface CachedMotifs {\n  rhythm?: string;\n  melody?: string;\n  melodyRhythm?: string;\n  drum?: string;\n  bass?: BassPatternMotif;\n}\n\n// Hook motif cache structure (REFACTORING_ROADMAP.md P1-1)\ninterface HookMotifs {\n  rhythmId: string;\n  melodyId: string;\n  melodyRhythmId: string;\n}\n\n/**\n * Context for motif selection process (REFACTORING_ROADMAP.md P2-1)\n * Consolidates all state used throughout selectMotifsLegacy\n */\ninterface MotifContext {\n  rng: () => number;\n  compositionBaseRegister: number;\n  sectionById: Map<string, SectionDefinition>;\n  styleIntent: StyleIntent;\n  voiceArrangement: StructurePlanResult[\"voiceArrangement\"];\n  totalMeasures: number;\n\n  // Used motif tracking\n  usedMotifs: {\n    rhythms: Set<string>;\n    melodies: Set<string>;\n    drums: Set<string>;\n    melodyRhythms: Set<string>;\n    bassPatterns: Set<string>;\n    transitions: Set<string>;\n  };\n\n  // Caches\n  caches: {\n    template: Map<string, Map<string, CachedMotifs>>;\n    hook: Map<string, Map<number, HookMotifs>>;\n    bassPattern: Map<string, BassPatternMotif>;\n  };\n\n  // Last selected motifs (for variety/continuity)\n  lastMotifs: {\n    rhythm?: (typeof rhythmList)[number];\n    melodyFragment?: (typeof melodyList)[number];\n    drumPatternId?: string;\n    transitionId?: string;\n  };\n\n  // Usage statistics\n  motifUsage: {\n    rhythm: Record<string, number>;\n    melody: Record<string, number>;\n    drums: Record<string, number>;\n    melodyRhythm: Record<string, number>;\n    bass: Record<string, number>;\n    transitions: Record<string, number>;\n  };\n}\n\n/**\n * Intermediate results accumulated during motif selection\n */\ninterface MotifResults {\n  melody: AbstractNote[];\n  bass: AbstractNote[];\n  accompanimentSeeds: AbstractNote[];\n  drums: DrumHit[];\n  sectionMotifPlan: SectionMotifPlan[];\n}\n\nfunction getOrCreateTemplateCache(\n  templateCache: Map<string, Map<string, CachedMotifs>>,\n  templateId: string,\n  cacheKey: string\n): CachedMotifs {\n  if (!templateCache.has(templateId)) {\n    templateCache.set(templateId, new Map());\n  }\n  const templateMap = templateCache.get(templateId)!;\n  if (!templateMap.has(cacheKey)) {\n    templateMap.set(cacheKey, {});\n  }\n  return templateMap.get(cacheKey)!;\n}\n\n/**\n * Get hook motifs for a specific template and occurrence index.\n * Implements occurrence-based variation strategy (REFACTORING_ROADMAP.md P1-1).\n *\n * Strategy:\n * - First 3 occurrences (index 0-2): Cache unique hooks per occurrence\n * - 4th+ occurrences: Randomly select from cached hooks for variety\n *\n * @param hookCache - Map of templateId to occurrence-indexed hooks\n * @param templateId - Section template identifier\n * @param occurrenceIndex - Zero-based occurrence count for this template\n * @param rng - Random number generator\n * @returns Cached hook motifs, or undefined if not yet established\n */\nfunction getHookForOccurrence(\n  hookCache: Map<string, Map<number, HookMotifs>>,\n  templateId: string,\n  occurrenceIndex: number,\n  rng: () => number\n): HookMotifs | undefined {\n  const occurrenceMap = hookCache.get(templateId);\n  if (!occurrenceMap || occurrenceMap.size === 0) {\n    return undefined;\n  }\n\n  // Always return the hook established at occurrence 1 (the canonical hook)\n  // This maintains the core hook identity across all reprises\n  return occurrenceMap.get(1);\n}\n\n/**\n * Store hook motifs for a specific template and occurrence index.\n *\n * @param hookCache - Map of templateId to occurrence-indexed hooks\n * @param templateId - Section template identifier\n * @param occurrenceIndex - Zero-based occurrence count for this template\n * @param hook - Hook motifs to cache\n */\nfunction setHookForOccurrence(\n  hookCache: Map<string, Map<number, HookMotifs>>,\n  templateId: string,\n  occurrenceIndex: number,\n  hook: HookMotifs\n): void {\n  if (!hookCache.has(templateId)) {\n    hookCache.set(templateId, new Map());\n  }\n  const occurrenceMap = hookCache.get(templateId)!;\n\n  // Only store the hook established at occurrence 1 (the canonical hook)\n  // Per spec: establishesHook returns true when occurrenceIndex === 1\n  if (occurrenceIndex === 1) {\n    occurrenceMap.set(occurrenceIndex, hook);\n  }\n}\n\n/**\n * Initialize context for motif selection (REFACTORING_ROADMAP.md P2-1)\n */\nfunction initializeMotifContext(\n  options: PipelineCompositionOptions,\n  phase1: StructurePlanResult\n): MotifContext {\n  const rng = createRng(options.seed);\n  const compositionSeed = options.seed ?? Date.now();\n  const compositionBaseRegister = resolveBaseRegisterForComposition(\n    options.mood,\n    options.tempo,\n    options.stylePreset,\n    phase1.styleIntent,\n    compositionSeed\n  );\n\n  return {\n    rng,\n    compositionBaseRegister,\n    sectionById: new Map(phase1.sections.map((section) => [section.id, section])),\n    styleIntent: phase1.styleIntent,\n    voiceArrangement: phase1.voiceArrangement,\n    totalMeasures: options.lengthInMeasures,\n\n    usedMotifs: {\n      rhythms: new Set<string>(),\n      melodies: new Set<string>(),\n      drums: new Set<string>(),\n      melodyRhythms: new Set<string>(),\n      bassPatterns: new Set<string>(),\n      transitions: new Set<string>()\n    },\n\n    caches: {\n      template: new Map<string, Map<string, CachedMotifs>>(),\n      hook: new Map<string, Map<number, HookMotifs>>(),\n      bassPattern: new Map<string, BassPatternMotif>()\n    },\n\n    lastMotifs: {},\n\n    motifUsage: {\n      rhythm: {} as Record<string, number>,\n      melody: {} as Record<string, number>,\n      drums: {} as Record<string, number>,\n      melodyRhythm: {} as Record<string, number>,\n      bass: {} as Record<string, number>,\n      transitions: {} as Record<string, number>\n    }\n  };\n}\n\n/**\n * Context for processing a single phrase within a section.\n * Extracted from selectMotifsLegacy for P2-1 refactoring.\n */\ninterface PhraseContext {\n  section: SectionDefinition;\n  phraseMeasures: number;\n  isFirstPhrase: boolean;\n  phraseStartMeasureIndex: number;\n  cachedHook: HookMotifs | undefined;\n  baseRhythm: (typeof rhythmList)[number];\n  baseMelody: (typeof melodyList)[number];\n  baseMelodyRhythm: MelodyRhythmMotif;\n}\n\n/**\n * Context for processing a single measure within a phrase.\n * Extracted from selectMotifsLegacy for P2-1 refactoring.\n */\ninterface MeasureContext {\n  measureInSection: number;\n  globalMeasureIndex: number;\n  measureStartBeat: number;\n  functionTag: string;\n  requiredTags: string[];\n  isHookMeasure: boolean;\n  phraseOffset: number;\n  rhythmMotif: (typeof rhythmList)[number];\n}\n\n/**\n * Process all phrases in a section, generating motifs for melody, bass, accompaniment, and drums.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n * \n * @param section - Section to process\n * @param phase1 - Phase 1 result containing structure and harmony\n * @param context - Motif selection context\n * @param results - Accumulated results (mutated)\n */\nfunction processSectionPhrases(\n  section: SectionDefinition,\n  phase1: StructurePlanResult,\n  options: PipelineCompositionOptions,\n  context: MotifContext,\n  results: MotifResults\n): void {\n  const sectionStartBeat = section.startMeasure * BEATS_PER_MEASURE;\n  const phraseLength = Math.max(1, getPhraseLengthForSection(section));\n\n  let measure = 0;\n  while (measure < section.measures) {\n    const phraseMeasures = Math.min(phraseLength, section.measures - measure);\n    const isFirstPhrase = measure === 0;\n    const phraseStartMeasureIndex = section.startMeasure + measure;\n\n    const phraseContext = createPhraseContext(\n      section,\n      phase1,\n      options,\n      phraseMeasures,\n      isFirstPhrase,\n      phraseStartMeasureIndex,\n      context,\n      results\n    );\n\n    processSinglePhrase(phraseContext, phase1, options, context, results);\n\n    measure += phraseMeasures;\n  }\n}\n\n/**\n * Create phrase context for a single phrase iteration.\n * Handles hook caching and base motif selection.\n */\nfunction createPhraseContext(\n  section: SectionDefinition,\n  phase1: StructurePlanResult,\n  options: PipelineCompositionOptions,\n  phraseMeasures: number,\n  isFirstPhrase: boolean,\n  phraseStartMeasureIndex: number,\n  context: MotifContext,\n  results: MotifResults\n): PhraseContext {\n  const cachedHook = getHookForOccurrence(\n    context.caches.hook,\n    section.templateId,\n    section.occurrenceIndex,\n    context.rng\n  );\n\n  const baseFunctionTag = functionalTagForMeasure(0, section.measures);\n  const baseRequiredTags: string[] = [];\n  if (phraseStartMeasureIndex === context.totalMeasures - 1) {\n    baseRequiredTags.push(\"loop_safe\");\n  } else if (phraseStartMeasureIndex === context.totalMeasures - 2 && !(repriseHook(section) && isFirstPhrase)) {\n    baseRequiredTags.push(\"cadence\");\n  }\n\n  let baseRhythm: (typeof rhythmList)[number] | undefined;\n  let baseMelody: (typeof melodyList)[number] | undefined;\n  let baseMelodyRhythm: MelodyRhythmMotif | undefined;\n\n  const rhythmKey = cacheKey(baseFunctionTag, baseRequiredTags);\n  const melodyKey = cacheKey(baseFunctionTag, baseRequiredTags);\n  const cache = getOrCreateTemplateCache(context.caches.template, section.templateId, rhythmKey);\n\n  // Retrieve from hook cache if reprising\n  if (repriseHook(section) && isFirstPhrase && cachedHook) {\n    const hookRhythm = rhythmById.get(cachedHook.rhythmId);\n    const hookMelody = melodyById.get(cachedHook.melodyId);\n    if (hookRhythm) {\n      baseRhythm = hookRhythm;\n    }\n    if (hookMelody) {\n      baseMelody = hookMelody;\n    }\n  }\n\n  // Select base rhythm\n  if (!baseRhythm) {\n    const cachedRhythmId = cache.rhythm;\n    baseRhythm = cachedRhythmId ? rhythmById.get(cachedRhythmId) : undefined;\n    if (!baseRhythm) {\n      baseRhythm = selectRhythmMotif(\n        options,\n        context.styleIntent,\n        baseFunctionTag,\n        context.lastMotifs.rhythm,\n        baseRequiredTags,\n        context.rng,\n        context.usedMotifs.rhythms\n      );\n      cache.rhythm = baseRhythm.id;\n    }\n  }\n\n  // Select base melody\n  if (!baseMelody) {\n    const cachedMelodyId = cache.melody;\n    baseMelody = cachedMelodyId ? melodyById.get(cachedMelodyId) : undefined;\n    if (!baseMelody) {\n      baseMelody = selectMelodyFragment(\n        options,\n        context.styleIntent,\n        baseRequiredTags,\n        context.rng,\n        context.lastMotifs.melodyFragment,\n        context.usedMotifs.melodies\n      );\n      cache.melody = baseMelody.id;\n    }\n  }\n\n  // Select melody rhythm\n  if (repriseHook(section) && isFirstPhrase && cachedHook) {\n    const hookMelodyRhythm = melodyRhythmById.get(cachedHook.melodyRhythmId);\n    if (hookMelodyRhythm) {\n      baseMelodyRhythm = hookMelodyRhythm;\n    }\n  }\n  if (!baseMelodyRhythm) {\n    const cachedMelodyRhythmId = cache.melodyRhythm;\n    baseMelodyRhythm = cachedMelodyRhythmId ? melodyRhythmById.get(cachedMelodyRhythmId) : undefined;\n    if (!baseMelodyRhythm) {\n      baseMelodyRhythm = selectMelodyRhythmMotif(\n        options,\n        context.styleIntent,\n        baseFunctionTag,\n        phraseMeasures * BEATS_PER_MEASURE,\n        baseRequiredTags,\n        context.rng,\n        undefined,\n        context.usedMotifs.melodyRhythms\n      );\n      cache.melodyRhythm = baseMelodyRhythm.id;\n    }\n  }\n\n  // Establish hook if needed\n  if (establishesHook(section) && isFirstPhrase) {\n    setHookForOccurrence(context.caches.hook, section.templateId, section.occurrenceIndex, {\n      rhythmId: baseRhythm.id,\n      melodyId: baseMelody.id,\n      melodyRhythmId: baseMelodyRhythm.id\n    });\n  }\n\n  context.usedMotifs.rhythms.add(baseRhythm.id);\n  context.usedMotifs.melodies.add(baseMelody.id);\n  context.usedMotifs.melodyRhythms.add(baseMelodyRhythm.id);\n\n  // Track usage count for diagnostics\n  context.motifUsage.melodyRhythm[baseMelodyRhythm.id] =\n    (context.motifUsage.melodyRhythm[baseMelodyRhythm.id] ?? 0) + 1;\n\n  // Record section motif plan on first phrase\n  if (isFirstPhrase) {\n    results.sectionMotifPlan.push({\n      sectionId: section.id,\n      templateId: section.templateId,\n      occurrenceIndex: section.occurrenceIndex,\n      primaryRhythm: baseRhythm.id,\n      primaryMelody: baseMelody.id,\n      primaryMelodyRhythm: baseMelodyRhythm.id,\n      reprisesHook:\n        repriseHook(section) && Boolean(cachedHook) &&\n        cachedHook?.rhythmId === baseRhythm.id &&\n        cachedHook?.melodyId === baseMelody.id &&\n        cachedHook?.melodyRhythmId === baseMelodyRhythm.id\n    });\n  }\n\n  return {\n    section,\n    phraseMeasures,\n    isFirstPhrase,\n    phraseStartMeasureIndex,\n    cachedHook,\n    baseRhythm,\n    baseMelody,\n    baseMelodyRhythm\n  };\n}\n\n/**\n * Process a single phrase, iterating over its measures.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction processSinglePhrase(\n  phraseContext: PhraseContext,\n  phase1: StructurePlanResult,\n  options: PipelineCompositionOptions,\n  context: MotifContext,\n  results: MotifResults\n): void {\n  const { section, phraseMeasures, isFirstPhrase, baseMelody, baseMelodyRhythm } = phraseContext;\n  const sectionStartBeat = section.startMeasure * BEATS_PER_MEASURE;\n  \n  const expandedMelodyRhythm = expandMelodyRhythmPattern(baseMelodyRhythm);\n  let phraseBeatCursor = 0;\n  let phraseStepIndex = 0;\n  let melodyDegreeCursor = 0;\n\n  for (let phraseOffset = 0; phraseOffset < phraseMeasures; phraseOffset++) {\n    const measureContext = createMeasureContext(\n      phraseContext,\n      phraseOffset,\n      options,\n      context\n    );\n\n    // Add pickup note if first phrase and first measure\n    if (isFirstPhrase && phraseOffset === 0) {\n      maybeAddPickupNote(results.melody, measureContext.measureStartBeat, baseMelody, section.id);\n    }\n\n    // Generate melody for this measure\n    generateMelodyForMeasure(\n      measureContext,\n      expandedMelodyRhythm,\n      baseMelody,\n      section,\n      context,\n      results.melody,\n      { phraseBeatCursor, phraseStepIndex, melodyDegreeCursor }\n    );\n\n    // Update cursors after melody generation\n    const measureBeatLimit = (phraseOffset + 1) * BEATS_PER_MEASURE;\n    while (phraseStepIndex < expandedMelodyRhythm.length && phraseBeatCursor < measureBeatLimit) {\n      const step = expandedMelodyRhythm[phraseStepIndex];\n      if (!step.rest) {\n        melodyDegreeCursor++;\n      }\n      phraseBeatCursor += step.durationBeats;\n      phraseStepIndex++;\n    }\n\n    // Generate bass for this measure\n    generateBassForMeasure(measureContext, phase1, section, context, results.bass);\n\n    // Generate accompaniment for this measure\n    generateAccompanimentForMeasure(\n      measureContext,\n      baseMelody,\n      section,\n      context,\n      results.accompanimentSeeds\n    );\n\n    // Generate drums for this measure\n    generateDrumsForMeasure(\n      measureContext,\n      section,\n      context,\n      results.drums\n    );\n\n    // Update last motifs\n    context.lastMotifs.rhythm = measureContext.rhythmMotif;\n    context.lastMotifs.melodyFragment = baseMelody;\n  }\n}\n\n/**\n * Create measure context for processing a single measure.\n * Handles rhythm selection with variation logic.\n */\nfunction createMeasureContext(\n  phraseContext: PhraseContext,\n  phraseOffset: number,\n  options: PipelineCompositionOptions,\n  context: MotifContext\n): MeasureContext {\n  const { section, isFirstPhrase, baseRhythm } = phraseContext;\n  const measureInSection = phraseContext.phraseStartMeasureIndex - section.startMeasure + phraseOffset;\n  const globalMeasureIndex = section.startMeasure + measureInSection;\n  const measureStartBeat = section.startMeasure * BEATS_PER_MEASURE + measureInSection * BEATS_PER_MEASURE;\n  \n  const functionTag = functionalTagForMeasure(measureInSection, section.measures);\n  const requiredTags: string[] = [];\n  const isHookMeasure = repriseHook(section) && measureInSection === 0;\n  \n  if (globalMeasureIndex === context.totalMeasures - 1) {\n    requiredTags.push(\"loop_safe\");\n  } else if (globalMeasureIndex === context.totalMeasures - 2 && !isHookMeasure) {\n    requiredTags.push(\"cadence\");\n  }\n\n  const measureKey = cacheKey(functionTag, requiredTags);\n  const measureCache = getOrCreateTemplateCache(context.caches.template, section.templateId, measureKey);\n\n  // Control variation vs exact repetition using sectionRepeatBias\n  // Higher bias = more repetition, lower bias = more variation\n  const repeatBias = options.sectionRepeatBias ?? 0.3;\n  const shouldVaryByPosition = phraseOffset > 0 || !isFirstPhrase || section.occurrenceIndex > 1;\n  const preferVariation =\n    !repriseHook(section) &&\n    shouldVaryByPosition &&\n    context.rng() > repeatBias;\n  \n  let rhythmMotif = measureCache.rhythm ? rhythmById.get(measureCache.rhythm) : undefined;\n  \n  if (!rhythmMotif) {\n    if (preferVariation) {\n      rhythmMotif = pickRhythmVariation(baseRhythm, functionTag, requiredTags, context.rng, context.usedMotifs.rhythms) ?? baseRhythm;\n    } else {\n      rhythmMotif = baseRhythm;\n    }\n  } else if (preferVariation && rhythmMotif.id === baseRhythm.id) {\n    const variation = pickRhythmVariation(baseRhythm, functionTag, requiredTags, context.rng, context.usedMotifs.rhythms);\n    if (variation) {\n      rhythmMotif = variation;\n    }\n  }\n  \n  if (!rhythmMotif.tags.includes(functionTag) || !hasAllTags(rhythmMotif, requiredTags)) {\n    rhythmMotif = selectRhythmMotif(\n      options,\n      context.styleIntent,\n      functionTag,\n      baseRhythm,\n      requiredTags,\n      context.rng,\n      context.usedMotifs.rhythms\n    );\n  }\n  \n  measureCache.rhythm = rhythmMotif.id;\n  context.motifUsage.rhythm[rhythmMotif.id] = (context.motifUsage.rhythm[rhythmMotif.id] ?? 0) + 1;\n  context.usedMotifs.rhythms.add(rhythmMotif.id);\n\n  return {\n    measureInSection,\n    globalMeasureIndex,\n    measureStartBeat,\n    functionTag,\n    requiredTags,\n    isHookMeasure,\n    phraseOffset,\n    rhythmMotif\n  };\n}\n\n/**\n * Generate melody notes for a single measure.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction generateMelodyForMeasure(\n  measureContext: MeasureContext,\n  expandedMelodyRhythm: ExpandedMelodyRhythmStep[],\n  baseMelody: (typeof melodyList)[number],\n  section: SectionDefinition,\n  context: MotifContext,\n  melodyOutput: AbstractNote[],\n  cursors: { phraseBeatCursor: number; phraseStepIndex: number; melodyDegreeCursor: number }\n): void {\n  const { measureStartBeat, measureInSection, globalMeasureIndex, phraseOffset } = measureContext;\n  const measureBeatLimit = (phraseOffset + 1) * BEATS_PER_MEASURE;\n  \n  while (cursors.phraseStepIndex < expandedMelodyRhythm.length && cursors.phraseBeatCursor < measureBeatLimit) {\n    const step = expandedMelodyRhythm[cursors.phraseStepIndex];\n    const localStart = cursors.phraseBeatCursor - phraseOffset * BEATS_PER_MEASURE;\n    \n    if (!step.rest) {\n      let degree = baseMelody.pattern[cursors.melodyDegreeCursor % baseMelody.pattern.length];\n      const isTailStep = cursors.phraseStepIndex === expandedMelodyRhythm.length - 1;\n      \n      if (isTailStep && (section.occurrenceIndex > 1 || measureInSection > 0) && !repriseHook(section)) {\n        degree = resolveTailDegreeVariant(degree, baseMelody.pattern, context.styleIntent, context.rng);\n      }\n      \n      let velocity = resolveMelodyVelocity(\n        section,\n        measureInSection,\n        globalMeasureIndex,\n        context.totalMeasures,\n        context.styleIntent\n      );\n      \n      melodyOutput.push({\n        channelRole: \"melody\",\n        startBeat: measureStartBeat + localStart,\n        durationBeats: step.durationBeats,\n        degree,\n        velocity,\n        sectionId: section.id\n      });\n      \n      cursors.melodyDegreeCursor++;\n    }\n    \n    cursors.phraseBeatCursor += step.durationBeats;\n    cursors.phraseStepIndex++;\n  }\n}\n\n/**\n * Generate bass notes for a single measure.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction generateBassForMeasure(\n  measureContext: MeasureContext,\n  phase1: StructurePlanResult,\n  section: SectionDefinition,\n  context: MotifContext,\n  bassOutput: AbstractNote[]\n): void {\n  const { measureStartBeat, measureInSection } = measureContext;\n  \n  let bassPattern = context.caches.bassPattern.get(section.id);\n  if (!bassPattern) {\n    bassPattern = resolveBassPattern(\n      section,\n      measureInSection,\n      context.rng,\n      context.usedMotifs.bassPatterns,\n      context.caches.bassPattern,\n      context.styleIntent\n    );\n    context.caches.bassPattern.set(section.id, bassPattern);\n  }\n  \n  const currentChord = resolveChordAtBeat(phase1, measureStartBeat);\n  const nextChord = resolveChordAtBeat(phase1, measureStartBeat + BEATS_PER_MEASURE);\n  \n  bassOutput.push(\n    ...buildBassPattern(\n      section,\n      measureStartBeat,\n      currentChord,\n      nextChord,\n      bassPattern\n    )\n  );\n}\n\n/**\n * Generate accompaniment seeds for a single measure.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction generateAccompanimentForMeasure(\n  measureContext: MeasureContext,\n  baseMelody: (typeof melodyList)[number],\n  section: SectionDefinition,\n  context: MotifContext,\n  accompanimentOutput: AbstractNote[]\n): void {\n  const { measureStartBeat, rhythmMotif, functionTag } = measureContext;\n  \n  accompanimentOutput.push(\n    ...buildAccompanimentSeeds(\n      section,\n      measureStartBeat,\n      rhythmMotif,\n      baseMelody,\n      functionTag,\n      context.voiceArrangement.id,\n      context.rng\n    )\n  );\n}\n\n/**\n * Generate drum hits for a single measure.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction generateDrumsForMeasure(\n  measureContext: MeasureContext,\n  section: SectionDefinition,\n  context: MotifContext,\n  drumsOutput: DrumHit[]\n): void {\n  const { measureStartBeat, measureInSection, requiredTags } = measureContext;\n  \n  const isSectionFinalMeasure = measureInSection === section.measures - 1;\n  const shouldForceFill =\n    isSectionFinalMeasure || (section.measures > 2 && measureInSection === section.measures - 2);\n  \n  const drumKey = cacheKey(`${measureInSection}:${shouldForceFill ? \"fill\" : \"beat\"}`, requiredTags);\n  const drumCache = getOrCreateTemplateCache(context.caches.template, section.templateId, drumKey);\n  \n  let drumPattern = drumCache.drum ? drumById.get(drumCache.drum) : undefined;\n  \n  if (!drumPattern) {\n    drumPattern = selectDrumPattern(\n      measureInSection,\n      section.measures,\n      requiredTags,\n      context.rng,\n      context.lastMotifs.drumPatternId,\n      context.usedMotifs.drums,\n      shouldForceFill,\n      context.styleIntent,\n      context.voiceArrangement.id\n    );\n    if (drumPattern) {\n      drumCache.drum = drumPattern.id;\n    }\n  }\n  \n  if (drumPattern) {\n    context.motifUsage.drums[drumPattern.id] = (context.motifUsage.drums[drumPattern.id] ?? 0) + 1;\n    context.usedMotifs.drums.add(drumPattern.id);\n    drumsOutput.push(...generateDrumHitsFromPattern(drumPattern.pattern, measureStartBeat, section.id));\n    context.lastMotifs.drumPatternId = drumPattern.id;\n  }\n  \n  // Handle transitions at section end\n  if (isSectionFinalMeasure) {\n    const isLastSection = section.id === context.sectionById.get(Array.from(context.sectionById.keys()).pop()!)?.id;\n    const transitionResult = maybeGenerateTransition(\n      section,\n      measureStartBeat,\n      isLastSection,\n      context.rng,\n      context.lastMotifs.transitionId,\n      context.usedMotifs.transitions,\n      context.styleIntent,\n      section.startMeasure + measureInSection,\n      context.totalMeasures\n    );\n    \n    if (transitionResult) {\n      context.motifUsage.transitions[transitionResult.motifId] =\n        (context.motifUsage.transitions[transitionResult.motifId] ?? 0) + 1;\n      context.usedMotifs.transitions.add(transitionResult.motifId);\n      drumsOutput.push(...mergeTransitionHits(drumsOutput, transitionResult.hits));\n      context.lastMotifs.transitionId = transitionResult.motifId;\n    }\n  }\n}\n\n/**\n * Convert melody AbstractNotes to MidiNotes with chord quantization.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction convertMelodyToMidi(\n  melody: AbstractNote[],\n  phase1: StructurePlanResult,\n  context: MotifContext\n): MidiNote[] {\n  return melody.map((note) => {\n    const section = context.sectionById.get(note.sectionId);\n    const measureIndex = Math.floor(note.startBeat / BEATS_PER_MEASURE);\n    const measureInSection = section ? measureIndex - section.startMeasure : 0;\n    const baseRegister = resolveMelodyRegister(\n      section,\n      measureInSection,\n      measureIndex,\n      context.totalMeasures,\n      context.styleIntent,\n      context.compositionBaseRegister\n    );\n    const baseMidi = scaleDegreeToMidi(note.degree, phase1.scaleDegrees, baseRegister);\n    const chord = resolveChordAtBeat(phase1, note.startBeat);\n    const midi = isStrongBeat(note.startBeat)\n      ? quantizeMidiToChord(baseMidi, chord)\n      : ensureConsonantPitch(baseMidi, chord);\n    return { ...note, midi };\n  });\n}\n\n/**\n * Convert accompaniment AbstractNotes to MidiNotes with consonant pitch adjustment.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction convertAccompanimentToMidi(\n  accompanimentSeeds: AbstractNote[],\n  phase1: StructurePlanResult,\n  melodyMidi: MidiNote[]\n): MidiNote[] {\n  return accompanimentSeeds.map((note) => {\n    const baseMidi = scaleDegreeToMidi(note.degree, phase1.scaleDegrees, 67);\n    const chord = resolveChordAtBeat(phase1, note.startBeat);\n    const reference = findMelodyReference(note.startBeat, melodyMidi);\n    const midi = ensureConsonantPitch(baseMidi, chord, reference?.midi);\n    return { ...note, midi };\n  });\n}\n\n/**\n * Convert bass AbstractNotes to MidiNotes with chord quantization.\n * Part of P2-1 refactoring: extracted from selectMotifsLegacy.\n */\nfunction convertBassToMidi(\n  bass: AbstractNote[],\n  phase1: StructurePlanResult\n): MidiNote[] {\n  return bass.map((note) => {\n    const midiOverride = (note as any).midiOverride as number | undefined;\n    const base = midiOverride ?? scaleDegreeToMidi(note.degree, phase1.scaleDegrees, 52, -1);\n    const chord = resolveChordAtBeat(phase1, note.startBeat);\n    const midi = quantizeMidiToChord(base, chord);\n    return { ...note, midi };\n  });\n}\n\n/**\n * Legacy Phase2 implementation for standard/swapped arrangements\n * Preserves backwards compatibility\n */\nfunction selectMotifsLegacy(options: PipelineCompositionOptions, phase1: StructurePlanResult): {\n  melody: MidiNote[];\n  bass: MidiNote[];\n  accompanimentSeeds: MidiNote[];\n  drums: DrumHit[];\n  motifUsage: MotifSelectionResult[\"motifUsage\"];\n  sectionMotifPlan: SectionMotifPlan[];\n} {\n  // Initialize context (P2-1 refactoring: extracted from original implementation)\n  const context = initializeMotifContext(options, phase1);\n  \n  // Initialize results accumulator\n  const results: MotifResults = {\n    melody: [],\n    bass: [],\n    accompanimentSeeds: [],\n    drums: [],\n    sectionMotifPlan: []\n  };\n\n  // Process all sections (P2-1 refactoring: Section → Phrase → Measure hierarchy)\n  for (const section of phase1.sections) {\n    processSectionPhrases(section, phase1, options, context, results);\n  }\n\n  // Convert AbstractNotes to MidiNotes (P2-1 refactoring: extracted conversion logic)\n  const melodyMidi = convertMelodyToMidi(results.melody, phase1, context);\n  const bassMidi = convertBassToMidi(results.bass, phase1);\n  const accompanimentMidi = convertAccompanimentToMidi(results.accompanimentSeeds, phase1, melodyMidi);\n\n  return {\n    melody: melodyMidi,\n    bass: bassMidi,\n    accompanimentSeeds: accompanimentMidi,\n    drums: results.drums,\n    motifUsage: context.motifUsage,\n    sectionMotifPlan: results.sectionMotifPlan\n  };\n}\n\n/**\n * New Phase2 implementation with voice arrangement support\n */\nexport function selectMotifs(options: PipelineCompositionOptions, phase1: StructurePlanResult): MotifSelectionResult {\n  const { voiceArrangement } = phase1;\n  const baseSeed = options.seed ?? RNG_SEED;\n  const legacy = selectMotifsLegacy(options, phase1);\n\n  // For standard/swapped arrangements, use legacy implementation\n  if (voiceArrangement.id === \"standard\" || voiceArrangement.id === \"swapped\") {\n    return {\n      tracks: [\n        { role: \"melody\", notes: legacy.melody },\n        { role: \"bass\", notes: legacy.bass },\n        { role: \"accompaniment\", notes: legacy.accompanimentSeeds }\n      ],\n      drums: legacy.drums,\n      motifUsage: legacy.motifUsage,\n      sectionMotifPlan: legacy.sectionMotifPlan\n    };\n  }\n\n  // New arrangements: generate tracks based on voice roles\n  const tracks: MotifSelectionResult[\"tracks\"] = [];\n\n  // Process each voice in the arrangement\n  for (const voice of voiceArrangement.voices) {\n    let abstractNotes: AbstractNote[];\n\n    switch (voice.role) {\n      case \"bass\":\n      case \"bassAlt\":\n        abstractNotes = generateBassTrackForVoice(\n          voice.role,\n          voice.priority,\n          voice.octaveOffset ?? 0,\n          voice.seedOffset ?? 0,\n          options,\n          phase1\n        );\n        break;\n\n      case \"pad\":\n        abstractNotes = generatePadTrackForVoice(\n          voice.priority,\n          options,\n          phase1,\n          baseSeed + (voice.seedOffset ?? 0)\n        );\n        break;\n\n      case \"melody\":\n      case \"melodyAlt\":\n      case \"accompaniment\":\n        // For minimal arrangement without melody, skip\n        if (voice.role === \"melody\" && voiceArrangement.id === \"minimal\") {\n          continue;\n        }\n        // Reuse legacy results to preserve motif usage history\n        if (voice.role === \"melody\") {\n          abstractNotes = legacy.melody;\n        } else {\n          abstractNotes = legacy.accompanimentSeeds;\n        }\n        break;\n\n      default:\n        abstractNotes = [];\n    }\n\n    // Convert AbstractNote to MidiNote\n    const midiNotes: MidiNote[] = abstractNotes.map((note) => {\n      let midi: number;\n      let velocity = note.velocity;\n\n      // Handle bass with midiOverride\n      if ((note.channelRole === \"bass\" || voice.role === \"bass\" || voice.role === \"bassAlt\") &&\n          (note as any).midiOverride !== undefined) {\n        midi = (note as any).midiOverride;\n      } else {\n        // Handle melody/accompaniment/pad with scale conversion\n        const measureIndex = Math.floor(note.startBeat / BEATS_PER_MEASURE);\n        const baseRegister = voice.role === \"melody\" || voice.role === \"melodyAlt\" ? 72 : 67;\n        const baseMidi = scaleDegreeToMidi(note.degree, phase1.scaleDegrees, baseRegister);\n        const chord = resolveChordAtBeat(phase1, note.startBeat);\n        midi = quantizeMidiToChord(baseMidi, chord);\n\n        // Apply octaveOffset for non-bass roles (e.g., bassLed arrangement)\n        if (voice.octaveOffset) {\n          midi += voice.octaveOffset * 12;\n        }\n      }\n\n      // Layered bass now splits square (foundation) and triangle (accent). Tame their\n      // combined energy while keeping the triangle layer lighter and slightly higher.\n      if (voiceArrangement.id === \"layeredBass\") {\n        if (voice.role === \"bass\") {\n          velocity = Math.max(28, Math.round(velocity * 0.65));\n        } else if (voice.role === \"bassAlt\") {\n          velocity = Math.max(22, Math.round(velocity * 0.5));\n        }\n      }\n\n      return { ...note, midi, velocity };\n    });\n\n    if (midiNotes.length > 0) {\n      tracks.push({ role: voice.role, notes: midiNotes });\n    }\n  }\n\n  return {\n    tracks,\n    drums: legacy.drums,\n    motifUsage: legacy.motifUsage,\n    sectionMotifPlan: legacy.sectionMotifPlan\n  };\n}\n\nfunction convertToBeats(value: number): number {\n  switch (value) {\n    case 2:\n      return 2;    // 2分音符 = 2拍\n    case 4:\n      return 1;    // 4分音符 = 1拍\n    case 8:\n      return 0.5;  // 8分音符 = 0.5拍\n    case 16:\n      return 0.25; // 16分音符 = 0.25拍\n    default:\n      return 0.25;\n  }\n}\n\nfunction selectDrumPattern(\n  measureIndex: number,\n  totalMeasures: number,\n  requiredTags: string[],\n  rng: () => number,\n  lastPatternId: string | undefined,\n  used: Set<string>,\n  forceFill: boolean,\n  styleIntent: StyleIntent,\n  arrangementId: VoiceArrangementPreset\n) {\n  const arrangementRule = ARRANGEMENT_DRUM_RULES[arrangementId];\n  if (!forceFill && arrangementRule?.earlySparseMeasures && measureIndex < arrangementRule.earlySparseMeasures) {\n    if (rng() < 0.3) {\n      return undefined;\n    }\n  }\n\n  // gradualBuild: progressive layer control\n  if (styleIntent.gradualBuild && totalMeasures >= 8) {\n    const progress = measureIndex / Math.max(1, totalMeasures - 1);\n    const earlyThreshold = Math.min(0.35, 6 / Math.max(1, totalMeasures));\n    const midThreshold = Math.min(0.7, 14 / Math.max(1, totalMeasures));\n    if (progress < earlyThreshold) {\n      if (rng() < 0.75) {\n        return undefined;\n      }\n    } else if (progress < midThreshold) {\n      if (rng() < 0.35) {\n        return undefined;\n      }\n    }\n  }\n\n  const fillEvery = styleIntent.breakInsertion ? 2 : 4;\n  const cycleFill = fillEvery > 0 && totalMeasures >= fillEvery && (measureIndex + 1) % fillEvery === 0;\n  const isFill = forceFill || cycleFill;\n  let candidates = drumList.filter((pattern) =>\n    isFill ? pattern.type === \"fill\" : pattern.type === \"beat\"\n  );\n  const fitsMeasure = candidates.filter((pattern) => pattern.length_beats <= BEATS_PER_MEASURE);\n  if (fitsMeasure.length) {\n    candidates = fitsMeasure;\n  }\n  if (requiredTags.length) {\n    const filtered = candidates.filter((pattern) => {\n      const tags = (pattern as any).tags as string[] | undefined;\n      return tags ? requiredTags.every((tag) => tags.includes(tag)) : false;\n    });\n    if (filtered.length) {\n      candidates = filtered;\n    }\n  }\n  if (!candidates.length) {\n    candidates = drumList.filter((pattern) => (isFill ? pattern.type === \"fill\" : pattern.type === \"beat\"));\n  }\n  if (!candidates.length) {\n    candidates = drumList;\n  }\n  const prefersBreakbeatFocus =\n    styleIntent.percussiveLayering &&\n    styleIntent.syncopationBias &&\n    styleIntent.breakInsertion &&\n    !styleIntent.loopCentric;\n  const prefersLofiGroove =\n    styleIntent.atmosPad &&\n    styleIntent.loopCentric &&\n    styleIntent.harmonicStatic;\n  const prefersRetroPulse =\n    styleIntent.loopCentric &&\n    styleIntent.textureFocus &&\n    styleIntent.percussiveLayering;\n\n  if (!isFill) {\n    if (styleIntent.loopCentric) {\n      candidates = preferTagPresence(candidates, [\"loop_safe\"]);\n    }\n    if (styleIntent.syncopationBias) {\n      const syncTags = prefersBreakbeatFocus ? [\"breakbeat\", \"syncopation\", \"grid16\"] : [\"syncopation\"];\n      candidates = preferTagPresence(candidates, syncTags);\n    }\n    if (styleIntent.textureFocus) {\n      candidates = preferTagPresence(candidates, [\"texture_loop\", \"straight\", \"grid16\"]);\n    }\n    if (styleIntent.percussiveLayering) {\n      const percussiveTags = prefersBreakbeatFocus\n        ? [\"breakbeat\", \"percussive_layer\", \"grid16\"]\n        : [\"percussive_layer\", \"four_on_floor\"];\n      candidates = preferTagPresence(candidates, percussiveTags);\n    }\n    if (prefersLofiGroove) {\n      candidates = preferTagPresence(candidates, [\"lofi\", \"rest_heavy\", \"swing_hint\"], 0.3);\n    }\n    if (prefersRetroPulse) {\n      candidates = preferTagPresence(candidates, [\"loop_safe\", \"grid16\", \"texture_loop\"], 0.25);\n    }\n    if (arrangementRule?.preferBeatTags?.length) {\n      candidates = preferTagPresence(candidates, arrangementRule.preferBeatTags, 0.25);\n    }\n  } else {\n    if (arrangementRule?.preferFillTags?.length) {\n      candidates = preferTagPresence(candidates, arrangementRule.preferFillTags, 0.25);\n    }\n  }\n  if (prefersBreakbeatFocus) {\n    candidates = preferTagPresence(candidates, [\"breakbeat\", \"grid16\"], 0.2);\n  }\n  if (arrangementRule?.avoidTags?.length) {\n    const filtered = candidates.filter((pattern) => {\n      const tags = (pattern as any).tags as string[] | undefined;\n      if (!tags) return true;\n      return !arrangementRule.avoidTags!.some((tag) => tags.includes(tag));\n    });\n    if (filtered.length) {\n      candidates = filtered;\n    }\n  }\n  const pool = preferUnused(candidates, used);\n  return pickWithAvoid(pool, rng, lastPatternId);\n}\n\nfunction preferUnused<T extends { id?: string }>(candidates: T[], used: Set<string>): T[] {\n  if (!candidates.length) {\n    return candidates;\n  }\n  const unused = candidates.filter((entry) => (entry.id ? !used.has(entry.id) : true));\n  return unused.length ? unused : candidates;\n}\n\nfunction cacheKey(functionTag: string, requiredTags: string[]): string {\n  if (!requiredTags.length) {\n    return functionTag;\n  }\n  const tags = [...requiredTags].sort();\n  return `${functionTag}:${tags.join(\"|\")}`;\n}\n\n// ========================================\n// Voice Arrangement Helper Functions\n// ========================================\n\n/**\n * Create RNG with offset for voice variation\n */\nfunction createVoiceRng(baseSeed: number | undefined, seedOffset: number): () => number {\n  const effectiveSeed = ((baseSeed ?? RNG_SEED) + seedOffset) >>> 0;\n  return createRng(effectiveSeed);\n}\n\n/**\n * Check if a voice should generate a note in this measure (probability-based density)\n */\nfunction shouldGenerateForVoice(\n  priority: number,\n  measureInSection: number,\n  totalMeasures: number,\n  styleIntent: StyleIntent,\n  rng: () => number\n): boolean {\n  // Always generate if priority is 1.0\n  if (priority >= 1.0) {\n    return true;\n  }\n\n  // For gradualBuild style, increase density over time\n  if (styleIntent.gradualBuild) {\n    const progress = measureInSection / Math.max(1, totalMeasures - 1);\n    const adjustedPriority = Math.min(1.0, priority + progress * 0.3);\n    return rng() < adjustedPriority;\n  }\n\n  // Default: probabilistic based on priority\n  return rng() < priority;\n}\n\n/**\n * Modified buildBassPattern to accept custom baseMidi\n */\nfunction buildBassPatternWithBaseMidi(\n  section: StructurePlanResult[\"sections\"][number],\n  measureStartBeat: number,\n  chord: string,\n  nextChord: string,\n  motif: BassPatternMotif,\n  baseMidi: number,\n  octaveOffset: number = 0\n): Array<AbstractNote & { midiOverride: number }> {\n  const steps = motif.steps?.length ? motif.steps : DEFAULT_BASS_STEPS;\n  const notes: Array<AbstractNote & { midiOverride: number }> = [];\n  const nextChordName = nextChord ?? chord;\n\n  for (let step = 0; step < steps.length; step++) {\n    const startBeat = measureStartBeat + step * 0.5;\n    const midi = bassStepToMidi(steps[step], chord, nextChordName, baseMidi);\n\n    // Skip rest steps\n    if (midi === null) {\n      continue;\n    }\n\n    notes.push({\n      channelRole: \"bass\",\n      startBeat,\n      durationBeats: 0.5,\n      degree: 0,\n      velocity: resolveBassVelocity(section, step),\n      sectionId: section.id,\n      midiOverride: midi\n    });\n  }\n\n  return notes;\n}\n\n/**\n * Generate bass track for a voice (reuses existing logic)\n */\nfunction generateBassTrackForVoice(\n  role: \"bass\" | \"bassAlt\",\n  priority: number,\n  octaveOffset: number,\n  seedOffset: number,\n  options: PipelineCompositionOptions,\n  phase1: StructurePlanResult\n): AbstractNote[] {\n  const bassNotes: AbstractNote[] = [];\n  const styleIntent = phase1.styleIntent;\n  const baseSeed = options.seed ?? RNG_SEED;\n  const voiceRng = createVoiceRng(baseSeed, seedOffset);\n  const usedBassPatterns = new Set<string>();\n  const bassPatternCache = new Map<string, BassPatternMotif>();\n\n  const octaveOffsetSemitones = octaveOffset * 12;\n  const baseBassMidi = 40 + octaveOffsetSemitones;\n\n  for (const section of phase1.sections) {\n    const sectionStartBeat = section.startMeasure * BEATS_PER_MEASURE;\n\n    for (let measure = 0; measure < section.measures; measure++) {\n      // Density check: should this voice play in this measure?\n      if (!shouldGenerateForVoice(priority, measure, section.measures, styleIntent, voiceRng)) {\n        continue;\n      }\n\n      const measureStartBeat = sectionStartBeat + measure * BEATS_PER_MEASURE;\n\n      // Reuse existing bass pattern resolution logic\n      const bassPattern = resolveBassPattern(\n        section,\n        measure,\n        voiceRng,\n        usedBassPatterns,\n        bassPatternCache,\n        styleIntent,\n        role === \"bassAlt\"\n          ? { enforceDroneStatic: false, preferredTags: [\"drone\", \"accent\"] }\n          : undefined\n      );\n\n      // Build bass notes with adjusted base MIDI\n      const chord = resolveChordAtBeat(phase1, measureStartBeat);\n      const nextChord = resolveChordAtBeat(phase1, measureStartBeat + BEATS_PER_MEASURE);\n\n      const patternNotes = buildBassPatternWithBaseMidi(\n        section,\n        measureStartBeat,\n        chord,\n        nextChord,\n        bassPattern,\n        baseBassMidi,\n        octaveOffset\n      );\n\n      bassNotes.push(...patternNotes);\n    }\n  }\n\n  return bassNotes;\n}\n\n/**\n * Generate pad track (long sustained notes from accompaniment seeds)\n */\nfunction generatePadTrackForVoice(\n  priority: number,\n  options: PipelineCompositionOptions,\n  phase1: StructurePlanResult,\n  baseSeed: number\n): AbstractNote[] {\n  const voiceRng = createRng(baseSeed);\n  const padNotes: AbstractNote[] = [];\n\n  for (const section of phase1.sections) {\n    const sectionStartBeat = section.startMeasure * BEATS_PER_MEASURE;\n\n    for (let measure = 0; measure < section.measures; measure++) {\n      if (!shouldGenerateForVoice(priority, measure, section.measures, phase1.styleIntent, voiceRng)) {\n        continue;\n      }\n\n      const measureStartBeat = sectionStartBeat + measure * BEATS_PER_MEASURE;\n\n      // Generate one long pad note per measure (root or fifth)\n      const degree = (measure % 2 === 0) ? 1 : 5;\n      padNotes.push({\n        channelRole: \"accompaniment\",\n        startBeat: measureStartBeat,\n        durationBeats: BEATS_PER_MEASURE,\n        degree,\n        velocity: VELOCITY_ACCOMPANIMENT.PAD_MIN,\n        sectionId: section.id\n      });\n    }\n  }\n\n  return padNotes;\n}\n\n// Note: Old helper functions (ensureTemplateCache, lookupRhythmFromCache, lookupMelodyFromCache)\n// removed per REFACTOR_PLAN.md Step 1-C - replaced by getOrCreateTemplateCache above\n","import {\n  PipelineCompositionOptions,\n  StructurePlanResult,\n  MotifSelectionResult,\n  EventRealizationResult,\n  TimedEvent,\n  NoteOnEventData,\n  NoteOffEventData,\n  MidiNote,\n  StyleIntent,\n  TextureProfile,\n  TempoSetting,\n  SectionDefinition,\n  Voice\n} from \"../types.js\";\nimport {\n  BEATS_PER_MEASURE,\n  chordRootToMidi,\n  ensureConsonantPitch,\n  getChordIntervals,\n  quantizeMidiToChord,\n  resolveChordAtBeat\n} from \"../musicUtils.js\";\n\nimport {\n  VELOCITY_GLOBAL,\n  VELOCITY_CHANNEL_SCALE,\n  VELOCITY_PITCH_THRESHOLD,\n  VELOCITY_ACCOMPANIMENT,\n  VELOCITY_TECHNIQUE,\n  VELOCITY_NOISE\n} from \"../constants/velocity-config.js\";\n\nconst RNG_SEED = 42;\nconst NOISE_MAX_DURATION_BEATS = 0.5;\nconst NOISE_MIN_RELEASE_SECONDS = 0.015;\nconst NOISE_MAX_RELEASE_SECONDS = 0.12;\nconst NOISE_STACK_OFFSET = 1 / 16;  // Changed from 1/64 to 1/16 beat for safer collision avoidance\n\n// Arpeggio generation probabilities and thresholds (score.md:134)\ninterface ArpeggioProfile {\n  reverseProbability: number;\n  sustainProbability: number;\n  densityThresholds: {\n    sparse: number;\n    normal: number;\n  };\n}\n\ntype NoiseModeLabel = \"long\" | \"short\";\n\ninterface NoiseInstrumentConfig {\n  mode: NoiseModeLabel;\n  spec: \"long_period\" | \"short_period\";\n  periodIndex: number;\n  releaseRange: [number, number];\n  velocity: number;\n  amplitude: number;\n}\n\nconst NOISE_MODE_CONFIG: Record<string, NoiseInstrumentConfig> = {\n  K: { mode: \"long\", spec: \"long_period\", periodIndex: 3, releaseRange: [0.045, 0.075], velocity: VELOCITY_NOISE.KICK, amplitude: 1.0 },\n  T: { mode: \"long\", spec: \"long_period\", periodIndex: 5, releaseRange: [0.05, 0.09], velocity: VELOCITY_NOISE.TOM, amplitude: 0.92 },\n  N: { mode: \"long\", spec: \"long_period\", periodIndex: 8, releaseRange: [0.06, 0.1], velocity: VELOCITY_NOISE.LOW_NOISE, amplitude: 0.88 },\n  S: { mode: \"short\", spec: \"short_period\", periodIndex: 1, releaseRange: [0.02, 0.045], velocity: VELOCITY_NOISE.SNARE, amplitude: 0.9 },\n  H: { mode: \"short\", spec: \"short_period\", periodIndex: 0, releaseRange: [0.015, 0.03], velocity: VELOCITY_NOISE.HIHAT, amplitude: 0.86 },\n  O: { mode: \"short\", spec: \"short_period\", periodIndex: 2, releaseRange: [0.03, 0.055], velocity: VELOCITY_NOISE.OPEN_HAT, amplitude: 0.94 }\n};;\n\nconst PORTAMENTO_MAX_INTERVAL = 5;\nconst PORTAMENTO_DURATION_SECONDS = 0.06;\n\nfunction createRng(seed: number) {\n  let value = seed;\n  return () => {\n    value = (value * 1664525 + 1013904223) % 4294967296;\n    return value / 4294967296;\n  };\n}\n\nfunction adjustVelocityForChannel(\n  channel: TimedEvent[\"channel\"],\n  role: string,\n  midi: number,\n  velocity: number\n): number {\n  let scale = 1;\n\n  const isBassRole = role === \"bass\" || role === \"bassAlt\";\n  const isSquare = channel === \"square1\" || channel === \"square2\";\n\n  // Apply bass role scaling\n  if (isBassRole) {\n    scale *= VELOCITY_CHANNEL_SCALE.BASS_BASE;\n    if (midi < VELOCITY_PITCH_THRESHOLD.BASS_LOW_RANGE) {\n      scale *= VELOCITY_CHANNEL_SCALE.BASS_LOW_RANGE;\n    }\n  }\n\n  // Apply triangle channel scaling\n  if (channel === \"triangle\") {\n    scale *= VELOCITY_CHANNEL_SCALE.TRIANGLE_BASE;\n    if (!isBassRole) {\n      scale *= VELOCITY_CHANNEL_SCALE.TRIANGLE_NON_BASS;\n    }\n  }\n\n  // Apply square bass scaling\n  if (isSquare && isBassRole) {\n    scale *= VELOCITY_CHANNEL_SCALE.SQUARE_BASS;\n  }\n\n  const scaled = Math.round(velocity * scale);\n  return Math.max(VELOCITY_GLOBAL.MIN, Math.min(VELOCITY_GLOBAL.MAX_ACCENT, scaled));\n}\n\nfunction resolveArpeggioProfile(styleIntent: StyleIntent, texture: TextureProfile | undefined): ArpeggioProfile {\n  const profile: ArpeggioProfile = {\n    reverseProbability: 0.5,\n    sustainProbability: 0.2,\n    densityThresholds: { sparse: 0.45, normal: 0.85 }\n  };\n\n  if (styleIntent.textureFocus) {\n    profile.reverseProbability = 0.35;\n    profile.sustainProbability = 0.12;\n    profile.densityThresholds = { sparse: 0.3, normal: 0.7 };\n  }\n  if (styleIntent.loopCentric) {\n    profile.sustainProbability = Math.min(0.35, profile.sustainProbability + 0.1);\n    profile.densityThresholds = {\n      sparse: Math.min(0.5, profile.densityThresholds.sparse + 0.05),\n      normal: Math.min(0.95, profile.densityThresholds.normal + 0.05)\n    };\n  }\n  if (texture === \"arpeggio\" && styleIntent.gradualBuild) {\n    profile.densityThresholds = { sparse: 0.25, normal: 0.65 };\n  }\n\n  return profile;\n}\n\n/**\n * Determine if portamento should be applied to a note transition.\n * Uses style-based fixed probabilities instead of complex parameter-dependent calculation.\n * \n * @param note - Current note\n * @param next - Next note in sequence\n * @param noteDuration - Duration of current note in beats\n * @param styleIntent - Style intent flags\n * @param rng - Random number generator\n * @returns true if portamento should be applied\n */\nfunction shouldApplyPortamento(\n  note: MidiNote,\n  next: MidiNote,\n  noteDuration: number,\n  styleIntent: StyleIntent,\n  rng: () => number\n): boolean {\n  const interval = Math.abs(next.midi - note.midi);\n  const gap = next.startBeat - (note.startBeat + noteDuration);\n\n  // Basic eligibility checks\n  const eligibleInterval = interval > 0 && interval <= PORTAMENTO_MAX_INTERVAL;\n  const consecutive = gap >= -1e-3 && gap <= 0.5;\n  const sufficientDuration = noteDuration >= 0.5;\n\n  if (!eligibleInterval || !consecutive || !sufficientDuration) {\n    return false;\n  }\n\n  // Style-based probability\n  let probability = 0.15; // default\n\n  if (styleIntent.atmosPad) {\n    probability = 0.4;\n  } else if (styleIntent.loopCentric && styleIntent.textureFocus) {\n    // lofi chillhop style\n    probability = 0.35;\n  } else if (styleIntent.gradualBuild && styleIntent.breakInsertion) {\n    // progressive house style\n    probability = 0.25;\n  }\n\n  return rng() < probability;\n}\n\nfunction computePortamentoDurationSeconds(\n  baseDuration: number,\n  tempo: TempoSetting,\n  interval: number\n): number {\n  let duration = baseDuration;\n  if (tempo === \"slow\") {\n    duration += 0.02;\n  } else if (tempo === \"fast\") {\n    duration -= 0.015;\n  }\n  if (interval >= 4) {\n    duration += 0.01;\n  }\n  return Math.max(0.02, Math.min(0.12, duration));\n}\n\n/**\n * Whitelist-based noise stacking permission (REFACTORING_ROADMAP.md P0-3)\n * Only explicitly safe instrument pairs are allowed to stack closely\n */\nfunction allowsNoiseStacking(previousInstrument: string | null, currentInstrument: string): boolean {\n  if (!previousInstrument) {\n    return false;\n  }\n  const combo = `${previousInstrument}|${currentInstrument}`;\n  // Whitelist: Only hi-hat family transitions are safe to stack\n  return combo === \"H|H\" || combo === \"H|O\" || combo === \"O|H\";\n}\n\nfunction resolveNoiseRelease(\n  config: NoiseInstrumentConfig | undefined,\n  styleIntent: StyleIntent,\n  rng: () => number\n): number {\n  const range = config?.releaseRange ?? [NOISE_MIN_RELEASE_SECONDS, NOISE_MAX_RELEASE_SECONDS];\n  const base = range[0] + rng() * Math.max(0, range[1] - range[0]);\n  if (styleIntent.percussiveLayering) {\n    return Math.max(range[0], base * 0.85);\n  }\n  if (styleIntent.gradualBuild) {\n    return Math.min(range[1], base * 1.05);\n  }\n  return base;\n}\n\ntype NoteEventPayload = NoteOnEventData & {\n  midi: number;\n  velocity: number;\n};\n\nfunction deriveArpeggioPattern(chordIntervals: number[]): number[] {\n  const cycle = chordIntervals.length > 0 ? chordIntervals : [0, 4, 7];\n  const pattern: number[] = [];\n  for (let i = 0; i < 4; i++) {\n    const baseInterval = cycle[i % cycle.length];\n    const octaveOffset = Math.floor(i / cycle.length) * 12;\n    pattern.push(baseInterval + octaveOffset);\n  }\n  return pattern;\n}\n\nfunction maybeReversePattern(rng: () => number, pattern: number[], probability: number): number[] {\n  return rng() < probability ? [...pattern].reverse() : pattern;\n}\n\nfunction buildFastArpeggioNotes(\n  seed: MidiNote,\n  chord: string,\n  rng: () => number,\n  styleIntent: StyleIntent,\n  texture: TextureProfile | undefined\n): MidiNote[] {\n  const profile = resolveArpeggioProfile(styleIntent, texture);\n  const baseVelocity = Math.max(VELOCITY_ACCOMPANIMENT.PAD_MIN, Math.round(seed.velocity * VELOCITY_ACCOMPANIMENT.ARPEGGIO_SCALE));\n  if (rng() < profile.sustainProbability) {\n    // Probabilistically sustain instead of arpeggiating\n    const sustainedMidi = ensureConsonantPitch(seed.midi, chord, seed.midi);\n    return [\n      {\n        ...seed,\n        startBeat: seed.startBeat,\n        durationBeats: Math.max(seed.durationBeats, 1),\n        velocity: baseVelocity,\n        midi: sustainedMidi\n      }\n    ];\n  }\n\n  const pattern = maybeReversePattern(\n    rng,\n    deriveArpeggioPattern(getChordIntervals(chord)),\n    profile.reverseProbability\n  );\n  const densityRoll = rng();\n  let subdivisions: number;\n  if (densityRoll < profile.densityThresholds.sparse) {\n    subdivisions = 2;  // 8th notes\n  } else if (densityRoll < profile.densityThresholds.normal) {\n    subdivisions = 4;  // 16th notes as per spec\n  } else {\n    subdivisions = 1;  // held note\n  }\n\n  const stepDuration = subdivisions === 4 ? 0.25 : subdivisions === 2 ? 0.5 : Math.max(seed.durationBeats, 1);\n\n  const notes: MidiNote[] = [];\n  for (let step = 0; step < subdivisions; step++) {\n    const offsetBeat = seed.startBeat + stepDuration * step;\n    const interval = pattern[step % pattern.length];\n    const candidate = quantizeMidiToChord(seed.midi + interval, chord);\n    const midi = ensureConsonantPitch(candidate, chord, seed.midi);\n    notes.push({\n      channelRole: \"accompaniment\",\n      startBeat: offsetBeat,\n      durationBeats: stepDuration,\n      degree: seed.degree,\n      velocity: baseVelocity,\n      sectionId: seed.sectionId,\n      midi\n    });\n  }\n  return notes;\n}\n\nfunction buildBrokenChordNotes(seeds: MidiNote[]): MidiNote[] {\n  const notes: MidiNote[] = [];\n  for (const seed of seeds) {\n    const offsets = [0, 0.5];\n    for (const offset of offsets) {\n      notes.push({\n        ...seed,\n        startBeat: seed.startBeat + offset,\n        durationBeats: 0.5,\n        velocity: Math.max(VELOCITY_ACCOMPANIMENT.PAD_MIN, Math.round(seed.velocity * VELOCITY_ACCOMPANIMENT.BROKEN_SCALE))\n      });\n    }\n  }\n  return notes;\n}\n\nfunction buildSteadyChordNotes(seeds: MidiNote[]): MidiNote[] {\n  return seeds.map((seed) => ({\n    ...seed,\n    durationBeats: seed.durationBeats >= 1 ? seed.durationBeats : 1,\n    velocity: Math.max(VELOCITY_ACCOMPANIMENT.PAD_MIN, Math.round(seed.velocity * VELOCITY_ACCOMPANIMENT.STEADY_SCALE))\n  }));\n}\n\n/**\n * Context object containing shared state for event realization.\n * Groups common parameters to reduce function argument count.\n */\ninterface RealizationContext {\n  rng: () => number;\n  sectionById: Map<string, SectionDefinition>;\n  totalBeats: number;\n  styleIntent: StyleIntent;\n  tempoSetting: TempoSetting;\n  phase1: StructurePlanResult;\n  phase2: MotifSelectionResult;\n}\n\n/**\n * Creates a RealizationContext from composition options and phase results.\n */\nfunction createRealizationContext(\n  options: PipelineCompositionOptions,\n  phase1: StructurePlanResult,\n  phase2: MotifSelectionResult\n): RealizationContext {\n  return {\n    rng: createRng(options.seed ?? RNG_SEED),\n    sectionById: new Map(phase1.sections.map((section) => [section.id, section])),\n    totalBeats: (options.lengthInMeasures ?? 32) * BEATS_PER_MEASURE,\n    styleIntent: phase1.styleIntent,\n    tempoSetting: options.tempo ?? \"medium\",\n    phase1,\n    phase2\n  };\n}\n\n/**\n * Realizes melody track with portamento support.\n * Handles melody and melodyAlt roles.\n */\nfunction realizeMelodyTrack(\n  track: MotifSelectionResult[\"tracks\"][number],\n  voiceConfig: Voice,\n  context: RealizationContext\n): TimedEvent[] {\n  const events: TimedEvent[] = [];\n  const channel = voiceConfig.channel;\n\n  for (let i = 0; i < track.notes.length; i++) {\n    const note = track.notes[i];\n    const sectionMeta = context.sectionById.get(note.sectionId);\n    const measureInSection = sectionMeta\n      ? Math.max(0, Math.floor(note.startBeat / BEATS_PER_MEASURE) - sectionMeta.startMeasure)\n      : 0;\n\n    const payload: NoteEventPayload = {\n      midi: note.midi,\n      velocity: adjustVelocityForChannel(channel, voiceConfig.role, note.midi, note.velocity)\n    };\n\n    // Apply portamento if eligible\n    const next = track.notes[i + 1];\n    if (next && shouldApplyPortamento(note, next, note.durationBeats, context.styleIntent, context.rng)) {\n      const interval = Math.abs(next.midi - note.midi);\n      payload.slide = {\n        targetMidi: next.midi,\n        durationSeconds: computePortamentoDurationSeconds(\n          PORTAMENTO_DURATION_SECONDS,\n          context.tempoSetting,\n          interval\n        )\n      };\n    }\n\n    pushNote(events, note.startBeat, note.durationBeats, channel, payload, context.totalBeats);\n  }\n\n  return events;\n}\n\n/**\n * Realizes bass track with simple note generation.\n * Handles bass and bassAlt roles.\n */\nfunction realizeBassTrack(\n  track: MotifSelectionResult[\"tracks\"][number],\n  voiceConfig: Voice,\n  context: RealizationContext\n): TimedEvent[] {\n  const events: TimedEvent[] = [];\n  const channel = voiceConfig.channel;\n\n  for (const note of track.notes) {\n    pushNote(events, note.startBeat, note.durationBeats, channel, {\n      midi: note.midi,\n      velocity: adjustVelocityForChannel(channel, voiceConfig.role, note.midi, note.velocity)\n    }, context.totalBeats);\n  }\n\n  return events;\n}\n\n/**\n * Realizes accompaniment track with texture techniques.\n * Handles accompaniment and pad roles.\n */\nfunction realizeAccompanimentTrack(\n  track: MotifSelectionResult[\"tracks\"][number],\n  voiceConfig: Voice,\n  context: RealizationContext\n): TimedEvent[] {\n  const events: TimedEvent[] = [];\n  const channel = voiceConfig.channel;\n\n  // Group seeds by measure\n  const seedsByMeasure = new Map<number, MidiNote[]>();\n  for (const seed of track.notes) {\n    const measure = Math.floor(seed.startBeat / BEATS_PER_MEASURE);\n    const bucket = seedsByMeasure.get(measure) ?? [];\n    bucket.push(seed);\n    seedsByMeasure.set(measure, bucket);\n  }\n\n  const sortedMeasures = Array.from(seedsByMeasure.keys()).sort((a, b) => a - b);\n\n  for (const measure of sortedMeasures) {\n    const seeds = seedsByMeasure.get(measure)!;\n    const sectionMeta = seeds.length ? context.sectionById.get(seeds[0].sectionId) : undefined;\n    const texture = sectionMeta?.texture ?? \"steady\";\n    const chord = resolveChordAtBeat(context.phase1, seeds[0]?.startBeat ?? measure * BEATS_PER_MEASURE);\n\n    // Process notes based on texture\n    let processedNotes: MidiNote[];\n    if (texture === \"arpeggio\") {\n      processedNotes = seeds.flatMap((seed) =>\n        buildFastArpeggioNotes(seed, chord, context.rng, context.styleIntent, sectionMeta?.texture)\n      );\n    } else if (texture === \"broken\") {\n      processedNotes = buildBrokenChordNotes(seeds);\n    } else {\n      processedNotes = buildSteadyChordNotes(seeds);\n    }\n\n    // Apply echo and detune techniques\n    const echoNotes: MidiNote[] = [];\n    const detuneNotes: MidiNote[] = [];\n    for (const note of processedNotes) {\n      if (context.rng() < context.phase1.techniqueStrategy.echoProbability) {\n        echoNotes.push({\n          ...note,\n          startBeat: note.startBeat + 0.25,\n          velocity: Math.round(note.velocity * VELOCITY_TECHNIQUE.ECHO_SCALE)\n        });\n      }\n      if (context.rng() < context.phase1.techniqueStrategy.detuneProbability) {\n        detuneNotes.push({\n          ...note,\n          startBeat: note.startBeat,\n          velocity: Math.round(note.velocity * VELOCITY_TECHNIQUE.DETUNE_SCALE),\n          midi: note.midi,\n          detuneCents: 12\n        });\n      }\n    }\n\n    // Ensure consonance and push events\n    const allNotes = [...processedNotes, ...echoNotes, ...detuneNotes].map((note) => {\n      const chord = resolveChordAtBeat(context.phase1, note.startBeat);\n      const melodyTrack = context.phase2.tracks.find(t => t.role === \"melody\");\n      const reference = melodyTrack ? findMelodyOverlap(note.startBeat, melodyTrack.notes) : undefined;\n      const midi = ensureConsonantPitch(note.midi, chord, reference?.midi ?? note.midi);\n      return { ...note, midi };\n    });\n\n    for (const note of allNotes) {\n      pushNote(events, note.startBeat, note.durationBeats, channel, {\n        midi: note.midi,\n        velocity: adjustVelocityForChannel(channel, voiceConfig.role, note.midi, note.velocity),\n        detuneCents: note.detuneCents\n      } as NoteEventPayload, context.totalBeats);\n    }\n  }\n\n  return events;\n}\n\n/**\n * Realizes drum events with noise channel collision avoidance.\n * Always outputs to the noise channel.\n */\nfunction realizeDrumEvents(\n  drums: MotifSelectionResult[\"drums\"],\n  context: RealizationContext\n): TimedEvent[] {\n  const noiseEvents: TimedEvent[] = [];\n  let lastNoiseOffBeat: number | null = null;\n  let lastNoiseOnBeat: number | null = null;\n  let lastNoiseInstrument: string | null = null;\n\n  // Sort drums by start beat before processing\n  const sortedDrums = [...drums].sort((a, b) => a.startBeat - b.startBeat);\n\n  for (const hit of sortedDrums) {\n    let adjustedStart = hit.startBeat;\n\n    const config = NOISE_MODE_CONFIG[hit.instrument];\n    if (!config) continue;\n\n    const canStack = allowsNoiseStacking(lastNoiseInstrument, hit.instrument);\n    const stackOffset = canStack ? 0 : NOISE_STACK_OFFSET;\n\n    // Adjust start time if too close to last note\n    // Use <= to catch exact collisions even when stackOffset=0 (stackable instruments)\n    if (lastNoiseOnBeat !== null && adjustedStart - lastNoiseOnBeat <= stackOffset) {\n      adjustedStart = lastNoiseOnBeat + Math.max(stackOffset, NOISE_STACK_OFFSET);\n    }\n\n    const releaseSec = resolveNoiseRelease(config, context.styleIntent, context.rng);\n    const decaySec = Math.max(0.01, Math.min(releaseSec * 0.7, releaseSec));\n    const clampedDuration = Math.min(hit.durationBeats, NOISE_MAX_DURATION_BEATS);\n\n    if (adjustedStart >= context.totalBeats) continue;\n\n    // If this noteOn would start before the last noteOff, cancel the previous note\n    if (lastNoiseOffBeat !== null && adjustedStart < lastNoiseOffBeat) {\n      if (canStack && noiseEvents.length >= 2) {\n        const lastOffEvent = noiseEvents[noiseEvents.length - 1];\n        if (lastOffEvent.command === \"noteOff\") {\n          lastOffEvent.beatTime = adjustedStart;\n        }\n        lastNoiseOffBeat = adjustedStart;\n      } else {\n        noiseEvents.pop(); // Remove noteOff\n        noiseEvents.pop(); // Remove noteOn\n        lastNoiseOffBeat = null;\n        lastNoiseOnBeat = null;\n      }\n    }\n\n    // Add noteOn\n    noiseEvents.push({\n      beatTime: adjustedStart,\n      channel: \"noise\",\n      command: \"noteOn\",\n      data: {\n        noiseMode: config.spec,\n        mode: config.spec,\n        velocity: config.velocity,\n        amplitude: config.amplitude,\n        releaseSeconds: releaseSec,\n        decaySeconds: decaySec,\n        periodIndex: config.periodIndex,\n        clockDivider: config.periodIndex\n      }\n    });\n\n    // Add noteOff\n    const offBeat = Math.min(adjustedStart + clampedDuration, context.totalBeats);\n    noiseEvents.push({\n      beatTime: offBeat,\n      channel: \"noise\",\n      command: \"noteOff\",\n      data: {}\n    });\n\n    lastNoiseOffBeat = offBeat;\n    lastNoiseOnBeat = adjustedStart;\n    lastNoiseInstrument = hit.instrument;\n  }\n\n  return noiseEvents;\n}\n\n/**\n * Routes track realization based on voice role.\n */\nfunction realizeTrack(\n  track: MotifSelectionResult[\"tracks\"][number],\n  voiceConfig: Voice,\n  context: RealizationContext\n): TimedEvent[] {\n  const role = voiceConfig.role;\n\n  if (role === \"melody\" || role === \"melodyAlt\") {\n    return realizeMelodyTrack(track, voiceConfig, context);\n  } else if (role === \"bass\" || role === \"bassAlt\") {\n    return realizeBassTrack(track, voiceConfig, context);\n  } else if (role === \"accompaniment\" || role === \"pad\") {\n    return realizeAccompanimentTrack(track, voiceConfig, context);\n  }\n\n  return [];\n}\n\nexport function realizeEvents(\n  options: PipelineCompositionOptions,\n  phase1: StructurePlanResult,\n  phase2: MotifSelectionResult\n): EventRealizationResult {\n  const context = createRealizationContext(options, phase1, phase2);\n  const events: TimedEvent[] = [];\n\n  // Process each track based on its role\n  for (const track of phase2.tracks) {\n    const voiceConfig = phase1.voiceArrangement.voices.find(v => v.role === track.role);\n    if (!voiceConfig) {\n      continue; // Skip tracks without voice config\n    }\n\n    const trackEvents = realizeTrack(track, voiceConfig, context);\n    events.push(...trackEvents);\n  }\n\n  // Generate drum events\n  const drumEvents = realizeDrumEvents(phase2.drums, context);\n  events.push(...drumEvents);\n\n  // Sort all events by beat time\n  events.sort((a, b) => a.beatTime - b.beatTime);\n\n  const diagnostics = computeVoiceAllocation(events);\n  return { events, diagnostics };\n}\n\nfunction pushNote(\n  events: TimedEvent[],\n  startBeat: number,\n  durationBeats: number,\n  channel: TimedEvent[\"channel\"],\n  data: NoteEventPayload,\n  totalBeats: number,\n  noteOffData: NoteOffEventData = {}\n) {\n  // Boundary check: skip notes that start at or beyond totalBeats\n  if (startBeat >= totalBeats) {\n    return;\n  }\n\n  events.push({\n    beatTime: startBeat,\n    channel,\n    command: \"noteOn\",\n    data\n  });\n\n  // Clamp noteOff to totalBeats boundary\n  const endBeat = Math.min(startBeat + durationBeats, totalBeats);\n  events.push({\n    beatTime: endBeat,\n    channel,\n    command: \"noteOff\",\n    data: noteOffData\n  });\n}\n\nfunction computeVoiceAllocation(events: TimedEvent[]): EventRealizationResult[\"diagnostics\"] {\n  const channelCounts = new Map<TimedEvent[\"channel\"], number>();\n  const diagnostics: EventRealizationResult[\"diagnostics\"] = { voiceAllocation: [] };\n\n  for (const event of events) {\n    if (!channelCounts.has(event.channel)) {\n      channelCounts.set(event.channel, 0);\n    }\n    const current = channelCounts.get(event.channel)!;\n    if (event.command === \"noteOn\") {\n      channelCounts.set(event.channel, current + 1);\n    } else if (event.command === \"noteOff\" && current > 0) {\n      channelCounts.set(event.channel, current - 1);\n    }\n    diagnostics.voiceAllocation.push({\n      beatTime: event.beatTime,\n      channel: event.channel,\n      activeCount: channelCounts.get(event.channel)!\n    });\n  }\n\n  return diagnostics;\n}\n\nfunction findMelodyOverlap(beat: number, melody: MidiNote[]): MidiNote | undefined {\n  return melody.find((note) => beat >= note.startBeat && beat < note.startBeat + note.durationBeats);\n}\n","import { EventRealizationResult, StyleIntent, TimedEvent, TechniqueLibrary } from \"../types.js\";\nimport { BEATS_PER_MEASURE } from \"../musicUtils.js\";\nimport techniqueLibraryJson from \"../../motifs/techniques.json\" with { type: \"json\" };\n\nconst techniqueLibrary = techniqueLibraryJson as TechniqueLibrary;\n\ninterface TechniquesPostprocessResult {\n  events: TimedEvent[];\n}\n\nconst GRADUAL_BUILD_GAIN_RAMP: Record<TimedEvent[\"channel\"], { base: number; peak: number }> = {\n  square1: { base: 0.68, peak: 0.9 },\n  square2: { base: 0.66, peak: 0.88 },\n  triangle: { base: 0.48, peak: 0.68 },\n  noise: { base: 0.74, peak: 0.82 }\n};\n\nexport function applyTechniques(phase3: EventRealizationResult, styleIntent: StyleIntent): TechniquesPostprocessResult {\n  const additionalEvents: TimedEvent[] = [];\n  const totalTrackBeats = phase3.events.reduce((max, event) => Math.max(max, event.beatTime), 0);\n  const totalMeasures = Math.max(1, Math.ceil(totalTrackBeats / BEATS_PER_MEASURE));\n\n  for (const preset of techniqueLibrary.initialParams ?? []) {\n    additionalEvents.push({\n      beatTime: 0,\n      channel: preset.channel,\n      command: \"setParam\",\n      data: { param: preset.param, value: preset.value }\n    });\n  }\n\n  const dutySweeps = [...(techniqueLibrary.dutySweeps ?? [])];\n  const gainProfiles = [...(techniqueLibrary.gainProfiles ?? [])];\n\n  if (styleIntent.filterMotion) {\n    dutySweeps.push({\n      id: \"STYLE_FILTER_SWELL\",\n      param: \"duty\",\n      channels: [\"square1\", \"square2\"],\n      minDurationBeats: 2,\n      steps: [0.2, 0.6, 0.4, 0.75]\n    });\n  }\n\n  if (styleIntent.percussiveLayering) {\n    gainProfiles.push({\n      id: \"STYLE_NOISE_PUNCH\",\n      channel: \"noise\",\n      param: \"gain\",\n      measureBoundaryValue: 0.85,\n      defaultValue: 0.78\n    });\n  }\n\n  if (styleIntent.percussiveLayering && !styleIntent.breakInsertion) {\n    gainProfiles.push(\n      {\n        id: \"STYLE_MINIMAL_SIDECHAIN_SQ1\",\n        channel: \"square1\",\n        param: \"gain\",\n        measureBoundaryValue: 0.74,\n        defaultValue: 0.62\n      },\n      {\n        id: \"STYLE_MINIMAL_SIDECHAIN_SQ2\",\n        channel: \"square2\",\n        param: \"gain\",\n        measureBoundaryValue: 0.72,\n        defaultValue: 0.6\n      }\n    );\n  }\n\n  if (styleIntent.atmosPad) {\n    gainProfiles.push({\n      id: \"STYLE_TRIANGLE_PAD\",\n      channel: \"triangle\",\n      param: \"gain\",\n      measureBoundaryValue: 0.82,\n      defaultValue: 0.72\n    });\n  }\n\n  if (styleIntent.gradualBuild && styleIntent.breakInsertion) {\n    dutySweeps.push({\n      id: \"STYLE_PROGRESSIVE_DUTY_SWELL\",\n      param: \"duty\",\n      channels: [\"square2\"],\n      minDurationBeats: 1,\n      steps: [0.32, 0.48, 0.58, 0.68]\n    });\n  }\n\n  if (styleIntent.gradualBuild && styleIntent.breakInsertion) {\n    gainProfiles.push({\n      id: \"STYLE_PROGRESSIVE_TRI_RISE\",\n      channel: \"triangle\",\n      param: \"gain\",\n      measureBoundaryValue: 0.9,\n      defaultValue: 0.76\n    });\n  }\n\n  const breakMeasures = new Set<number>();\n  for (const event of phase3.events) {\n    if (event.command !== \"noteOn\") continue;\n    const offEvent = findMatchingNoteOff(phase3.events, event);\n    const duration = offEvent ? offEvent.beatTime - event.beatTime : 0;\n\n    for (const sweep of dutySweeps) {\n      if (!sweep.channels.includes(event.channel)) continue;\n      if (!offEvent) continue;\n      if (duration < sweep.minDurationBeats) continue;\n      if (sweep.requireMeasureBoundary) {\n        const boundary =\n          isMeasureBoundary(event.beatTime) || (offEvent ? isMeasureBoundary(offEvent.beatTime) : false);\n        if (!boundary) continue;\n      }\n      const stepSpacing = duration / (sweep.steps.length + 1);\n      sweep.steps.forEach((value, index) => {\n        additionalEvents.push({\n          beatTime: event.beatTime + stepSpacing * (index + 1),\n          channel: event.channel,\n          command: \"setParam\",\n          data: { param: sweep.param, value }\n        });\n      });\n    }\n\n    for (const profile of gainProfiles) {\n      if (event.channel !== profile.channel) continue;\n      const value = isMeasureBoundary(event.beatTime) ? profile.measureBoundaryValue : profile.defaultValue;\n      additionalEvents.push({\n        beatTime: event.beatTime,\n        channel: event.channel,\n        command: \"setParam\",\n        data: { param: profile.param, value }\n      });\n    }\n\n    if (styleIntent.breakInsertion && event.channel === \"noise\") {\n      const measureIndex = Math.floor(event.beatTime / BEATS_PER_MEASURE);\n      if (!breakMeasures.has(measureIndex) && measureIndex > 0 && (measureIndex + 1) % 8 === 0) {\n        breakMeasures.add(measureIndex);\n        const startBeat = measureIndex * BEATS_PER_MEASURE;\n        additionalEvents.push({\n          beatTime: startBeat - 0.25 >= 0 ? startBeat - 0.25 : startBeat,\n          channel: \"noise\",\n          command: \"setParam\",\n          data: { param: \"gain\", value: 0.45 }\n        });\n        additionalEvents.push({\n          beatTime: startBeat + 1,\n          channel: \"noise\",\n          command: \"setParam\",\n          data: { param: \"gain\", value: 0.78 }\n        });\n        for (const squareChannel of [\"square1\", \"square2\"] as const) {\n          additionalEvents.push({\n            beatTime: startBeat - 0.25 >= 0 ? startBeat - 0.25 : startBeat,\n            channel: squareChannel,\n            command: \"setParam\",\n            data: { param: \"gain\", value: 0.55 }\n          });\n          additionalEvents.push({\n            beatTime: startBeat + 1,\n            channel: squareChannel,\n            command: \"setParam\",\n            data: { param: \"gain\", value: 0.82 }\n          });\n        }\n      }\n    }\n  }\n\n  if (styleIntent.gradualBuild && totalMeasures > 1) {\n    const measureStep = Math.max(1, Math.floor(totalMeasures / 8));\n    for (const [channel, ramp] of Object.entries(GRADUAL_BUILD_GAIN_RAMP)) {\n      const typedChannel = channel as TimedEvent[\"channel\"];\n      for (let measure = 0; measure < totalMeasures; measure += measureStep) {\n        const progress = totalMeasures > 1 ? measure / (totalMeasures - 1) : 1;\n        const shaped = Math.pow(progress, styleIntent.loopCentric ? 0.8 : 1.0);\n        const value = ramp.base + (ramp.peak - ramp.base) * shaped;\n        additionalEvents.push({\n          beatTime: measure * BEATS_PER_MEASURE,\n          channel: typedChannel,\n          command: \"setParam\",\n          data: { param: \"gain\", value: Number(value.toFixed(3)) }\n        });\n      }\n    }\n  }\n\n  // Loop tail fade removed for seamless loop playback (game BGM requirement)\n  // Previously faded out the last beat, which broke infinite looping\n\n  const merged = [...phase3.events, ...additionalEvents];\n  merged.sort((a, b) => {\n    if (a.beatTime === b.beatTime) {\n      if (a.command === b.command) return 0;\n      if (a.command === \"setParam\") return -1;\n      if (b.command === \"setParam\") return 1;\n      return 0;\n    }\n    return a.beatTime - b.beatTime;\n  });\n\n  return { events: merged };\n}\n\nfunction findMatchingNoteOff(events: TimedEvent[], onEvent: TimedEvent): TimedEvent | undefined {\n  if (onEvent.command !== \"noteOn\") return undefined;\n\n  // For each noteOn, find the next noteOff on the same channel\n  // Note: noteOff events don't carry midi information, so we match by channel and timing\n  let matchingOff: TimedEvent | undefined;\n  let minTimeDiff = Infinity;\n\n  for (const event of events) {\n    if (\n      event.channel === onEvent.channel &&\n      event.command === \"noteOff\" &&\n      event.beatTime > onEvent.beatTime\n    ) {\n      const timeDiff = event.beatTime - onEvent.beatTime;\n      if (timeDiff < minTimeDiff) {\n        minTimeDiff = timeDiff;\n        matchingOff = event;\n      }\n    }\n  }\n\n  return matchingOff;\n}\n\nfunction isMeasureBoundary(beatTime: number): boolean {\n  const epsilon = 1e-6;\n  return Math.abs((beatTime % BEATS_PER_MEASURE)) < epsilon;\n}\n","import {\n  Diagnostics,\n  Event,\n  StructurePlanResult,\n  EventRealizationDiagnostics,\n  SectionMotifPlan,\n  TimedEvent\n} from \"../types.js\";\n\ninterface TimelineFinalizationResult {\n  events: Event[];\n  diagnostics: Diagnostics;\n}\n\nexport function finalizeTimeline(\n  phase1: StructurePlanResult,\n  techniquesEvents: TimedEvent[],\n  eventDiagnostics: EventRealizationDiagnostics,\n  motifUsage: Diagnostics[\"motifUsage\"],\n  sectionMotifPlan: SectionMotifPlan[]\n): TimelineFinalizationResult {\n  const beatToSecond = 60 / phase1.bpm;\n  const events: Event[] = techniquesEvents.map((event) => ({\n    time: event.beatTime * beatToSecond,\n    channel: event.channel,\n    command: event.command,\n    data: event.data\n  }));\n  events.sort((a, b) => a.time - b.time);\n\n  const diagnostics: Diagnostics = {\n    voiceAllocation: eventDiagnostics.voiceAllocation.map((entry) => ({\n      time: entry.beatTime * beatToSecond,\n      channel: entry.channel,\n      activeCount: entry.activeCount\n    })),\n    loopWindow: computeLoopWindow(events),\n    motifUsage,\n    sectionMotifPlan\n  };\n\n  return { events, diagnostics };\n}\n\nfunction computeLoopWindow(events: Event[]) {\n  if (!events.length) {\n    return { head: [], tail: [] };\n  }\n  const wrapWindow = 0.1; // seconds\n  const lastTime = events[events.length - 1].time;\n  const tail = events.filter((event) => lastTime - event.time < wrapWindow);\n  const head = events.filter((event) => event.time < wrapWindow);\n  return { head, tail };\n}\n","import type { MoodSetting, StyleIntent, TwoAxisStyle } from \"../types.js\";\n\n/**\n * Validates and clamps two-axis values to valid range\n */\nexport function validateTwoAxisStyle(axis: TwoAxisStyle): TwoAxisStyle {\n  return {\n    percussiveMelodic: Math.max(-1.0, Math.min(1.0, axis.percussiveMelodic)),\n    calmEnergetic: Math.max(-1.0, Math.min(1.0, axis.calmEnergetic))\n  };\n}\n\n/**\n * Maps two-axis parameters to StyleIntent flags.\n * This function is the bridge between user-friendly 2D control\n * and the internal 9-flag StyleIntent system.\n *\n * @param axis - Two-axis style parameters\n * @returns StyleIntent with computed boolean flags\n */\nexport function mapTwoAxisToStyleIntent(axis: TwoAxisStyle): StyleIntent {\n  const { percussiveMelodic, calmEnergetic } = axis;\n\n  // Compute directional strengths (0~1)\n  // These represent \"how much\" each direction is activated\n  const percussiveStrength = Math.max(0, -percussiveMelodic); // strength when negative\n  const melodicStrength = Math.max(0, percussiveMelodic);      // strength when positive\n  const calmStrength = Math.max(0, -calmEnergetic);            // strength when negative\n  const energyStrength = Math.max(0, calmEnergetic);           // strength when positive\n\n  return {\n    // ========================================\n    // Percussive side (negative percussiveMelodic)\n    // ========================================\n\n    /**\n     * percussiveLayering: Activates when percussive strength > 0.3\n     * Effects: Prefers drums with \"percussive_layer\", \"four_on_floor\" tags\n     *          Shortens noise release times\n     */\n    percussiveLayering: percussiveStrength > 0.3,\n\n    /**\n     * syncopationBias: Activates when percussive strength > 0.4\n     * Effects: Prefers motifs with \"syncopation\" tags\n     *          Increases rhythmic complexity\n     */\n    syncopationBias: percussiveStrength > 0.4,\n\n    /**\n     * breakInsertion: Requires both percussive AND energetic\n     * Effects: Inserts breaks every 2 measures\n     *          Adds noise FX transitions\n     */\n    breakInsertion: percussiveStrength > 0.35 && energyStrength > 0.4,\n\n    // ========================================\n    // Melodic side (positive percussiveMelodic)\n    // ========================================\n\n    /**\n     * harmonicStatic: Requires melodic + calm\n     * Effects: Enforces drone bass patterns\n     *          Prefers \"scalar\", \"stepwise\", \"static\" melodies\n     */\n    harmonicStatic:\n      (melodicStrength > 0.4 && calmStrength > 0.3) ||\n      (percussiveStrength > 0.3 && calmStrength > 0.2),\n\n    /**\n     * atmosPad: Activates with melody OR strong calm\n     * Effects: Increases portamento probability (0.4)\n     *          Adds triangle pad gain profiles\n     */\n    atmosPad: melodicStrength > 0.3 || calmStrength > 0.5 || energyStrength > 0.55,\n\n    /**\n     * filterMotion: Melodic-focused filter sweeps\n     * Effects: Adds duty cycle sweeps for timbral motion\n     */\n    filterMotion: melodicStrength > 0.3 || energyStrength > 0.5,\n\n    // ========================================\n    // Calm side (negative calmEnergetic)\n    // ========================================\n\n    /**\n     * loopCentric: Activates with calm > 0.3\n     * Effects: Prefers \"loop_safe\", \"texture_loop\" motifs\n     *          Reduces velocity by 2\n     *          Increases arpegggio sustain probability\n     */\n    loopCentric: calmStrength > 0.3,\n\n    /**\n     * textureFocus: Strong calm OR percussive+calm combination\n     * Effects: Prefers \"texture_loop\", \"straight\", \"simple\" patterns\n     *          Reduces melody velocity by 8\n     *          Lowers melody register by 4\n     */\n    textureFocus: calmStrength > 0.4 || (percussiveStrength > 0.5 && calmStrength > 0.2),\n\n    // ========================================\n    // Energetic side (positive calmEnergetic)\n    // ========================================\n\n    /**\n     * gradualBuild: Activates with energy > 0.4\n     * Effects: Progressive velocity increase over track\n     *          Progressive register rise\n     *          Gain ramps on all channels\n     *          Adds duty cycle build sweeps\n     */\n    gradualBuild: energyStrength > 0.4,\n  };\n}\n\n/**\n * Derives tempo setting (slow/medium/fast) from energy axis.\n *\n * @param axis - Two-axis style parameters\n * @returns Tempo setting\n */\nexport function deriveTwoAxisTempo(axis: TwoAxisStyle): \"slow\" | \"medium\" | \"fast\" {\n  if (axis.calmEnergetic < -0.4) return \"slow\";\n  if (axis.calmEnergetic > 0.4) return \"fast\";\n  return \"medium\";\n}\n\n/**\n * Infers StyleTags from two-axis parameters for metadata/diagnostics.\n * These tags are stored in PipelineResult.meta for reference.\n *\n * @param axis - Two-axis style parameters\n * @returns Inferred style tags\n */\nexport function inferTagsFromAxis(axis: TwoAxisStyle): {\n  energy: \"low\" | \"medium\" | \"high\";\n  mood: MoodSetting;\n} {\n  const { percussiveMelodic, calmEnergetic } = axis;\n\n  // Energy tag\n  let energy: \"low\" | \"medium\" | \"high\" = \"medium\";\n  if (calmEnergetic > 0.4) energy = \"high\";\n  if (calmEnergetic < -0.4) energy = \"low\";\n\n  // Mood inference (heuristic)\n  let mood: MoodSetting = \"upbeat\";\n\n  if (calmEnergetic <= -0.5) {\n    mood = \"peaceful\";\n  } else if (percussiveMelodic <= -0.4) {\n    mood = \"tense\";\n  } else if (percussiveMelodic >= 0.4) {\n    mood = \"sad\";\n  } else if (calmEnergetic >= 0.4) {\n    mood = \"upbeat\";\n  }\n\n  return { energy, mood };\n}\n","import type { TwoAxisStyle } from \"../types.js\";\n\n/**\n * Converts legacy genre presets to two-axis parameters.\n * These values were derived by analyzing the StyleIntent flags\n * of each preset and mapping them to the 2D space.\n */\nexport const PRESET_TO_TWO_AXIS: Record<string, TwoAxisStyle> = {\n  /**\n   * Minimal Techno\n   * - Percussive-leaning with moderate calm\n   * - Features: harmonicStatic, textureFocus, loopCentric\n   */\n  \"minimal-techno\": {\n    percussiveMelodic: -0.4,  // Percussive\n    calmEnergetic: -0.3       // Calm-ish\n  },\n\n  /**\n   * Progressive House\n   * - Slightly percussive with high energy\n   * - Features: gradualBuild, breakInsertion, atmosPad\n   */\n  \"progressive-house\": {\n    percussiveMelodic: -0.45, // Moderately percussive\n    calmEnergetic: 0.6        // High energy\n  },\n\n  /**\n   * Retro Loopwave\n   * - Melodic-leaning with moderate calm\n   * - Features: loopCentric, textureFocus, filterMotion\n   */\n  \"retro-loopwave\": {\n    percussiveMelodic: 0.3,   // Melodic-ish\n    calmEnergetic: -0.2       // Calm-ish\n  },\n\n  /**\n   * Breakbeat Jungle\n   * - Very percussive with very high energy\n   * - Features: percussiveLayering, syncopationBias, breakInsertion\n   */\n  \"breakbeat-jungle\": {\n    percussiveMelodic: -0.7,  // Ultra percussive\n    calmEnergetic: 0.7        // Ultra energetic\n  },\n\n  /**\n   * Lofi Chillhop\n   * - Melodic with strong calm\n   * - Features: harmonicStatic, atmosPad, loopCentric, textureFocus\n   */\n  \"lofi-chillhop\": {\n    percussiveMelodic: 0.5,   // Melodic\n    calmEnergetic: -0.6       // Very calm\n  }\n};\n\n/**\n * Helper function to get two-axis values from preset name\n */\nexport function presetToTwoAxis(preset: string): TwoAxisStyle {\n  const axis = PRESET_TO_TWO_AXIS[preset];\n  if (!axis) {\n    throw new Error(`Unknown preset: ${preset}`);\n  }\n  return { ...axis };\n}\n","/**\n * Style Profile Resolution System\n *\n * This module converts modern CompositionOptions (two-axis style coordinates) into\n * PipelineCompositionOptions (mood/tempo strings) used by the internal pipeline.\n * It serves as a bridge between the user-facing API and the simplified pipeline inputs.\n *\n * ## Why Two APIs?\n *\n * The system evolved from a simple mood/tempo string API to a more intuitive two-axis\n * coordinate system:\n *\n * ### Legacy API (Internal)\n * ```typescript\n * { mood: \"upbeat\", tempo: \"fast\", seed: 123 }\n * ```\n * - **Pros**: Simple, discrete categories easy to implement\n * - **Cons**: Limited expressiveness (only 4 moods × 3 tempos = 12 combinations),\n *   unintuitive mapping (what's the difference between \"tense\" and \"sad\"?)\n *\n * ### Two-Axis API (External)\n * ```typescript\n * { twoAxisStyle: { percussiveMelodic: -0.5, calmEnergetic: 0.8 } }\n * ```\n * - **Pros**: Continuous space (infinite combinations), intuitive axes (percussive↔melodic,\n *   calm↔energetic), matches music theory concepts\n * - **Cons**: Requires coordinate → category mapping for the existing pipeline\n *\n * ## Resolution Strategy\n *\n * Rather than rewrite the entire pipeline to use two-axis coordinates directly, we:\n * 1. Accept modern two-axis API externally (CompositionOptions)\n * 2. Map coordinates to discrete mood/tempo internally (two-axis-mapper.ts)\n * 3. Pass PipelineCompositionOptions through existing pipeline\n * 4. Store resolved profile in metadata for debugging/replay\n *\n * This provides:\n * - Clean external API (users never see \"mood\" or \"tempo\" strings)\n * - Stable internal implementation (pipeline code doesn't change)\n * - Gradual migration path (both APIs can coexist)\n *\n * ## Intent Randomization\n *\n * When randomizeUnsetIntent=true, unset StyleIntent flags are randomly set per seed.\n * This creates variety across generations while maintaining determinism:\n * - Seed 123 might enable textureFocus, disable loopCentric\n * - Seed 456 might disable textureFocus, enable loopCentric\n * - Same seed always produces same randomization\n *\n * This is useful for generating diverse variations when the user doesn't have strong\n * preferences about specific intent flags.\n *\n * ## Preset Inference\n *\n * If no explicit StylePreset is provided, the system can infer one from two-axis coordinates:\n * - Find the preset with closest Euclidean distance in 2D space\n * - Only match if distance < threshold (0.35) to avoid false matches\n * - Returns undefined if no close match (generic style)\n *\n * This allows:\n * - Named presets when user wants specific aesthetics (\"minimalTechno\")\n * - Coordinate-based generation when user wants custom styles\n * - Automatic preset detection for coordinate-based input\n */\n\nimport {\n  type CompositionOptions,\n  type PipelineCompositionOptions,\n  type MoodSetting,\n  type ResolvedStyleProfile,\n  type StyleIntent,\n  type StyleProfile,\n  type StylePreset,\n  type StyleOverrides,\n  type TwoAxisStyle\n} from \"../types.js\";\nimport {\n  validateTwoAxisStyle,\n  mapTwoAxisToStyleIntent,\n  deriveTwoAxisTempo,\n  inferTagsFromAxis\n} from \"./two-axis-mapper.js\";\nimport { PRESET_TO_TWO_AXIS } from \"./preset-to-axis.js\";\n\n/**\n * Resolution result containing pipeline format, resolved profile, and replay options.\n */\ninterface ResolveResult {\n  pipeline: PipelineCompositionOptions;  // For pipeline consumption\n  profile: ResolvedStyleProfile;         // For metadata/diagnostics\n  replayOptions: CompositionOptions;     // For exact replay\n}\n\ntype IntentKey = keyof StyleIntent;\n\nconst INTENT_KEYS: IntentKey[] = [\n  \"textureFocus\",\n  \"loopCentric\",\n  \"gradualBuild\",\n  \"harmonicStatic\",\n  \"percussiveLayering\",\n  \"breakInsertion\",\n  \"filterMotion\",\n  \"syncopationBias\",\n  \"atmosPad\"\n];\n\nconst DEFAULT_INTENT: StyleIntent = {\n  textureFocus: false,\n  loopCentric: false,\n  gradualBuild: false,\n  harmonicStatic: false,\n  percussiveLayering: false,\n  breakInsertion: false,\n  filterMotion: false,\n  syncopationBias: false,\n  atmosPad: false\n};\n\nconst DEFAULT_PROFILE: StyleProfile = {\n  tempo: \"medium\",\n  intent: { ...DEFAULT_INTENT },\n  randomizeUnsetIntent: false\n};\n\nconst PRESET_SLUG_TO_ENUM: Record<string, StylePreset> = {\n  \"minimal-techno\": \"minimalTechno\",\n  \"progressive-house\": \"progressiveHouse\",\n  \"retro-loopwave\": \"retroLoopwave\",\n  \"breakbeat-jungle\": \"breakbeatJungle\",\n  \"lofi-chillhop\": \"lofiChillhop\"\n};\n\nconst PRESET_MATCH_THRESHOLD = 0.35;\n\nconst DEFAULT_AXIS: TwoAxisStyle = {\n  percussiveMelodic: 0,\n  calmEnergetic: 0\n};\n\nfunction seedRandom(seed: number): () => number {\n  let state = seed >>> 0;\n  if (state === 0) state = 1;\n  return () => {\n    state = (state * 1664525 + 1013904223) >>> 0;\n    return state / 0xffffffff;\n  };\n}\n\nfunction ensureIntent(partial: Partial<StyleIntent>, rng: (() => number) | null, randomize: boolean): StyleIntent {\n  const intent: StyleIntent = { ...DEFAULT_INTENT };\n  for (const key of INTENT_KEYS) {\n    const provided = partial[key];\n    if (typeof provided === \"boolean\") {\n      intent[key] = provided;\n    } else if (randomize && rng) {\n      intent[key] = rng() >= 0.5;\n    } else {\n      intent[key] = false;\n    }\n  }\n  return intent;\n}\n\nfunction mergeProfile(base: StyleProfile, patch: StyleOverrides): StyleProfile {\n  const intent: StyleIntent = { ...base.intent };\n  if (patch.intent) {\n    for (const key of INTENT_KEYS) {\n      const value = patch.intent[key];\n      if (typeof value === \"boolean\") {\n        intent[key] = value;\n      }\n    }\n  }\n\n  return {\n    tempo: patch.tempo ?? base.tempo,\n    intent,\n    randomizeUnsetIntent: patch.randomizeUnsetIntent ?? base.randomizeUnsetIntent\n  };\n}\n\nfunction inferPresetFromAxis(axis: TwoAxisStyle): StylePreset | undefined {\n  let bestKey: string | undefined;\n  let bestDistance = Number.POSITIVE_INFINITY;\n\n  for (const [slug, presetAxis] of Object.entries(PRESET_TO_TWO_AXIS)) {\n    const distance = Math.hypot(\n      axis.percussiveMelodic - presetAxis.percussiveMelodic,\n      axis.calmEnergetic - presetAxis.calmEnergetic\n    );\n    if (distance < bestDistance) {\n      bestDistance = distance;\n      bestKey = slug;\n    }\n  }\n\n  if (!bestKey || bestDistance > PRESET_MATCH_THRESHOLD) {\n    return undefined;\n  }\n\n  return PRESET_SLUG_TO_ENUM[bestKey] ?? undefined;\n}\n\n/**\n * Resolves CompositionOptions into pipeline format + resolved profile + replay options.\n *\n * This is the main entry point for style resolution. It:\n * 1. Validates and defaults user input (length, seed, two-axis coordinates)\n * 2. Maps two-axis coordinates to StyleIntent flags\n * 3. Applies user overrides (if provided)\n * 4. Infers energy/mood tags for metadata\n * 5. Infers mood/tempo for the pipeline\n * 6. Optionally randomizes unset intent flags (if randomizeUnsetIntent=true)\n * 7. Packages results for pipeline consumption and metadata storage\n *\n * ## Input Validation and Defaults\n *\n * - **lengthInMeasures**: Truncate to integer, default to 32 if invalid\n * - **seed**: Truncate to integer, generate random if unspecified\n * - **twoAxisStyle**: Clamp to [-1, 1] range, default to {0, 0} if omitted\n *\n * ## Override Priority\n *\n * Overrides are applied in order:\n * 1. Two-axis mapping (base intent from coordinates)\n * 2. User overrides (explicit intent flag settings)\n * 3. Intent randomization (only for unset flags, if enabled)\n *\n * This allows users to:\n * - Rely on two-axis defaults (no overrides)\n * - Override specific flags while keeping others coordinate-driven\n * - Enable randomization for experimental variety\n *\n * @param options - Modern composition options with two-axis style\n * @returns Resolved context with pipeline format, profile, and replay options\n */\nexport function resolveGenerationContext(options: CompositionOptions): ResolveResult {\n  const resolvedLength =\n    typeof options.lengthInMeasures === \"number\" && options.lengthInMeasures > 0\n      ? Math.trunc(options.lengthInMeasures)\n      : 32;\n\n  const resolvedSeed =\n    typeof options.seed === \"number\" && Number.isFinite(options.seed)\n      ? Math.trunc(options.seed)\n      : Math.floor(Math.random() * 0xffffffff);\n\n  const axisInput = options.twoAxisStyle ?? DEFAULT_AXIS;\n  const axis = validateTwoAxisStyle(axisInput);\n\n  let intent = mapTwoAxisToStyleIntent(axis);\n\n  if (options.overrides?.intent) {\n    for (const key of INTENT_KEYS) {\n      const value = options.overrides.intent[key];\n      if (typeof value === \"boolean\") {\n        intent[key] = value;\n      }\n    }\n  }\n\n  const tempo = deriveTwoAxisTempo(axis);\n  const inferredTags = inferTagsFromAxis(axis);\n  const mood: MoodSetting = inferredTags.mood;\n\n  let profile: StyleProfile = {\n    tempo,\n    intent,\n    randomizeUnsetIntent: false\n  };\n\n  if (options.overrides) {\n    profile = mergeProfile(profile, options.overrides);\n  }\n\n  const shouldRandomizeIntent = profile.randomizeUnsetIntent ?? false;\n  const rng = shouldRandomizeIntent ? seedRandom(resolvedSeed) : null;\n  const finalizedIntent = ensureIntent(profile.intent, rng, shouldRandomizeIntent);\n\n  profile = {\n    ...profile,\n    intent: finalizedIntent,\n    randomizeUnsetIntent: shouldRandomizeIntent\n  };\n\n  const pipelineOptions: PipelineCompositionOptions = {\n    mood,\n    tempo: profile.tempo ?? \"medium\",\n    lengthInMeasures: resolvedLength,\n    seed: resolvedSeed,\n    stylePreset: inferPresetFromAxis(axis),\n    styleOverrides: finalizedIntent\n  };\n\n  const resolvedProfile: ResolvedStyleProfile = {\n    ...profile,\n    tags: {\n      mood: inferredTags.mood,\n      energy: inferredTags.energy\n    },\n    twoAxisStyle: { ...axis }\n  };\n\n  const replayOptions: CompositionOptions = {\n    lengthInMeasures: resolvedLength,\n    seed: resolvedSeed,\n    twoAxisStyle: { ...axis }\n  };\n\n  if (options.overrides) {\n    replayOptions.overrides = JSON.parse(JSON.stringify(options.overrides));\n  }\n\n  return {\n    pipeline: pipelineOptions,\n    profile: resolvedProfile,\n    replayOptions\n  };\n}\n","import { CompositionOptions, PipelineCompositionOptions, PipelineResult, ResolvedStyleProfile } from \"./types.js\";\nimport { planStructure } from \"./phase/structure-planning.js\";\nimport { selectMotifs } from \"./phase/motif-selection.js\";\nimport { realizeEvents } from \"./phase/event-realization.js\";\nimport { applyTechniques } from \"./phase/techniques-postprocess.js\";\nimport { finalizeTimeline } from \"./phase/timeline-finalization.js\";\nimport { resolveGenerationContext } from \"./style/profile-resolver.js\";\n\n/**\n * Runs the five-phase composition pipeline to generate chiptune music.\n *\n * The pipeline is split into five distinct phases to achieve separation of concerns,\n * testability, reproducibility, and maintainability. Each phase focuses on one level\n * of abstraction, allowing independent testing and deterministic output given the same seed.\n * Musical logic is organized by its purpose rather than by physical channel assignment.\n *\n * The five phases transform abstract musical intent into concrete audio events:\n * - Phase 1 (Structure Planning): Defines the macro structure (BPM, key, sections, chords)\n * - Phase 2 (Motif Selection): Selects motifs for melody, bass, drums based on structure\n * - Phase 3 (Event Realization): Maps abstract tracks to physical channels\n * - Phase 4 (Techniques Postprocess): Adds timbral decoration (duty sweeps, effects)\n * - Phase 5 (Timeline Finalization): Converts to time-sorted event list for playback\n *\n * @param options Composition options with two-axis style coordinates or overrides\n * @returns Complete composition result with events, diagnostics, and metadata\n */\nexport function runPipeline(options: CompositionOptions): PipelineResult {\n  // Convert modern TwoAxisStyle API to pipeline-friendly options while preserving\n  // the simplified mood/tempo/seed parameters used internally.\n  const { pipeline, profile, replayOptions } = resolveOptions(options);\n\n  // Phase execution is strictly sequential because each phase depends on the previous.\n  // Phase 1 must determine BPM before Phase 2 can select tempo-appropriate motifs.\n  const structurePlan = planStructure(pipeline);\n\n  // Motif selection happens after structure planning so tag-based filtering\n  // can use the resolved mood, tempo, and section templates.\n  const motifSelection = selectMotifs(pipeline, structurePlan);\n\n  // Event realization maps abstract musical roles to physical channels.\n  // This separation allows the same melody to be rendered on different channels\n  // based on the Voice Arrangement preset (standard, swapped, dualBass, etc.).\n  const eventRealization = realizeEvents(pipeline, structurePlan, motifSelection);\n\n  // Techniques are applied after basic notes are generated so they can\n  // scan the complete note timeline and make context-aware decisions\n  // (e.g., duty sweeps only on sustained notes, gain automation across sections).\n  const techniquesApplied = applyTechniques(eventRealization, structurePlan.styleIntent);\n\n  // Timeline finalization is the last step because it converts beat-time to\n  // absolute seconds, which requires knowing the final BPM and validating loop integrity.\n  const finalTimeline = finalizeTimeline(\n    structurePlan,\n    techniquesApplied.events,\n    eventRealization.diagnostics,\n    motifSelection.motifUsage,\n    motifSelection.sectionMotifPlan\n  );\n\n  // Loop info is calculated here (not in Phase 5) because it's metadata about\n  // the composition as a whole, not part of the event timeline itself.\n  const BEATS_PER_MEASURE = 4;\n  const totalBeats = pipeline.lengthInMeasures * BEATS_PER_MEASURE;\n  const totalDuration = (totalBeats / structurePlan.bpm) * 60;\n\n  return {\n    events: finalTimeline.events,\n    diagnostics: finalTimeline.diagnostics,\n    meta: {\n      bpm: structurePlan.bpm,\n      key: structurePlan.key,\n      seed: pipeline.seed,\n      mood: pipeline.mood,\n      tempo: pipeline.tempo,\n      lengthInMeasures: pipeline.lengthInMeasures,\n      styleIntent: structurePlan.styleIntent,\n      voiceArrangement: structurePlan.voiceArrangement,\n      profile,\n      replayOptions,\n      loopInfo: {\n        loopStartBeat: 0,\n        loopEndBeat: totalBeats,\n        loopStartTime: 0,\n        loopEndTime: totalDuration,\n        totalBeats,\n        totalDuration\n      }\n    }\n  };\n}\n\n/**\n * Main API entry point for composition generation.\n *\n * This async wrapper exists for future extensibility, allowing pre/post-processing\n * steps to be added without breaking the API. It enables future parallel motif loading\n * or analysis tasks and maintains consistency with Web Audio APIs which are inherently\n * async. Currently synchronous, but the Promise return type prepares for future async operations.\n *\n * @param options Composition options with two-axis style coordinates or overrides\n * @returns Promise resolving to complete composition result\n */\nexport async function generateComposition(options: CompositionOptions): Promise<PipelineResult> {\n  return runPipeline(options);\n}\n\n/**\n * Resolves modern CompositionOptions to the simplified pipeline format.\n *\n * The system evolved from a simple mood/tempo/seed API to a two-axis coordinate system.\n * Rather than rewrite the entire pipeline, we map the modern API to the internal format\n * at the entry point. This provides a clean external API (two-axis coordinates are more\n * intuitive than mood strings) while keeping the existing pipeline stable.\n *\n * @param options Modern composition options\n * @returns Pipeline options, resolved profile, and replay options for result metadata\n */\nfunction resolveOptions(options: CompositionOptions): {\n  pipeline: PipelineCompositionOptions;\n  profile: ResolvedStyleProfile;\n  replayOptions: CompositionOptions;\n} {\n  return resolveGenerationContext(options);\n}\n","import type { SETemplate } from \"./seTypes.js\";\nimport seTemplatesJson from \"../../motifs/se-templates.json\" with { type: \"json\" };\n\nexport function loadSETemplates(): SETemplate[] {\n  const json = seTemplatesJson as { templates: SETemplate[] };\n  return json.templates;\n}\n","/**\n * Sound Effect (SE) Generation System\n *\n * This module generates chiptune sound effects using a template-based approach.\n * Unlike BGM (which uses motif-based composition), SE generation samples parameters\n * from predefined ranges to create one-shot sound events.\n *\n * ## Why Template-Based SE Generation?\n *\n * Sound effects require different design constraints than music:\n * - **Short duration**: SEs are 0.02-1.2 seconds (vs BGM's multi-minute compositions)\n * - **Parameter variety**: Same SE type needs multiple variations (e.g., different jump pitches)\n * - **Tight timing**: SE must trigger precisely on game events without rhythmic quantization\n * - **Isolated playback**: SEs don't need harmonic relationships with BGM\n *\n * Templates define parameter ranges (pitch, duration, envelope) that are sampled at\n * generation time, creating variety without hand-authoring hundreds of discrete SE motifs.\n *\n * ## SE Types and Template Architecture\n *\n * 10 SE types with 2 template variations each (20 templates total):\n * - **jump**: Rising pitch sweep (exponential curve)\n * - **coin**: 2-3 note ascending arpeggio\n * - **explosion**: Noise burst + descending bass sweep\n * - **hit**: Short descending arpeggio (damage sound)\n * - **powerup**: 4-note ascending arpeggio\n * - **laser**: Fast descending sweep\n * - **select**: Short single tone (menu selection)\n * - **click**: Very short high-pitched tone\n * - **synth**: Sustained tone with duty cycle variation\n * - **tone**: Basic single tone\n *\n * Each template specifies:\n * - Channel usage (square1, square2, triangle, noise)\n * - Duration range (min/max in seconds)\n * - Pitch ranges (start/end for sweeps, or fixed pitch)\n * - Envelope type (percussive vs sustained)\n * - Optional note sequences (arpeggios)\n * - Optional pitch sweep configuration\n *\n * ## Seed-Driven Reproducibility\n *\n * Like BGM generation, SE generation is deterministic:\n * - Same seed → same parameter sampling → identical SE\n * - Allows \"replay\" of exact SE variations for debugging or user favorites\n * - Uses linear congruential generator (LCG) matching BGM's RNG\n *\n * ## Parameter Concretization\n *\n * Template ranges are sampled to concrete values:\n * - **Duration**: Sample from [minDur, maxDur] range\n * - **Pitch**: Sample MIDI note from {min, max} range (discrete)\n * - **Velocity**: Sample from velocity range (quantized to MIDI 0-127)\n * - **Duty cycle**: Sample from continuous range or discrete options\n * - **Envelope**: Fixed per template (percussive or sustained)\n *\n * This generates infinite SE variations from a small template library.\n */\n\nimport type { Event, Channel } from \"../types.js\";\nimport type { SEType, SETemplate, SEGenerationOptions, SEGenerationResult } from \"./seTypes.js\";\nimport { loadSETemplates } from \"./seTemplates.js\";\nimport { midiToFrequency, frequencyToSemitones } from \"../musicUtils.js\";\n\n/**\n * Seeded random number generator using Linear Congruential Generator (LCG).\n *\n * Uses the same algorithm as BGM generation for consistency:\n * - Multiplier: 1664525 (from Numerical Recipes)\n * - Increment: 1013904223\n * - Modulus: 2^32 (implicit via unsigned 32-bit overflow)\n *\n * @param seed - Initial seed value (0 is replaced with 1 to avoid degenerate case)\n * @returns Function that returns next random value in [0, 1)\n */\nfunction seedRandom(seed: number): () => number {\n  let state = seed >>> 0;\n  if (state === 0) {\n    state = 1;\n  }\n  return () => {\n    state = (state * 1664525 + 1013904223) >>> 0;\n    return state / 0xffffffff;\n  };\n}\n\nexport class SEGenerator {\n  private templates: SETemplate[];\n\n  constructor() {\n    this.templates = loadSETemplates();\n  }\n\n  /**\n   * Generates a sound effect based on type and optional template selection.\n   *\n   * The generation process:\n   * 1. Select template (specific templateId or random from type)\n   * 2. Sample parameters from template ranges (duration, pitch, velocity, etc.)\n   * 3. Generate event list (noteOn/noteOff pairs with sampled parameters)\n   * 4. Return events + metadata for playback\n   *\n   * @param options - SE generation options (type, seed, templateId, startTime)\n   * @returns SE result with events, metadata, and replay options\n   */\n  generateSE(options: SEGenerationOptions): SEGenerationResult {\n    const seed = options.seed ?? Math.floor(Math.random() * 1e9);\n    const rng = seedRandom(seed);\n\n    // 1. テンプレート選択\n    const template = this.selectTemplate(options, rng);\n\n    // 2. パラメータ具体化\n    const params = this.concretizeParameters(template, rng, options.baseFrequency);\n\n    // 3. イベントリスト生成\n    const events = this.generateEvents(template, params, options.startTime ?? 0.0);\n\n    const replayOptions: SEGenerationOptions = {\n      type: options.type,\n      seed,\n      startTime: options.startTime ?? 0.0\n    };\n    if (options.templateId) {\n      replayOptions.templateId = options.templateId;\n    }\n    if (options.baseFrequency !== undefined) {\n      replayOptions.baseFrequency = options.baseFrequency;\n    }\n\n    return {\n      events,\n      meta: {\n        type: options.type,\n        templateId: template.id,\n        seed,\n        duration: params.duration,\n        channels: template.channels,\n        replayOptions\n      }\n    };\n  }\n\n  private selectTemplate(options: SEGenerationOptions, rng: () => number): SETemplate {\n    // templateId が指定されていれば強制選択\n    if (options.templateId) {\n      const template = this.templates.find(t => t.id === options.templateId);\n      if (!template) throw new Error(`Template not found: ${options.templateId}`);\n      return template;\n    }\n\n    // type に合致するテンプレートからランダム選択\n    const candidates = this.templates.filter(t => t.type === options.type);\n    if (candidates.length === 0) {\n      throw new Error(`No templates found for type: ${options.type}`);\n    }\n    return candidates[Math.floor(rng() * candidates.length)];\n  }\n\n  private concretizeParameters(template: SETemplate, rng: () => number, baseFrequency?: number) {\n    const [minDur, maxDur] = template.durationRange;\n    const duration = minDur + rng() * (maxDur - minDur);\n\n    const channelParams: Record<Channel, any> = {} as any;\n\n    // Calculate pitch shift if baseFrequency is provided\n    // Pattern A: Shift all pitches to align the reference pitch with baseFrequency\n    let pitchShift = 0;\n    if (baseFrequency !== undefined) {\n      pitchShift = this.calculatePitchShift(template, baseFrequency);\n    }\n\n    for (const ch of template.channels) {\n      const tplParams = template.channelParams[ch];\n      if (!tplParams) continue;\n      const baseVelocityRange: [number, number] = tplParams.velocityRange\n        ? tplParams.velocityRange\n        : ch === \"noise\"\n          ? [88, 118]\n          : [96, 122];\n      const sampledVelocity = Math.round(\n        Math.max(1, Math.min(127, this.sampleFloatRange(baseVelocityRange, rng)))\n      );\n\n      // Apply pitch shift to sampled pitches\n      const sampledPitchStart = tplParams.pitchStart\n        ? this.samplePitchRange(tplParams.pitchStart, rng)\n        : undefined;\n      const sampledPitchEnd = tplParams.pitchEnd\n        ? this.samplePitchRange(tplParams.pitchEnd, rng)\n        : undefined;\n\n      channelParams[ch] = {\n        pitchStart: sampledPitchStart !== undefined\n          ? this.clampMidi(sampledPitchStart + pitchShift)\n          : undefined,\n        pitchEnd: sampledPitchEnd !== undefined\n          ? this.clampMidi(sampledPitchEnd + pitchShift)\n          : undefined,\n        dutyCycle: tplParams.dutyCycleRange\n          ? this.sampleFloatRange([tplParams.dutyCycleRange.min, tplParams.dutyCycleRange.max], rng)\n          : tplParams.dutyCycle\n            ? tplParams.dutyCycle[Math.floor(rng() * tplParams.dutyCycle.length)]\n            : undefined,\n        noiseMode: tplParams.noiseMode,\n        envelope: tplParams.envelope,\n        velocity: sampledVelocity,\n        releaseSeconds: tplParams.releaseRange\n          ? this.sampleFloatRange(tplParams.releaseRange, rng)\n          : undefined\n      };\n\n      if (template.pitchSweep?.enabled) {\n        const sweepCurveOptions = template.pitchSweep.curveOptions ??\n          (template.pitchSweep.curveType ? [template.pitchSweep.curveType] : undefined);\n        if (sweepCurveOptions) {\n          // Use weighted choice if curveWeights are provided\n          channelParams[ch].sweepCurve = this.weightedChoice(\n            sweepCurveOptions,\n            template.pitchSweep.curveWeights,\n            rng\n          ) ?? template.pitchSweep.curveType;\n        }\n        if (template.pitchSweep.durationRange) {\n          channelParams[ch].sweepDuration = this.sampleFloatRange(template.pitchSweep.durationRange, rng);\n        }\n      }\n    }\n\n    return { duration, channelParams };\n  }\n\n  private samplePitchRange(range: { min: number; max: number }, rng: () => number): number {\n    return Math.floor(range.min + rng() * (range.max - range.min + 1));\n  }\n\n  private sampleFloatRange(range: [number, number], rng: () => number): number {\n    return range[0] + rng() * (range[1] - range[0]);\n  }\n\n  /**\n   * Select an option from an array using weighted probabilities.\n   * @param options - Array of options to choose from\n   * @param weights - Record mapping option string to weight (default: equal weights)\n   * @param rng - Random number generator\n   * @returns Selected option\n   */\n  private weightedChoice<T>(\n    options: T[],\n    weights: Record<string, number> | undefined,\n    rng: () => number\n  ): T {\n    if (!weights) {\n      // No weights specified, use uniform random selection\n      return options[Math.floor(rng() * options.length)];\n    }\n\n    const totalWeight = options.reduce((sum, opt) => sum + (weights[String(opt)] || 1), 0);\n    let random = rng() * totalWeight;\n\n    for (const opt of options) {\n      const weight = weights[String(opt)] || 1;\n      if (random < weight) return opt;\n      random -= weight;\n    }\n\n    return options[options.length - 1];\n  }\n\n  private generateEvents(\n    template: SETemplate,\n    params: any,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n\n    for (const ch of template.channels) {\n      const chParams = params.channelParams[ch];\n      const channelEvents = this.generateChannelEvents(\n        ch,\n        template,\n        chParams,\n        params,\n        startTime\n      );\n      events.push(...channelEvents);\n    }\n\n    // time でソート\n    events.sort((a, b) => a.time - b.time);\n\n    return events;\n  }\n\n  /**\n   * チャンネル別にイベントを生成\n   */\n  private generateChannelEvents(\n    channel: Channel,\n    template: SETemplate,\n    chParams: any,\n    globalParams: any,\n    startTime: number\n  ): Event[] {\n    if (channel.startsWith(\"square\")) {\n      return this.generateSquareEvents(channel, template, chParams, globalParams, startTime);\n    } else if (channel === \"triangle\") {\n      return this.generateTriangleEvents(channel, template, chParams, globalParams, startTime);\n    } else if (channel === \"noise\") {\n      return this.generateNoiseEvents(template, chParams, globalParams, startTime);\n    }\n    return [];\n  }\n\n  /**\n   * Square チャンネルのイベント生成\n   */\n  private generateSquareEvents(\n    channel: Channel,\n    template: SETemplate,\n    chParams: any,\n    globalParams: any,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n\n    // デューティサイクル設定\n    if (chParams.dutyCycle !== undefined) {\n      events.push({\n        time: startTime,\n        channel,\n        command: \"setParam\",\n        data: { param: \"duty\", value: chParams.dutyCycle }\n      });\n    }\n\n    // ノートシーケンス（アルペジオ等）\n    if (template.noteSequence) {\n      events.push(...this.generateNoteSequence(channel, template, chParams, startTime));\n    }\n    // ピッチスイープ\n    else if (template.pitchSweep?.enabled) {\n      events.push(...this.generatePitchSweep(channel, template, chParams, globalParams, startTime));\n    }\n    // 単純なノート\n    else if (chParams.pitchStart !== undefined) {\n      events.push(...this.generateSimpleNote(channel, chParams, globalParams.duration, startTime));\n    }\n\n    return events;\n  }\n\n  /**\n   * Triangle チャンネルのイベント生成\n   */\n  private generateTriangleEvents(\n    channel: Channel,\n    template: SETemplate,\n    chParams: any,\n    globalParams: any,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n\n    // Triangle は square と同様の処理（デューティサイクル設定は不要）\n    if (template.noteSequence) {\n      events.push(...this.generateNoteSequence(channel, template, chParams, startTime));\n    } else if (template.pitchSweep?.enabled) {\n      events.push(...this.generatePitchSweep(channel, template, chParams, globalParams, startTime));\n    } else if (chParams.pitchStart !== undefined) {\n      events.push(...this.generateSimpleNote(channel, chParams, globalParams.duration, startTime));\n    }\n\n    return events;\n  }\n\n  /**\n   * Noise チャンネルのイベント生成\n   */\n  private generateNoiseEvents(\n    template: SETemplate,\n    chParams: any,\n    globalParams: any,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n    const channel: Channel = \"noise\";\n\n    // ノイズモード設定\n    if (chParams.noiseMode) {\n      events.push({\n        time: startTime,\n        channel,\n        command: \"setParam\",\n        data: { param: \"noiseMode\", value: chParams.noiseMode }\n      });\n    }\n\n    const velocity = chParams.velocity ?? 110;\n    const releaseSeconds = chParams.releaseSeconds ?? globalParams.duration * 0.3;\n    const noiseData: any = { velocity };\n\n    // noiseMode を設定\n    if (chParams.noiseMode) {\n      noiseData.noiseMode = chParams.noiseMode;\n    }\n\n    // エンベロープが percussive の場合、duration に基づいて decay/release を設定\n    if (chParams.envelope === \"percussive\") {\n      noiseData.decaySeconds = globalParams.duration * 0.7;\n      noiseData.releaseSeconds = releaseSeconds;\n    } else if (chParams.releaseSeconds) {\n      noiseData.releaseSeconds = releaseSeconds;\n    }\n\n    events.push({\n      time: startTime,\n      channel,\n      command: \"noteOn\",\n      data: noiseData\n    });\n\n    events.push({\n      time: startTime + globalParams.duration,\n      channel,\n      command: \"noteOff\",\n      data: {}\n    });\n\n    return events;\n  }\n\n  /**\n   * ノートシーケンス生成（アルペジオ等）\n   */\n  private generateNoteSequence(\n    channel: Channel,\n    template: SETemplate,\n    chParams: any,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n\n    if (!template.noteSequence) return events;\n\n    let currentTime = startTime;\n    const basePitch = chParams.pitchStart;\n    const velocity = chParams.velocity ?? 110;\n\n    for (let i = 0; i < template.noteSequence.intervals.length; i++) {\n      const pitch = basePitch + template.noteSequence.intervals[i];\n      const noteDur = template.noteSequence.noteDurations[i];\n\n      events.push({\n        time: currentTime,\n        channel,\n        command: \"noteOn\",\n        data: { midi: pitch, velocity }\n      });\n\n      events.push({\n        time: currentTime + noteDur,\n        channel,\n        command: \"noteOff\",\n        data: {}\n      });\n\n      currentTime += noteDur;\n    }\n\n    return events;\n  }\n\n  /**\n   * ピッチスイープ生成\n   */\n  private generatePitchSweep(\n    channel: Channel,\n    template: SETemplate,\n    chParams: any,\n    globalParams: any,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n\n    if (!template.pitchSweep?.enabled) return events;\n\n    const sweepDuration = chParams.sweepDuration ?? globalParams.duration;\n    const curve = chParams.sweepCurve ?? template.pitchSweep.curveType ?? \"exponential\";\n    const velocity = chParams.velocity ?? 110;\n\n    events.push({\n      time: startTime,\n      channel,\n      command: \"noteOn\",\n      data: { midi: chParams.pitchStart, velocity }\n    });\n\n    // Note: Web Audio demo では pitchBend パラメータとして処理\n    events.push({\n      time: startTime,\n      channel,\n      command: \"setParam\",\n      data: {\n        param: \"pitchBend\",\n        value: chParams.pitchEnd,\n        rampDuration: sweepDuration,\n        curve\n      }\n    });\n\n    events.push({\n      time: startTime + sweepDuration,\n      channel,\n      command: \"noteOff\",\n      data: {}\n    });\n\n    return events;\n  }\n\n  /**\n   * 単純なノート生成（エンベロープのみ）\n   */\n  private generateSimpleNote(\n    channel: Channel,\n    chParams: any,\n    duration: number,\n    startTime: number\n  ): Event[] {\n    const events: Event[] = [];\n    const velocity = chParams.velocity ?? 110;\n    const releaseSeconds = chParams.releaseSeconds;\n\n    events.push({\n      time: startTime,\n      channel,\n      command: \"noteOn\",\n      data: { midi: chParams.pitchStart, velocity }\n    });\n\n    events.push({\n      time: startTime + duration,\n      channel,\n      command: \"noteOff\",\n      data: releaseSeconds ? { releaseSeconds } : {}\n    });\n\n    return events;\n  }\n\n  /**\n   * Calculate pitch shift needed to align template's reference pitch with baseFrequency.\n   *\n   * Pattern A implementation: Uses the template's start pitch as reference and calculates\n   * the semitone offset needed to shift it to the target baseFrequency.\n   *\n   * Strategy for finding reference pitch per SE type:\n   * - pitch sweep (jump, laser): Use pitchStart as reference\n   * - note sequence (coin, powerup, hit): Use first note (pitchStart) as reference\n   * - single tone (select, click, synth, tone): Use pitchStart as reference\n   * - multi-channel (explosion): Use triangle channel pitch (bass) as reference\n   *\n   * @param template SE template with pitch configuration\n   * @param baseFrequency Target frequency in Hz\n   * @returns Semitone shift to apply to all pitches\n   */\n  private calculatePitchShift(template: SETemplate, baseFrequency: number): number {\n    // Find the first channel with pitch information to use as reference\n    for (const ch of template.channels) {\n      const chParams = template.channelParams[ch];\n      if (!chParams?.pitchStart) continue;\n\n      // Use the middle of the pitch range as reference\n      // This ensures we shift from a representative pitch rather than edge cases\n      const referenceMidi = (chParams.pitchStart.min + chParams.pitchStart.max) / 2;\n      const referenceFreq = midiToFrequency(referenceMidi);\n      const frequencyRatio = baseFrequency / referenceFreq;\n      const shiftSemitones = frequencyToSemitones(frequencyRatio);\n\n      // Round to nearest semitone for discrete pitch shifting\n      return Math.round(shiftSemitones);\n    }\n\n    // No pitch information found, return 0 (no shift)\n    return 0;\n  }\n\n  /**\n   * Clamp MIDI note number to valid range (0-127).\n   *\n   * Prevents pitch shifting from producing invalid MIDI values.\n   * Also ensures we don't exceed Nyquist frequency (sample rate / 2).\n   *\n   * @param midi MIDI note number (may be out of range)\n   * @returns Clamped MIDI note number\n   */\n  private clampMidi(midi: number): number {\n    return Math.max(0, Math.min(127, Math.round(midi)));\n  }\n}\n","/**\n * AlgoChip chiptune synthesizer implementation.\n *\n * This module provides authentic retro sound synthesis using AudioWorklet processors\n * that emulate classic 4-channel chiptune architecture:\n * - Two square wave channels (square1, square2) with adjustable duty cycle\n * - One triangle wave channel for bass\n * - One noise channel with configurable period and mode\n *\n * The synthesizer supports:\n * - Precise event scheduling with lookahead\n * - Pitch slides and portamento effects\n * - Noise instrument presets (kick, snare, hihat, etc.)\n * - Looping playback\n * - Event callbacks for real-time visualization\n */\n\nimport type { Event as PlaybackEvent, Channel } from \"../types.js\";\n\n// ============================================================================\n// Constants\n// ============================================================================\n\n/** Lookahead time for event scheduling in seconds */\nconst LOOKAHEAD_SECONDS = 0.1;\n/** Interval for checking and scheduling events in milliseconds */\nconst SCHEDULE_INTERVAL_MS = 25;\n/** Default lead time before playback starts in seconds */\nconst LEAD_TIME = 0.3;\n/** Reference clock frequency in Hz (1.789773 MHz) */\nconst CHIP_BASE_CLOCK = 1_789_773;\n\n/** Noise channel period lookup table (clock divider values) */\nconst NOISE_PERIOD_TABLE = [4, 8, 16, 32, 64, 96, 128, 160, 202, 254, 380, 508, 762, 1016, 2034, 4068];\n\n/** Noise instrument types: K=kick, S=snare, H=hihat, O=open, T=tom */\ntype NoiseInstrument = \"K\" | \"S\" | \"H\" | \"O\" | \"T\" | \"default\";\n\n/**\n * Noise channel presets for drum-like sounds.\n *\n * Each preset defines the mode (short/long), period index, amplitude envelope,\n * and filter cutoff to emulate different percussion instruments.\n */\nconst NOISE_PRESETS: Record<NoiseInstrument, NoisePreset> = {\n  K: { mode: \"long\", periodIndex: 14, baseAmplitude: 0.75, decaySeconds: 0.22, releaseSeconds: 0.04, cutoffHz: 3200 },\n  S: { mode: \"short\", periodIndex: 4, baseAmplitude: 0.65, decaySeconds: 0.14, releaseSeconds: 0.03, cutoffHz: 5200 },\n  H: { mode: \"short\", periodIndex: 1, baseAmplitude: 0.45, decaySeconds: 0.06, releaseSeconds: 0.02, cutoffHz: 7800 },\n  O: { mode: \"short\", periodIndex: 2, baseAmplitude: 0.6, decaySeconds: 0.4, releaseSeconds: 0.06, cutoffHz: 6800 },\n  T: { mode: \"long\", periodIndex: 10, baseAmplitude: 0.6, decaySeconds: 0.26, releaseSeconds: 0.05, cutoffHz: 3600 },\n  default: { mode: \"short\", periodIndex: 3, baseAmplitude: 0.6, decaySeconds: 0.14, releaseSeconds: 0.03, cutoffHz: 6000 }\n};\n\n/** MIDI note number for A4 (440 Hz) */\nconst MIDI_A4 = 69;\n/** Frequency of A4 in Hz */\nconst FREQ_A4 = 440;\n\n// ============================================================================\n// Utility Functions\n// ============================================================================\n\n/**\n * Converts MIDI note number to frequency in Hz.\n *\n * @param midi MIDI note number (0-127)\n * @returns Frequency in Hz\n */\nfunction midiToFrequency(midi: number): number {\n  return FREQ_A4 * Math.pow(2, (midi - MIDI_A4) / 12);\n}\n\n/**\n * Converts MIDI velocity to linear gain value.\n *\n * @param velocity MIDI velocity (0-127, defaults to 100)\n * @param scale Scaling factor (default 0.85 to avoid clipping)\n * @returns Linear gain value (0.0-1.0)\n */\nfunction velocityToGain(velocity?: number, scale = 0.85): number {\n  return Math.max(0, Math.min(1, ((velocity ?? 100) / 127) * scale));\n}\n\n// ============================================================================\n// Type Definitions\n// ============================================================================\n\n/** Pitch slide/portamento parameters */\ninterface PitchSlide {\n  targetFrequency: number;\n  durationSeconds: number;\n}\n\n/** Data for pitched notes (square/triangle channels) */\ninterface PitchData {\n  frequency: number;\n  amplitude: number;\n  duty?: number;\n  detuneCents: number;\n  slide?: PitchSlide | null;\n}\n\n/** Noise channel preset parameters */\ninterface NoisePreset {\n  mode: \"short\" | \"long\";\n  periodIndex: number;\n  baseAmplitude: number;\n  decaySeconds: number;\n  releaseSeconds: number;\n  cutoffHz: number;\n}\n\n/** Data for noise channel notes (drums/percussion) */\ninterface NoiseData {\n  amplitude: number;\n  decaySeconds: number;\n  releaseSeconds: number;\n  periodIndex: number;\n  mode: \"short\" | \"long\";\n  cutoffHz: number;\n}\n\n/** Options for synthesizer playback */\nexport interface SynthPlayOptions {\n  startTime?: number;\n  loop?: boolean;\n  lookahead?: number;\n  leadTime?: number;\n  offset?: number;\n  onEvent?: (event: PlaybackEvent, when: number) => void;\n  volume?: number;  // Playback volume multiplier (default: 1.0, range: 0.0+)\n}\n\n// ============================================================================\n// Channel Classes\n// ============================================================================\n\n/**\n * Base class for all audio channels.\n *\n * Handles communication with AudioWorklet processors via MessagePort,\n * converting event times to sample-accurate frame numbers.\n */\nclass BaseChannel {\n  protected readonly port: MessagePort;\n  protected readonly sampleRate: number;\n\n  constructor(\n    protected readonly context: AudioContext,\n    processorName: string,\n    masterGain: GainNode\n  ) {\n    const node = new AudioWorkletNode(context, processorName);\n    node.connect(masterGain);\n    this.port = node.port;\n    this.sampleRate = context.sampleRate;\n  }\n\n  /**\n   * Schedules a message to be processed by the AudioWorklet at a specific time.\n   *\n   * @param message Message data to send to the worklet\n   * @param when Absolute time in seconds (AudioContext.currentTime)\n   */\n  scheduleMessage(message: Record<string, unknown>, when: number): void {\n    const sampleFrame = Math.max(0, Math.round(when * this.sampleRate));\n    this.port.postMessage({ ...message, sampleFrame });\n  }\n\n  /** Clears all scheduled events and stops sound output */\n  stop(): void {\n    this.port.postMessage({ type: \"clear\" });\n  }\n}\n\n/**\n * Square wave channel implementation.\n *\n * Supports duty cycle control (12.5%, 25%, 50%), pitch slides,\n * and detuning effects. Used for melody and harmony.\n */\nclass SquareChannel extends BaseChannel {\n  private currentDuty = 0.5;\n\n  constructor(context: AudioContext, masterGain: GainNode) {\n    super(context, \"square-processor\", masterGain);\n  }\n\n  noteOn(data: PitchData & { slide?: PitchSlide | null }, when: number): void {\n    const detuneCents = data.detuneCents ?? 0;\n    const detuneRatio = Math.pow(2, detuneCents / 1200);\n    const payload: Record<string, unknown> = {\n      type: \"noteOn\",\n      frequency: data.frequency * detuneRatio,\n      amplitude: data.amplitude ?? 0.8,\n      duty: data.duty ?? this.currentDuty\n    };\n    if (data.slide) {\n      payload.slide = {\n        targetFrequency: data.slide.targetFrequency,\n        durationSamples: Math.round((data.slide.durationSeconds ?? 0) * this.sampleRate)\n      };\n    }\n    this.scheduleMessage(payload, when);\n  }\n\n  noteOff(_: Record<string, unknown>, when: number): void {\n    this.scheduleMessage({ type: \"noteOff\" }, when);\n  }\n\n  setParam(data: Record<string, unknown>, when: number): void {\n    if (data.param === \"duty\") {\n      this.currentDuty = Number(data.value ?? this.currentDuty);\n    }\n    if (data.param === \"pitchBend\" && typeof data.value === \"number\") {\n      const targetFrequency = data.value > 0 ? midiToFrequency(data.value) : 0;\n      const rampDuration = Number(data.rampDuration ?? 0);\n      const curve = (data.curve as string) ?? \"linear\";\n      this.scheduleMessage(\n        {\n          type: \"setParam\",\n          param: \"pitchBend\",\n          value: targetFrequency,\n          rampDuration,\n          curve\n        },\n        when\n      );\n      return;\n    }\n    this.scheduleMessage({ type: \"setParam\", param: data.param, value: data.value }, when);\n  }\n}\n\n/**\n * Triangle wave channel implementation.\n *\n * Fixed waveform (no duty cycle control), typically used for bass lines.\n * Supports pitch bends but not amplitude control (fixed volume on chiptune hardware).\n */\nclass TriangleChannel extends BaseChannel {\n  constructor(context: AudioContext, masterGain: GainNode) {\n    super(context, \"triangle-processor\", masterGain);\n  }\n\n  noteOn(data: PitchData, when: number): void {\n    const payload = {\n      type: \"noteOn\",\n      frequency: data.frequency,\n      amplitude: data.amplitude ?? 0.7\n    };\n    this.scheduleMessage(payload, when);\n  }\n\n  noteOff(_: Record<string, unknown>, when: number): void {\n    this.scheduleMessage({ type: \"noteOff\" }, when);\n  }\n\n  setParam(data: Record<string, unknown>, when: number): void {\n    if (data.param === \"pitchBend\" && typeof data.value === \"number\") {\n      const targetFrequency = data.value > 0 ? midiToFrequency(data.value) : 0;\n      const rampDuration = Number(data.rampDuration ?? 0);\n      const curve = (data.curve as string) ?? \"linear\";\n      this.scheduleMessage(\n        {\n          type: \"setParam\",\n          param: \"pitchBend\",\n          value: targetFrequency,\n          rampDuration,\n          curve\n        },\n        when\n      );\n      return;\n    }\n    this.scheduleMessage({ type: \"setParam\", param: data.param, value: data.value }, when);\n  }\n}\n\n/**\n * Noise channel implementation.\n *\n * Generates pseudo-random noise for percussion sounds (kick, snare, hihat).\n * Supports two modes: \"short\" (high-frequency metallic) and \"long\" (low-frequency rumble).\n * Period control uses 16-bit LFSR (Linear Feedback Shift Register).\n */\nclass NoiseChannel extends BaseChannel {\n  private periodIndex = 0;\n  private mode: \"short\" | \"long\" = \"short\";\n\n  constructor(context: AudioContext, masterGain: GainNode) {\n    super(context, \"noise-processor\", masterGain);\n  }\n\n  noteOn(data: NoiseData & { periodIndex?: number }, when: number): void {\n    const periodIndex = Math.max(0, Math.min(NOISE_PERIOD_TABLE.length - 1, data.periodIndex ?? this.periodIndex));\n    const periodCycles = NOISE_PERIOD_TABLE[periodIndex];\n    const periodSeconds = (periodCycles * 16) / CHIP_BASE_CLOCK;\n    const periodSamples = Math.max(1, Math.round(periodSeconds * this.sampleRate));\n    const decaySeconds = Math.max(0.001, data.decaySeconds ?? 0.12);\n    const releaseSeconds = Math.max(0.001, data.releaseSeconds ?? 0.03);\n    const decaySamples = Math.max(1, Math.round(decaySeconds * this.sampleRate));\n    const releaseSamples = Math.max(1, Math.round(releaseSeconds * this.sampleRate));\n    const amplitude = Math.max(0, Math.min(1, data.amplitude ?? 0.6));\n    const mode = data.mode === \"long\" ? \"long\" : \"short\";\n    const cutoffHz = Math.max(100, Math.min(this.sampleRate / 2, data.cutoffHz ?? 6000));\n\n    this.periodIndex = periodIndex;\n    this.mode = mode;\n\n    this.scheduleMessage(\n      {\n        type: \"noteOn\",\n        mode,\n        amplitude,\n        periodSamples,\n        decaySamples,\n        releaseSamples,\n        cutoffHz\n      },\n      when\n    );\n  }\n\n  noteOff(data: Record<string, unknown>, when: number): void {\n    const releaseSeconds = Math.max(0.001, Number(data?.releaseSeconds ?? 0.03));\n    const releaseSamples = Math.max(1, Math.round(releaseSeconds * this.sampleRate));\n    this.scheduleMessage({ type: \"noteOff\", releaseSamples }, when);\n  }\n\n  setParam(data: Record<string, unknown>, when: number): void {\n    if (!data || !data.param) {\n      return;\n    }\n    if (data.param === \"mode\" && typeof data.value === \"string\") {\n      this.mode = data.value === \"long\" ? \"long\" : \"short\";\n    }\n    if (data.param === \"periodIndex\") {\n      const index = Number(data.value ?? this.periodIndex);\n      this.periodIndex = Math.max(0, Math.min(NOISE_PERIOD_TABLE.length - 1, index));\n    }\n    this.scheduleMessage({ type: \"setParam\", param: data.param, value: data.value }, when);\n  }\n}\n\n/** All four chiptune channels */\ntype ChannelInstances = {\n  square1: SquareChannel;\n  square2: SquareChannel;\n  triangle: TriangleChannel;\n  noise: NoiseChannel;\n};\n\n// ============================================================================\n// Main Synthesizer Class\n// ============================================================================\n\n/**\n * AlgoChip chiptune synthesizer.\n *\n * Orchestrates all four audio channels, handles event scheduling with\n * precise timing, supports looping playback, and provides real-time\n * event callbacks for visualization.\n *\n * Usage:\n * ```typescript\n * const synth = new AlgoChipSynthesizer(audioContext);\n * await synth.init();\n * await synth.play(events, { loop: true, onEvent: handleEvent });\n * ```\n */\nexport class AlgoChipSynthesizer {\n  private static readonly BASE_GAIN = 0.16;  // Default master gain value\n  private readonly masterGainNode: GainNode;\n  private readonly workletBasePath: string;\n  private channels!: ChannelInstances;\n  private events: PlaybackEvent[] = [];\n  private eventIndex = 0;\n  private lookahead = LOOKAHEAD_SECONDS;\n  private leadTime = LEAD_TIME;\n  private intervalHandle: number | null = null;\n  private startTime = 0;\n  private lastEventTime = 0;\n  private completionResolver: (() => void) | null = null;\n  private loopEnabled = false;\n  private eventCallback: ((event: PlaybackEvent, when: number) => void) | null = null;\n\n  constructor(\n    private readonly context: AudioContext,\n    options: { workletBasePath?: string } = {}\n  ) {\n    this.masterGainNode = context.createGain();\n    this.masterGainNode.gain.value = AlgoChipSynthesizer.BASE_GAIN;\n    this.masterGainNode.connect(context.destination);\n    this.workletBasePath = options.workletBasePath ?? \"./worklets/\";\n  }\n\n  /**\n   * Initializes the synthesizer by loading AudioWorklet processors.\n   *\n   * Must be called once before playback. Loads the square, triangle,\n   * and noise processor modules and creates channel instances.\n   */\n  async init(): Promise<void> {\n    const ctx = this.context;\n    const basePath = this.workletBasePath;\n    await ctx.audioWorklet.addModule(`${basePath}square-processor.js`);\n    await ctx.audioWorklet.addModule(`${basePath}triangle-processor.js`);\n    await ctx.audioWorklet.addModule(`${basePath}noise-processor.js`);\n\n    this.channels = {\n      square1: new SquareChannel(ctx, this.masterGainNode),\n      square2: new SquareChannel(ctx, this.masterGainNode),\n      triangle: new TriangleChannel(ctx, this.masterGainNode),\n      noise: new NoiseChannel(ctx, this.masterGainNode)\n    };\n  }\n\n  /** Returns the master gain node for external ducking/mixing control */\n  get masterGain(): GainNode {\n    return this.masterGainNode;\n  }\n\n  /**\n   * Stops playback and clears all scheduled events.\n   *\n   * Stops the scheduling loop, clears all channel queues, and resolves\n   * the playback promise.\n   */\n  stop(): void {\n    if (this.intervalHandle !== null) {\n      clearInterval(this.intervalHandle);\n      this.intervalHandle = null;\n    }\n    Object.values(this.channels).forEach((channel) => channel.stop());\n    if (this.completionResolver) {\n      this.completionResolver();\n      this.completionResolver = null;\n    }\n  }\n\n  /**\n   * Starts playback of the given event list.\n   *\n   * Schedules events with lookahead buffering for glitch-free playback.\n   * Supports looping and event callbacks for real-time visualization.\n   *\n   * @param events List of playback events to schedule\n   * @param options Playback configuration (startTime, loop, callbacks)\n   * @returns Promise that resolves when playback completes (never resolves if looping)\n   */\n  play(events: PlaybackEvent[], options: SynthPlayOptions = {}): Promise<void> {\n    this.stop();\n    this.events = events ?? [];\n    this.lookahead = options.lookahead ?? LOOKAHEAD_SECONDS;\n    this.leadTime = options.leadTime ?? LEAD_TIME;\n    this.loopEnabled = options.loop ?? false;\n    this.eventCallback = options.onEvent ?? null;\n\n    // Apply volume multiplier (default: 1.0)\n    const volume = options.volume ?? 1.0;\n    this.masterGainNode.gain.value = AlgoChipSynthesizer.BASE_GAIN * volume;\n\n    const totalDuration = this.events.length ? this.events[this.events.length - 1]!.time : 0;\n    let offset = Math.max(0, options.offset ?? 0);\n    if (offset > 0) {\n      if (this.loopEnabled && totalDuration > 0) {\n        offset = offset % totalDuration;\n      } else {\n        offset = Math.min(offset, totalDuration);\n      }\n    }\n\n    const contextStart = this.context.currentTime;\n    const baseStart = options.startTime ?? contextStart + this.leadTime;\n    this.startTime = baseStart - offset;\n    this.lastEventTime = totalDuration;\n    this.eventIndex = this.resolveEventIndex(offset);\n\n    const promise = new Promise<void>((resolve) => {\n      this.completionResolver = resolve;\n    });\n\n    const scheduleStep = () => this.tick();\n    this.intervalHandle = window.setInterval(scheduleStep, SCHEDULE_INTERVAL_MS);\n    scheduleStep();\n    return promise;\n  }\n\n  /** Determines the event index that should be scheduled after applying an offset */\n  private resolveEventIndex(offset: number): number {\n    if (offset <= 0) {\n      return 0;\n    }\n    const tolerance = 1e-3;\n    for (let i = 0; i < this.events.length; i += 1) {\n      const event = this.events[i]!;\n      if (event.time + tolerance >= offset) {\n        return i;\n      }\n    }\n    return this.events.length;\n  }\n\n  /**\n   * Scheduling tick function (called periodically).\n   *\n   * Checks for events within the lookahead window and dispatches them\n   * to appropriate channels. Handles looping by resetting event index.\n   */\n  private tick(): void {\n    const ctxTime = this.context.currentTime;\n    const cutoff = ctxTime + this.lookahead;\n\n    while (this.eventIndex < this.events.length) {\n      const event = this.events[this.eventIndex]!;\n      const eventTime = this.startTime + event.time;\n      if (eventTime <= cutoff) {\n        this.dispatchEvent(event, eventTime);\n        this.eventIndex += 1;\n      } else {\n        break;\n      }\n    }\n\n    if (this.loopEnabled && this.eventIndex >= this.events.length) {\n      this.startTime += this.lastEventTime;\n      this.eventIndex = 0;\n    }\n\n    if (!this.loopEnabled) {\n      const completionTime = this.startTime + this.lastEventTime + 1;\n      if (this.eventIndex >= this.events.length && ctxTime >= completionTime) {\n        this.stop();\n      }\n    }\n  }\n\n  /**\n   * Dispatches a single event to the appropriate channel.\n   *\n   * Routes noteOn, noteOff, and setParam commands to the correct channel\n   * (square1/2, triangle, or noise) and invokes the event callback if registered.\n   *\n   * @param event Playback event to dispatch\n   * @param when Absolute time to schedule the event\n   */\n  private dispatchEvent(event: PlaybackEvent, when: number): void {\n    const data = event.data ?? {};\n\n    // Notify callback if registered\n    if (this.eventCallback) {\n      this.eventCallback(event, when);\n    }\n\n    switch (event.channel) {\n      case \"square1\":\n      case \"square2\":\n        if (event.command === \"noteOn\") {\n          this.channels[event.channel].noteOn(this.mapPitchData(data), when);\n        } else if (event.command === \"noteOff\") {\n          this.channels[event.channel].noteOff(data, when);\n        } else if (event.command === \"setParam\") {\n          this.channels[event.channel].setParam(data, when);\n        }\n        break;\n      case \"triangle\":\n        if (event.command === \"noteOn\") {\n          this.channels.triangle.noteOn(this.mapPitchData(data), when);\n        } else if (event.command === \"noteOff\") {\n          this.channels.triangle.noteOff(data, when);\n        } else if (event.command === \"setParam\") {\n          this.channels.triangle.setParam(data, when);\n        }\n        break;\n      case \"noise\":\n        if (event.command === \"noteOn\") {\n          this.channels.noise.noteOn(this.mapNoiseData(data), when);\n        } else if (event.command === \"noteOff\") {\n          this.channels.noise.noteOff(data, when);\n        } else if (event.command === \"setParam\") {\n          this.channels.noise.setParam(data, when);\n        }\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * Maps event data to PitchData for square/triangle channels.\n   *\n   * Converts MIDI note numbers to frequencies, applies velocity scaling,\n   * and extracts pitch slide parameters if present.\n   *\n   * @param data Event data object\n   * @returns Formatted pitch data for channel noteOn\n   */\n  private mapPitchData(data: Record<string, unknown>): PitchData {\n    const midi = Number(data.midi ?? 60);\n    const detuneCents = Number(data.detuneCents ?? 0);\n    let slide: PitchSlide | null = null;\n    const slideData = data.slide as Record<string, unknown> | undefined;\n    if (slideData) {\n      if (typeof slideData.targetMidi === \"number\") {\n        slide = {\n          targetFrequency: midiToFrequency(slideData.targetMidi),\n          durationSeconds: Number(slideData.durationSeconds ?? 0)\n        };\n      } else if (typeof slideData.targetFrequency === \"number\") {\n        slide = {\n          targetFrequency: slideData.targetFrequency,\n          durationSeconds: Number(slideData.durationSeconds ?? 0)\n        };\n      }\n    }\n\n    return {\n      frequency: midiToFrequency(midi),\n      amplitude: velocityToGain(typeof data.velocity === \"number\" ? data.velocity : undefined),\n      duty: typeof data.duty === \"number\" ? data.duty : undefined,\n      detuneCents,\n      slide\n    };\n  }\n\n  /**\n   * Maps event data to NoiseData for the noise channel.\n   *\n   * Applies instrument presets (K/S/H/O/T), scales amplitude by velocity,\n   * and extracts envelope/filter parameters.\n   *\n   * @param data Event data object\n   * @returns Formatted noise data for channel noteOn\n   */\n  private mapNoiseData(data: Record<string, unknown>): NoiseData {\n    const velocity = typeof data.velocity === \"number\" ? data.velocity : 100;\n    const velocityGain = Math.max(0, Math.min(1, velocity / 127));\n    const instrument = (typeof data.instrument === \"string\" ? data.instrument : \"S\") as NoiseInstrument;\n    const preset = NOISE_PRESETS[instrument] ?? NOISE_PRESETS.default;\n    const amplitude = Math.min(1, Math.max(0, (typeof data.amplitude === \"number\" ? data.amplitude : preset.baseAmplitude) * velocityGain));\n    const decaySeconds = typeof data.decaySeconds === \"number\" ? data.decaySeconds : preset.decaySeconds;\n    const releaseSeconds = typeof data.releaseSeconds === \"number\" ? data.releaseSeconds : preset.releaseSeconds;\n    const periodIndex = typeof data.periodIndex === \"number\" ? data.periodIndex : typeof data.clockDivider === \"number\" ? data.clockDivider : typeof data.period === \"number\" ? data.period : preset.periodIndex;\n    const mode = (typeof data.mode === \"string\" ? data.mode : typeof data.noiseMode === \"string\" ? data.noiseMode : preset.mode) as \"short\" | \"long\";\n    const cutoffHz = typeof data.cutoffHz === \"number\" ? data.cutoffHz : preset.cutoffHz;\n\n    return {\n      amplitude,\n      decaySeconds,\n      releaseSeconds,\n      periodIndex,\n      mode,\n      cutoffHz\n    };\n  }\n}\n"],"names":["chords","TEMPO_BASE","MOOD_TAG_MAP","DEFAULT_KEY_PER_MOOD","AVAILABLE_CHORD_KEYS","SCALE_DEGREES","SECTION_TEMPLATE_POOL","TEMPLATE_INDEX_BY_MOOD","SECTION_TEMPLATES_BY_LENGTH","HOOK_TEMPLATES","DEFAULT_TEXTURE","DEFAULT_PHRASE_LENGTH","STYLE_INTENT_BASE","STYLE_PRESET_MAP","createStyleIntent","mergeStyleIntent","base","patch","merged","key","precomputeStyleIntent","options","intent","presetPatch","resolveStyleIntent","sections","totalMeasures","sum","section","sectionTemplateCounts","acc","hasRepeatedTemplate","count","averageSectionLength","uniqueChords","distinctProgressions","sectionsWithSingleChord","chord","allSectionsStatic","inferredHarmonicStatic","wasExplicitlyProvided","randomFromSeed","seed","salt","selectChordProgressions","moodTags","keyData","matches","tag","fallbackSources","shuffleArray","progression","transposeChord","semitones","rootMatch","rootNote","accidental","suffix","NOTE_ORDER","NOTE_TO_INDEX","currentNote","currentIndex","newIndex","toggleMinorMajor","match","root","minor","rest","getRelatedChords","baseChord","related","buildLimitedProgression","rng","repetitions","relatedChords","chosenRelated","buildSections","chordsPool","precomputedIntent","targetMeasures","baseTemplate","s","pickTemplateForMood","totalTemplateMeasures","repeatedTemplate","loops","i","remaining","idx","templateSection","clamp","consumed","measureCursor","chordIndex","randomizedProgressions","occurrenceCounter","chordVariety","localSeed","state","useHarmonicStatic","useSingleChord","templateId","occurrenceIndex","texture","resolveTexture","TEMPLATE_TEXTURE_SEQUENCE","TEMPLATE_PHRASE_LENGTH","ARPEGGIO_KEEP_PROBABILITY","TEXTURE_VARIATION_PROBABILITY","sequence","plannedTexture","isFirstOccurrence","seedSalt","char","roll","keepProbability","candidate","variationSalt","alternatives","t","index","resolvePhraseLength","getPhraseLengthForSection","establishesHook","repriseHook","deriveTechniqueStrategy","mood","styleIntent","styled","applyStyleIntentToTechnique","jitterTechnique","value","jitter","offsetSalt","result","VOICE_ARRANGEMENTS","ARRANGEMENT_WEIGHTS_BY_STYLE","DEFAULT_ARRANGEMENT_WEIGHTS","selectVoiceArrangement","stylePreset","weights","entries","totalWeight","w","rand","cumulative","preset","weight","planStructure","baseBpm","bpmOffset","bpm","resolveKey","scaleDegrees","techniqueStrategy","validateSectionLength","voiceArrangement","candidates","_","segment","items","copy","randomIndex","temp","preferred","fallbackIndex","target","DRUM_DURATION_BEATS","NOTE_TO_SEMITONE","DEFAULT_CHORD_INTERVALS","BEATS_PER_MEASURE","chordRootToMidi","baseOctaveMidi","noteMatch","note","semitone","getChordIntervals","scaleDegreeToMidi","degree","scale","baseMidi","octaveOffset","octave","semitoneOffset","generateDrumHitsFromPattern","pattern","startBeat","sectionId","hits","symbol","stepBeat","resolveChordAtBeat","phase1","beatTime","beatsPerMeasure","measureIndex","fallback","relativeMeasure","frequencyToSemitones","ratio","midiToFrequency","midi","mod12","quantizeMidiToChord","intervals","best","bestDiff","interval","diff","CONSONANT_INTERVALS","ensureConsonantPitch","referenceMidi","bestScore","intervalClass","intervalPenalty","proximityPenalty","spreadPenalty","score","VELOCITY_GLOBAL","VELOCITY_CHANNEL_SCALE","VELOCITY_PITCH_THRESHOLD","VELOCITY_BASS_TEXTURE","VELOCITY_BASS_ACCENT","VELOCITY_MELODY","VELOCITY_ACCOMPANIMENT","VELOCITY_TECHNIQUE","VELOCITY_NOISE","rhythmMotifs","rhythmMotifsJson","melodyFragments","melodyFragmentsJson","melodyRhythms","melodyRhythmsJson","drumPatterns","drumPatternsJson","bassPatternLibrary","bassPatternsJson","transitionPatternLibrary","transitionsJson","rhythmList","melodyList","melodyById","fragment","melodyRhythmList","melodyRhythmById","motif","drumList","drumById","bassPatternsByTexture","list","transitionList","DEFAULT_BASS_STEPS","FALLBACK_BASS_PATTERN","RHYTHM_PROPERTY_TAGS","MELODY_MOOD_TAGS","MELODY_RHYTHM_TAGS","rhythmById","ARRANGEMENT_DRUM_RULES","ARRANGEMENT_ACCOMP_RULES","preferTagPresence","tags","minRatio","matched","sourceTags","shuffleWithRng","j","biasByTagPresence","targetRatio","others","shuffledMatches","shuffledOthers","desiredMatchCount","prioritizedMatches","remainder","RNG_SEED","createRng","pickWithAvoid","avoidId","choice","attempts","hasAllTags","source","isStrongBeat","beat","findMelodyReference","melody","functionalTagForMeasure","measure","isRhythmMotifConsistent","expandRhythmPattern","selectRhythmMotif","functionTag","last","requiredTags","used","safeRhythms","propertyTags","filterByTags","requiredPool","propertyFiltered","requiredFiltered","_a","variationCandidates","id","variationPool","preferUnused","pool","selectMelodyFragment","lastFragment","globalFallback","selectMelodyRhythmMotif","totalBeats","lastId","filtered","moodFiltered","filterHumanizedMelodyRhythms","resolveMelodyVelocity","measureInSection","globalMeasureIndex","downbeatBoost","cadenceLift","globalProgress","clamped","exponent","shaped","maxBoost","buildAmount","resolveBaseRegisterForComposition","tempo","moodBaseOffsets","tempoOffsets","presetOffsets","intentAdjustments","moodOffset","tempoOffset","presetOffset","randomVariation","baseRegister","resolveMelodyRegister","compositionBaseRegister","textureOffsets","clampedMeasure","offset","occurrenceDrop","MIN_REGISTER","MAX_REGISTER","resolved","maybeAddPickupNote","measureStartBeat","baseMelody","pickupStart","resolveTailDegreeVariant","baseDegree","melodyPattern","tailDegrees","neighbor","fall","ordered","pickRhythmVariation","variationIds","variations","buildBassPattern","nextChord","steps","notes","nextChordName","step","bassStepToMidi","resolveBassVelocity","resolveBassPattern","cache","enforceDroneStatic","preferredTags","isFinalMeasure","cached","endPattern","selectBassPattern","preferredPattern","dronePattern","initialTags","basePattern","tagged","mergeTransitionHits","existingHits","transitionHits","hit","adjustedBeat","maxAttempts","existing","maybeGenerateTransition","isLastSection","lastTransitionId","progress","priorityTags","nextRoot","convertToBeats","total","resolveAccompanimentDegree","degreeIndex","beatInMeasure","chordDegrees","resolveAccompanimentVelocity","buildAccompanimentSeeds","rhythmMotif","arrangementId","seeds","expandedPattern","beatCursor","arrangementRule","patternIndex","remainingBeats","actualDuration","isOffbeat","noteVelocity","collapsedDegree","collapsedVelocity","expandMelodyRhythmPattern","entry","motifPassesHumanization","restRequirement","accumulatedRest","hasLongNote","continuousShortBeats","duration","getOrCreateTemplateCache","templateCache","cacheKey","templateMap","getHookForOccurrence","hookCache","occurrenceMap","setHookForOccurrence","hook","initializeMotifContext","compositionSeed","processSectionPhrases","context","results","phraseLength","phraseMeasures","isFirstPhrase","phraseStartMeasureIndex","phraseContext","createPhraseContext","processSinglePhrase","cachedHook","baseFunctionTag","baseRequiredTags","baseRhythm","baseMelodyRhythm","rhythmKey","hookRhythm","hookMelody","cachedRhythmId","cachedMelodyId","hookMelodyRhythm","cachedMelodyRhythmId","expandedMelodyRhythm","phraseBeatCursor","phraseStepIndex","melodyDegreeCursor","phraseOffset","measureContext","createMeasureContext","generateMelodyForMeasure","measureBeatLimit","generateBassForMeasure","generateAccompanimentForMeasure","generateDrumsForMeasure","isHookMeasure","measureKey","measureCache","repeatBias","shouldVaryByPosition","preferVariation","variation","melodyOutput","cursors","localStart","velocity","bassOutput","bassPattern","currentChord","accompanimentOutput","drumsOutput","isSectionFinalMeasure","shouldForceFill","drumKey","drumCache","drumPattern","selectDrumPattern","transitionResult","convertMelodyToMidi","convertAccompanimentToMidi","accompanimentSeeds","melodyMidi","reference","convertBassToMidi","bass","selectMotifsLegacy","bassMidi","accompanimentMidi","selectMotifs","baseSeed","legacy","tracks","voice","abstractNotes","generateBassTrackForVoice","generatePadTrackForVoice","midiNotes","lastPatternId","forceFill","earlyThreshold","midThreshold","fillEvery","cycleFill","isFill","fitsMeasure","prefersBreakbeatFocus","prefersLofiGroove","prefersRetroPulse","_b","_c","unused","createVoiceRng","seedOffset","effectiveSeed","shouldGenerateForVoice","priority","adjustedPriority","buildBassPatternWithBaseMidi","role","bassNotes","voiceRng","usedBassPatterns","bassPatternCache","baseBassMidi","sectionStartBeat","patternNotes","padNotes","NOISE_MAX_DURATION_BEATS","NOISE_MIN_RELEASE_SECONDS","NOISE_MAX_RELEASE_SECONDS","NOISE_STACK_OFFSET","NOISE_MODE_CONFIG","PORTAMENTO_MAX_INTERVAL","PORTAMENTO_DURATION_SECONDS","adjustVelocityForChannel","channel","isBassRole","isSquare","scaled","resolveArpeggioProfile","profile","shouldApplyPortamento","next","noteDuration","gap","eligibleInterval","consecutive","sufficientDuration","probability","computePortamentoDurationSeconds","baseDuration","allowsNoiseStacking","previousInstrument","currentInstrument","combo","resolveNoiseRelease","config","range","deriveArpeggioPattern","chordIntervals","cycle","baseInterval","maybeReversePattern","buildFastArpeggioNotes","baseVelocity","sustainedMidi","densityRoll","subdivisions","stepDuration","offsetBeat","buildBrokenChordNotes","offsets","buildSteadyChordNotes","createRealizationContext","phase2","realizeMelodyTrack","track","voiceConfig","events","sectionMeta","payload","pushNote","realizeBassTrack","realizeAccompanimentTrack","seedsByMeasure","bucket","sortedMeasures","a","b","processedNotes","echoNotes","detuneNotes","allNotes","melodyTrack","findMelodyOverlap","realizeDrumEvents","drums","noiseEvents","lastNoiseOffBeat","lastNoiseOnBeat","lastNoiseInstrument","sortedDrums","adjustedStart","canStack","stackOffset","releaseSec","decaySec","clampedDuration","lastOffEvent","offBeat","realizeTrack","realizeEvents","v","trackEvents","drumEvents","diagnostics","computeVoiceAllocation","durationBeats","data","noteOffData","endBeat","channelCounts","event","current","techniqueLibrary","GRADUAL_BUILD_GAIN_RAMP","applyTechniques","phase3","additionalEvents","totalTrackBeats","max","dutySweeps","gainProfiles","breakMeasures","offEvent","findMatchingNoteOff","sweep","isMeasureBoundary","stepSpacing","squareChannel","measureStep","ramp","typedChannel","onEvent","matchingOff","minTimeDiff","timeDiff","finalizeTimeline","techniquesEvents","eventDiagnostics","motifUsage","sectionMotifPlan","beatToSecond","computeLoopWindow","wrapWindow","lastTime","tail","validateTwoAxisStyle","axis","mapTwoAxisToStyleIntent","percussiveMelodic","calmEnergetic","percussiveStrength","melodicStrength","calmStrength","energyStrength","deriveTwoAxisTempo","inferTagsFromAxis","energy","PRESET_TO_TWO_AXIS","INTENT_KEYS","DEFAULT_INTENT","PRESET_SLUG_TO_ENUM","PRESET_MATCH_THRESHOLD","DEFAULT_AXIS","seedRandom","ensureIntent","partial","randomize","provided","mergeProfile","inferPresetFromAxis","bestKey","bestDistance","slug","presetAxis","distance","resolveGenerationContext","resolvedLength","resolvedSeed","axisInput","inferredTags","shouldRandomizeIntent","finalizedIntent","pipelineOptions","resolvedProfile","replayOptions","runPipeline","pipeline","resolveOptions","structurePlan","motifSelection","eventRealization","techniquesApplied","finalTimeline","totalDuration","generateComposition","loadSETemplates","seTemplatesJson","SEGenerator","template","params","baseFrequency","minDur","maxDur","channelParams","pitchShift","ch","tplParams","baseVelocityRange","sampledVelocity","sampledPitchStart","sampledPitchEnd","sweepCurveOptions","opt","random","startTime","chParams","channelEvents","globalParams","releaseSeconds","noiseData","currentTime","basePitch","pitch","noteDur","sweepDuration","curve","referenceFreq","frequencyRatio","shiftSemitones","LOOKAHEAD_SECONDS","SCHEDULE_INTERVAL_MS","LEAD_TIME","CHIP_BASE_CLOCK","NOISE_PERIOD_TABLE","NOISE_PRESETS","MIDI_A4","FREQ_A4","velocityToGain","BaseChannel","processorName","masterGain","node","message","when","sampleFrame","SquareChannel","detuneCents","detuneRatio","targetFrequency","rampDuration","TriangleChannel","NoiseChannel","periodIndex","periodSeconds","periodSamples","decaySeconds","decaySamples","releaseSamples","amplitude","mode","cutoffHz","_AlgoChipSynthesizer","ctx","basePath","volume","contextStart","baseStart","promise","resolve","scheduleStep","tolerance","ctxTime","cutoff","eventTime","completionTime","slide","slideData","velocityGain","instrument","AlgoChipSynthesizer"],"mappings":"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"}